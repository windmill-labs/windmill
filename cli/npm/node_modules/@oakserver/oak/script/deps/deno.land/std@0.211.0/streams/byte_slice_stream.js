"use strict";
var _ByteSliceStream_offsetStart, _ByteSliceStream_offsetEnd;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ByteSliceStream = void 0;
const tslib_1 = require("tslib");
// Copyright 2018-2024 the Deno authors. All rights reserved. MIT license.
// This module is browser compatible.
const dntShim = tslib_1.__importStar(require("../../../../_dnt.shims.js"));
const assert_js_1 = require("../assert/assert.js");
/**
 * A transform stream that only transforms from the zero-indexed `start` and
 * `end` bytes (both inclusive).
 *
 * @example
 * ```ts
 * import { ByteSliceStream } from "https://deno.land/std@$STD_VERSION/streams/byte_slice_stream.ts";
 *
 * const response = await fetch("https://example.com");
 * const rangedStream = response.body!
 *   .pipeThrough(new ByteSliceStream(3, 8));
 * ```
 */
class ByteSliceStream extends dntShim.TransformStream {
    /** Constructs a new instance. */
    constructor(start = 0, end = Infinity) {
        super({
            start: () => {
                (0, assert_js_1.assert)(start >= 0, "`start` must be greater than 0");
                end += 1;
            },
            transform: (chunk, controller) => {
                tslib_1.__classPrivateFieldSet(this, _ByteSliceStream_offsetStart, tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetEnd, "f"), "f");
                tslib_1.__classPrivateFieldSet(this, _ByteSliceStream_offsetEnd, tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetEnd, "f") + chunk.byteLength, "f");
                if (tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetEnd, "f") > start) {
                    if (tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetStart, "f") < start) {
                        chunk = chunk.slice(start - tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetStart, "f"));
                    }
                    if (tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetEnd, "f") >= end) {
                        chunk = chunk.slice(0, chunk.byteLength - tslib_1.__classPrivateFieldGet(this, _ByteSliceStream_offsetEnd, "f") + end);
                        controller.enqueue(chunk);
                        controller.terminate();
                    }
                    else {
                        controller.enqueue(chunk);
                    }
                }
            },
        });
        _ByteSliceStream_offsetStart.set(this, 0);
        _ByteSliceStream_offsetEnd.set(this, 0);
    }
}
exports.ByteSliceStream = ByteSliceStream;
_ByteSliceStream_offsetStart = new WeakMap(), _ByteSliceStream_offsetEnd = new WeakMap();
