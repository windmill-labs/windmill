"use strict";
var _TextDelimiterStream_instances, _TextDelimiterStream_buf, _TextDelimiterStream_delimiter, _TextDelimiterStream_inspectIndex, _TextDelimiterStream_matchIndex, _TextDelimiterStream_delimLPS, _TextDelimiterStream_disp, _TextDelimiterStream_handle;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TextDelimiterStream = void 0;
const tslib_1 = require("tslib");
// Copyright 2018-2024 the Deno authors. All rights reserved. MIT license.
// This module is browser compatible.
const dntShim = tslib_1.__importStar(require("../../../../_dnt.shims.js"));
const _common_js_1 = require("./_common.js");
/**
 * Transform a stream into a stream where each chunk is divided by a given delimiter.
 *
 * @example
 * ```ts
 * import { TextDelimiterStream } from "https://deno.land/std@$STD_VERSION/streams/text_delimiter_stream.ts";
 * const res = await fetch("https://example.com");
 * const parts = res.body!
 *   .pipeThrough(new TextDecoderStream())
 *   .pipeThrough(new TextDelimiterStream("foo"));
 * ```
 */
class TextDelimiterStream extends dntShim.TransformStream {
    /** Constructs a new instance. */
    constructor(delimiter, options) {
        super({
            transform: (chunk, controller) => {
                tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_instances, "m", _TextDelimiterStream_handle).call(this, chunk, controller);
            },
            flush: (controller) => {
                controller.enqueue(tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_buf, "f"));
            },
        });
        _TextDelimiterStream_instances.add(this);
        _TextDelimiterStream_buf.set(this, "");
        _TextDelimiterStream_delimiter.set(this, void 0);
        _TextDelimiterStream_inspectIndex.set(this, 0);
        _TextDelimiterStream_matchIndex.set(this, 0);
        _TextDelimiterStream_delimLPS.set(this, void 0);
        _TextDelimiterStream_disp.set(this, void 0);
        tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_delimiter, delimiter, "f");
        tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_delimLPS, (0, _common_js_1.createLPS)(new TextEncoder().encode(delimiter)), "f");
        tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_disp, options?.disposition ?? "discard", "f");
    }
}
exports.TextDelimiterStream = TextDelimiterStream;
_TextDelimiterStream_buf = new WeakMap(), _TextDelimiterStream_delimiter = new WeakMap(), _TextDelimiterStream_inspectIndex = new WeakMap(), _TextDelimiterStream_matchIndex = new WeakMap(), _TextDelimiterStream_delimLPS = new WeakMap(), _TextDelimiterStream_disp = new WeakMap(), _TextDelimiterStream_instances = new WeakSet(), _TextDelimiterStream_handle = function _TextDelimiterStream_handle(chunk, controller) {
    var _a, _b, _c;
    tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_buf, tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_buf, "f") + chunk, "f");
    let localIndex = 0;
    while (tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f") < tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_buf, "f").length) {
        if (chunk[localIndex] === tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_delimiter, "f")[tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_matchIndex, "f")]) {
            tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_inspectIndex, (_a = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f"), _a++, _a), "f");
            localIndex++;
            tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_matchIndex, (_b = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_matchIndex, "f"), _b++, _b), "f");
            if (tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_matchIndex, "f") === tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_delimiter, "f").length) {
                // Full match
                const start = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f") - tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_delimiter, "f").length;
                const end = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_disp, "f") === "suffix" ? tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f") : start;
                const copy = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_buf, "f").slice(0, end);
                controller.enqueue(copy);
                const shift = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_disp, "f") === "prefix" ? start : tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f");
                tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_buf, tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_buf, "f").slice(shift), "f");
                tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_inspectIndex, tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_disp, "f") === "prefix"
                    ? tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_delimiter, "f").length
                    : 0, "f");
                tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_matchIndex, 0, "f");
            }
        }
        else {
            if (tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_matchIndex, "f") === 0) {
                tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_inspectIndex, (_c = tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_inspectIndex, "f"), _c++, _c), "f");
                localIndex++;
            }
            else {
                tslib_1.__classPrivateFieldSet(this, _TextDelimiterStream_matchIndex, tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_delimLPS, "f")[tslib_1.__classPrivateFieldGet(this, _TextDelimiterStream_matchIndex, "f") - 1], "f");
            }
        }
    }
};
