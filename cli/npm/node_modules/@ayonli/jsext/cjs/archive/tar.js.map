{"version":3,"file":"tar.js","sources":["../../archive/tar.ts"],"sourcesContent":["import { createReadableStream, stat, readDir, createWritableStream } from \"../fs.ts\";\nimport { basename, join, resolve } from \"../path.ts\";\nimport Tarball from \"./Tarball.ts\";\nexport default async function tar(src, dest = {}, options = {}) {\n    var _a, _b;\n    let _dest = undefined;\n    if (typeof dest === \"string\") {\n        _dest = options.root ? dest : resolve(dest);\n    }\n    else if (typeof dest === \"object\") {\n        if (typeof FileSystemFileHandle === \"function\" && dest instanceof FileSystemFileHandle) {\n            _dest = dest;\n        }\n        else {\n            options = dest;\n        }\n    }\n    src = typeof src === \"string\" && !options.root ? resolve(src) : src;\n    const { signal } = options;\n    const baseDir = typeof src === \"string\" ? basename(src) : src.name;\n    const entries = readDir(src, { ...options, recursive: true });\n    const tarball = new Tarball();\n    for await (const entry of entries) {\n        let filename;\n        let info;\n        let stream = null;\n        if (entry.handle) {\n            filename = entry.relativePath;\n            info = await stat(entry.handle);\n        }\n        else if (typeof src === \"string\") {\n            filename = join(src, entry.relativePath);\n            info = await stat(filename, options);\n        }\n        else {\n            filename = entry.relativePath;\n            info = await stat(entry.relativePath, options);\n        }\n        if (info.kind !== \"directory\") {\n            stream = createReadableStream((_a = entry.handle) !== null && _a !== void 0 ? _a : filename, options);\n            signal === null || signal === void 0 ? void 0 : signal.addEventListener(\"abort\", () => {\n                stream.cancel(signal.reason).catch(() => { });\n            }, { once: true });\n        }\n        let kind;\n        if (info.kind === \"directory\") {\n            kind = \"directory\";\n        }\n        else if (info.kind === \"symlink\") {\n            kind = \"symlink\";\n        }\n        else if (info.isBlockDevice) {\n            kind = \"block-device\";\n        }\n        else if (info.isCharDevice) {\n            kind = \"character-device\";\n        }\n        else if (info.isFIFO || info.isSocket) {\n            kind = \"fifo\";\n        }\n        else {\n            kind = \"file\";\n        }\n        tarball.append(stream, {\n            name: entry.name,\n            kind,\n            relativePath: baseDir ? baseDir + \"/\" + entry.relativePath : entry.relativePath,\n            size: entry.kind === \"directory\" ? 0 : info.size,\n            mtime: (_b = info.mtime) !== null && _b !== void 0 ? _b : new Date(),\n            mode: info.mode,\n            uid: info.uid,\n            gid: info.gid,\n        });\n    }\n    if (!_dest) {\n        return tarball;\n    }\n    const output = createWritableStream(_dest, options);\n    const stream = tarball.stream(options);\n    signal === null || signal === void 0 ? void 0 : signal.addEventListener(\"abort\", () => {\n        output.abort(signal.reason).catch(() => { });\n    }, { once: true });\n    await stream.pipeTo(output);\n}\n//# sourceMappingURL=tar.js.map"],"names":["resolve","basename","readDir","Tarball","stat","join","createReadableStream","createWritableStream"],"mappings":"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"}