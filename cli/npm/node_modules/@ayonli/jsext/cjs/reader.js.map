{"version":3,"file":"reader.js","sources":["../reader.ts"],"sourcesContent":["/**\n * Utility functions for reading data from various types of source into various\n * forms.\n * @module\n */\nimport { concat as concatBytes, text } from \"./bytes.ts\";\nimport { asAsyncIterable, toAsyncIterable, resolveByteStream, resolveReadableStream, } from \"./reader/util.ts\";\nexport { toAsyncIterable, resolveByteStream };\nexport function toReadableStream(source, eventMap = undefined) {\n    if (source instanceof ReadableStream) {\n        return source;\n    }\n    else if (typeof source[\"then\"] === \"function\") {\n        return resolveReadableStream(source);\n    }\n    const iterable = toAsyncIterable(source, eventMap);\n    const iterator = iterable[Symbol.asyncIterator]();\n    return new ReadableStream({\n        async pull(controller) {\n            const { done, value } = await iterator.next();\n            if (done) {\n                controller.close();\n            }\n            else {\n                controller.enqueue(value);\n            }\n        },\n        cancel(reason = undefined) {\n            var _a;\n            (_a = iterator.throw) === null || _a === void 0 ? void 0 : _a.call(iterator, reason);\n        }\n    });\n}\n/**\n * Reads all data from the iterable object or readable stream to an array.\n *\n * @example\n * ```ts\n * import { readAsArray } from \"@ayonli/jsext/reader\";\n * import * as fs from \"node:fs\";\n *\n * const file = fs.createReadStream(\"./package.json\");\n * const chunks = await readAsArray(file);\n *\n * console.log(chunks);\n * ```\n */\nexport async function readAsArray(source) {\n    const iterable = asAsyncIterable(source);\n    const list = [];\n    for await (const chunk of iterable) {\n        list.push(chunk);\n    }\n    return list;\n}\n/**\n * Reads all data from the given source to an `ArrayBuffer`.\n *\n * @example\n * ```ts\n * import { readAsArrayBuffer } from \"@ayonli/jsext/reader\";\n * import { createReadableStream } from \"@ayonli/jsext/fs\";\n *\n * const stream = createReadableStream(\"./package.json\");\n * const buffer = await readAsArrayBuffer(stream);\n * ```\n */\nexport async function readAsArrayBuffer(source) {\n    if (typeof Blob === \"function\" && source instanceof Blob) {\n        return await source.arrayBuffer();\n    }\n    else if (ArrayBuffer.isView(source)) {\n        return source.buffer;\n    }\n    const iterable = asAsyncIterable(source);\n    if (!iterable) {\n        throw new TypeError(\"The source is not an async iterable object.\");\n    }\n    const chunks = await readAsArray(iterable);\n    const bytes = concatBytes(...chunks);\n    return bytes.buffer;\n}\n/**\n * Reads all data from the given source to a `Blob`.\n *\n * @example\n * ```ts\n * import { readAsBlob } from \"@ayonli/jsext/reader\";\n * import { createReadableStream } from \"@ayonli/jsext/fs\";\n *\n * const stream = createReadableStream(\"./package.json\");\n * const blob = await readAsBlob(stream, \"application/json\");\n * ```\n */\nexport async function readAsBlob(source, type) {\n    if (source instanceof ArrayBuffer || ArrayBuffer.isView(source)) {\n        return new Blob([source], { type });\n    }\n    const buffer = await readAsArrayBuffer(source);\n    return new Blob([buffer], { type });\n}\n/**\n * Reads all data from the given source to a data URL.\n *\n * @example\n * ```ts\n * import { readAsDataURL } from \"@ayonli/jsext/reader\";\n *\n * const file = new File([\"Hello, World!\"], \"hello.txt\", { type: \"text/plain\" });\n * const dataURL = await readAsDataURL(file, file.type);\n *\n * console.log(dataURL); // data:text/plain;base64,SGVsbG8sIFdvcmxkIQ==\n * ```\n */\nexport async function readAsDataURL(source, type) {\n    if (source instanceof ArrayBuffer) {\n        const base64 = text(new Uint8Array(source), \"base64\");\n        return `data:${type};base64,${base64}`;\n    }\n    else if (source instanceof Uint8Array) {\n        const base64 = text(source, \"base64\");\n        return `data:${type};base64,${base64}`;\n    }\n    else if (ArrayBuffer.isView(source)) {\n        const bytes = new Uint8Array(source.buffer, source.byteOffset, source.byteLength);\n        const base64 = text(bytes, \"base64\");\n        return `data:${type};base64,${base64}`;\n    }\n    const buffer = await readAsArrayBuffer(source);\n    const _bytes = new Uint8Array(buffer);\n    const base64 = text(_bytes, \"base64\");\n    return `data:${type};base64,${base64}`;\n}\n/**\n * Reads all data from the given source to an object URL.\n *\n * @example\n * ```ts\n * import { readAsObjectURL } from \"@ayonli/jsext/reader\";\n *\n * const file = new File([\"Hello, World!\"], \"hello.txt\", { type: \"text/plain\" });\n * const objectURL = await readAsObjectURL(file, file.type);\n *\n * console.log(objectURL); // e.g. blob:http://localhost:8080/7b8e7b7d-7b7d-7b7d-7b7d-7b7d7b7d7b7d\n * ```\n */\nexport async function readAsObjectURL(source, type) {\n    if (source instanceof Blob) {\n        return URL.createObjectURL(source);\n    }\n    else if (source instanceof ArrayBuffer || ArrayBuffer.isView(source)) {\n        const blob = new Blob([source], { type });\n        return URL.createObjectURL(blob);\n    }\n    const buffer = await readAsArrayBuffer(source);\n    const blob = new Blob([buffer], { type });\n    return URL.createObjectURL(blob);\n}\n/**\n * Reads all data from the given source to a string.\n *\n * @example\n * ```ts\n * import { readAsText } from \"@ayonli/jsext/reader\";\n * import { createReadableStream } from \"@ayonli/jsext/fs\";\n *\n * const stream = createReadableStream(\"./package.json\");\n * const text = await readAsText(stream);\n * ```\n */\nexport async function readAsText(source, encoding = undefined) {\n    if (typeof Blob === \"function\" && source instanceof Blob && !encoding) {\n        return await source.text();\n    }\n    else if (source instanceof ArrayBuffer || ArrayBuffer.isView(source)) {\n        return new TextDecoder(encoding).decode(source);\n    }\n    const buffer = await readAsArrayBuffer(source);\n    return new TextDecoder(encoding).decode(buffer);\n}\n/**\n * Reads all data from the given source to a JSON object.\n *\n * @example\n * ```ts\n * import { readAsJSON } from \"@ayonli/jsext/reader\";\n * import { createReadableStream } from \"@ayonli/jsext/fs\";\n *\n * const stream = createReadableStream(\"./package.json\");\n * const pkg = await readAsJSON(stream);\n * ```\n */\nexport async function readAsJSON(source) {\n    const text = await readAsText(source);\n    return JSON.parse(text);\n}\nexport function concat(...sources) {\n    if (!sources[0]) {\n        throw new TypeError(\"No sources provided\");\n    }\n    if (typeof ReadableStream === \"function\" && sources[0] instanceof ReadableStream) {\n        if (!sources.every(source => source instanceof ReadableStream)) {\n            throw new TypeError(\"All sources must be readable streams\");\n        }\n        const streams = sources;\n        let current = 0;\n        let reader = streams[current].getReader();\n        return new ReadableStream({\n            async pull(controller) {\n                try {\n                    let { done, value } = await reader.read();\n                    if (!done) {\n                        controller.enqueue(value);\n                    }\n                    else {\n                        reader.releaseLock();\n                        current++;\n                        if (current < streams.length) {\n                            reader = streams[current].getReader();\n                            return this.pull(controller);\n                        }\n                        else {\n                            controller.close();\n                        }\n                    }\n                }\n                catch (err) {\n                    reader.releaseLock();\n                    controller.error(err);\n                }\n            }\n        });\n    }\n    else {\n        if (sources.some(source => typeof source[Symbol.asyncIterator] !== \"function\")) {\n            throw new TypeError(\"All sources must be async iterable objects\");\n        }\n        const iterables = sources;\n        return {\n            [Symbol.asyncIterator]: async function* () {\n                for (const source of iterables) {\n                    yield* source;\n                }\n            }\n        };\n    }\n}\n//# sourceMappingURL=reader.js.map"],"names":["resolveReadableStream","toAsyncIterable","asAsyncIterable","bytes","concatBytes","text"],"mappings":"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"}