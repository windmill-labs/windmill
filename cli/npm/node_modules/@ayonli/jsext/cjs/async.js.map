{"version":3,"file":"async.js","sources":["../async.ts"],"sourcesContent":["/**\n * Functions for async/promise context handling.\n * @module\n */\nimport { unrefTimer } from \"./runtime.ts\";\nimport Exception from \"./error/Exception.ts\";\n/**\n * Creates a promise that can be resolved or rejected manually.\n *\n * This function is like `Promise.withResolvers` but less verbose.\n *\n * @example\n * ```ts\n * import { asyncTask } from \"@ayonli/jsext/async\";\n *\n * const task = asyncTask<number>();\n *\n * setTimeout(() => task.resolve(42), 1000);\n *\n * const result = await task;\n * console.log(result); // 42\n * ```\n */\nexport function asyncTask() {\n    let resolve;\n    let reject;\n    const promise = new Promise((res, rej) => {\n        resolve = res;\n        reject = rej;\n    });\n    return Object.assign(promise, {\n        resolve: resolve,\n        reject: reject\n    });\n}\nexport function abortable(task, signal) {\n    if (typeof task[Symbol.asyncIterator] === \"function\" &&\n        typeof task.then !== \"function\" // this skips ThenableAsyncGenerator\n    ) {\n        return abortableAsyncIterable(task, signal);\n    }\n    else {\n        return select([task], signal);\n    }\n}\nasync function* abortableAsyncIterable(task, signal) {\n    if (signal.aborted) {\n        throw signal.reason;\n    }\n    const aTask = asyncTask();\n    const handleAbort = () => aTask.reject(signal.reason);\n    signal.addEventListener(\"abort\", handleAbort, { once: true });\n    const it = task[Symbol.asyncIterator]();\n    while (true) {\n        const race = Promise.race([it.next(), aTask]);\n        race.catch(() => {\n            signal.removeEventListener(\"abort\", handleAbort);\n        });\n        const { done, value } = await race;\n        if (done) {\n            signal.removeEventListener(\"abort\", handleAbort);\n            return value; // async iterator may return a value\n        }\n        else {\n            yield value;\n        }\n    }\n}\nfunction createTimeoutError(ms) {\n    if (typeof DOMException === \"function\") {\n        return new DOMException(`operation timeout after ${ms}ms`, \"TimeoutError\");\n    }\n    else {\n        return new Exception(`operation timeout after ${ms}ms`, {\n            name: \"TimeoutError\",\n            code: 408,\n        });\n    }\n}\n/**\n * Try to resolve a promise with a timeout limit.\n *\n * @example\n * ```ts\n * import { timeout, sleep } from \"@ayonli/jsext/async\";\n *\n * const task = sleep(1000);\n *\n * await timeout(task, 500); // throws TimeoutError after 500ms\n * ```\n */\nexport async function timeout(task, ms) {\n    const result = await Promise.race([\n        task,\n        new Promise((_, reject) => unrefTimer(setTimeout(() => {\n            reject(createTimeoutError(ms));\n        }, ms)))\n    ]);\n    return result;\n}\n/**\n * Resolves a promise only after the given duration.\n *\n * @example\n * ```ts\n * import { after } from \"@ayonli/jsext/async\";\n *\n * const task = fetch(\"https://example.com\")\n * const res = await after(task, 1000);\n *\n * console.log(res); // the response will not be printed unless 1 second has passed\n * ```\n */\nexport async function after(task, ms) {\n    const [result] = await Promise.allSettled([\n        task,\n        new Promise(resolve => setTimeout(resolve, ms))\n    ]);\n    if (result.status === \"fulfilled\") {\n        return result.value;\n    }\n    else {\n        throw result.reason;\n    }\n}\n/**\n * Blocks the context for a given duration.\n *\n * @example\n * ```ts\n * import { sleep } from \"@ayonli/jsext/async\";\n *\n * console.log(\"Hello\");\n *\n * await sleep(1000);\n * console.log(\"World\"); // \"World\" will be printed after 1 second\n * ```\n */\nexport async function sleep(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n/**\n * Blocks the current routine until the test returns a truthy value, which is\n * not `false`, `null` or `undefined`. If the test throws an error, it will be\n * treated as a falsy value and the check continues.\n *\n * This functions returns the same result as the test function when passed.\n *\n * @example\n * ```ts\n * import { until } from \"@ayonli/jsext/async\";\n *\n * // wait for the header element to be present in the DOM\n * const ele = await until(() => document.querySelector(\"header\"));\n * ```\n */\nexport async function until(test) {\n    return new Promise((resolve) => {\n        let ongoing = false;\n        const timer = setInterval(async () => {\n            if (ongoing)\n                return;\n            try {\n                ongoing = true;\n                const result = await test();\n                if (result !== false && result !== null && result !== undefined) {\n                    clearInterval(timer);\n                    resolve(result);\n                }\n            }\n            catch (_a) {\n                // ignore\n            }\n            finally {\n                ongoing = false;\n            }\n        }, 1);\n    });\n}\n/**\n * Runs multiple tasks concurrently and returns the result of the first task that\n * completes. The rest of the tasks will be aborted.\n *\n * @param tasks An array of promises or functions that return promises.\n * @param signal A parent abort signal, if provided and aborted before any task\n *  completes, the function will reject immediately with the abort reason and\n *  cancel all tasks.\n *\n * @example\n * ```ts\n * // fetch example\n * import { select } from \"@ayonli/jsext/async\";\n *\n * const res = await select([\n *     signal => fetch(\"https://example.com\", { signal }),\n *     signal => fetch(\"https://example.org\", { signal }),\n *     fetch(\"https://example.net\"), // This task cannot actually be aborted, but ignored\n * ]);\n *\n * console.log(res); // the response from the first completed fetch\n * ```\n *\n * @example\n * ```ts\n * // with parent signal\n * import { select } from \"@ayonli/jsext/async\";\n *\n * const signal = AbortSignal.timeout(1000);\n *\n * try {\n *     const res = await select([\n *         signal => fetch(\"https://example.com\", { signal }),\n *         signal => fetch(\"https://example.org\", { signal }),\n *     ], signal);\n * } catch (err) {\n *     if ((err as Error).name === \"TimeoutError\") {\n *         console.error(err); // Error: signal timed out\n *     } else {\n *         throw err;\n *     }\n * }\n * ```\n */\nexport async function select(tasks, signal = undefined) {\n    if (signal === null || signal === void 0 ? void 0 : signal.aborted) {\n        throw signal.reason;\n    }\n    const ctrl = signal ? abortWith(signal) : new AbortController();\n    const { signal: _signal } = ctrl;\n    tasks = [\n        ...tasks,\n        new Promise((_, reject) => {\n            _signal.addEventListener(\"abort\", () => {\n                reject(_signal.reason);\n            }, { once: true });\n        })\n    ];\n    return await Promise.race(tasks.map(task => {\n        return typeof task === \"function\" ? task(_signal) : task;\n    })).finally(() => {\n        _signal.aborted || ctrl.abort();\n    });\n}\nexport function abortWith(_parent, options = undefined) {\n    let parent;\n    let timeout;\n    if (_parent instanceof AbortSignal) {\n        parent = _parent;\n        timeout = options === null || options === void 0 ? void 0 : options.timeout;\n    }\n    else if (_parent) {\n        parent = _parent.parent;\n        timeout = _parent.timeout;\n    }\n    if (!parent && !timeout) {\n        throw new TypeError(\"Must provide a parent signal or a timeout value, or both\");\n    }\n    const ctrl = new AbortController();\n    const { signal } = ctrl;\n    if (parent) {\n        if (parent.aborted) {\n            ctrl.abort(parent.reason);\n            return ctrl;\n        }\n        const abort = () => {\n            signal.aborted || ctrl.abort(parent.reason);\n        };\n        parent.addEventListener(\"abort\", abort, { once: true });\n        signal.addEventListener(\"abort\", () => {\n            parent.aborted || parent.removeEventListener(\"abort\", abort);\n        });\n    }\n    if (timeout) {\n        const timer = setTimeout(() => {\n            signal.aborted || ctrl.abort(createTimeoutError(timeout));\n        }, timeout);\n        signal.addEventListener(\"abort\", () => {\n            clearTimeout(timer);\n        }, { once: true });\n    }\n    return ctrl;\n}\n//# sourceMappingURL=async.js.map"],"names":["Exception","unrefTimer"],"mappings":"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"}