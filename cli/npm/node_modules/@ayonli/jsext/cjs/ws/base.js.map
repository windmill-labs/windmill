{"version":3,"file":"base.js","sources":["../../ws/base.ts"],"sourcesContent":["var _a;\nimport \"../external/event-target-polyfill/index.ts\";\nimport chan from \"../chan.ts\";\nimport { fromErrorEvent } from \"../error.ts\";\nconst _source = Symbol.for(\"source\");\nconst _ws = Symbol.for(\"ws\");\n/**\n * This class represents a WebSocket connection on the server side.\n * Normally we don't create instances of this class directly, but rather use\n * the {@link WebSocketServer} to handle WebSocket connections, which will\n * create the instance for us.\n *\n * **Events:**\n *\n * - `open` - Dispatched when the connection is ready.\n * - `message` - Dispatched when a message is received.\n * - `error` - Dispatched when an error occurs, such as network failure. After\n *   this event is dispatched, the connection will be closed and the `close`\n *   event will be dispatched.\n * - `close` - Dispatched when the connection is closed. If the connection is\n *   closed due to some error, the `error` event will be dispatched before this\n *   event, and the close event will have the `wasClean` set to `false`, and the\n *   `reason` property contains the error message, if any.\n */\nexport class WebSocketConnection extends EventTarget {\n    constructor(source) {\n        super();\n        this[_a] = null;\n        this[_source] = source;\n        this[_source].then(ws => {\n            this[_ws] = ws;\n        });\n    }\n    /**\n     * A promise that resolves when the connection is ready to send and receive\n     * messages.\n     *\n     * @deprecated Listen for the `open` event instead.\n     */\n    get ready() {\n        return this[_source].then(() => this);\n    }\n    /**\n     * The current state of the WebSocket connection.\n     */\n    get readyState() {\n        var _b, _c;\n        return (_c = (_b = this[_ws]) === null || _b === void 0 ? void 0 : _b.readyState) !== null && _c !== void 0 ? _c : 0;\n    }\n    /**\n     * Sends data to the WebSocket client.\n     */\n    send(data) {\n        if (!this[_ws]) {\n            throw new Error(\"WebSocket connection is not ready\");\n        }\n        this[_ws].send(data);\n    }\n    /**\n     * Closes the WebSocket connection.\n     */\n    close(code, reason) {\n        if (!this[_ws]) {\n            throw new Error(\"WebSocket connection is not ready\");\n        }\n        this[_ws].close(code, reason);\n    }\n    addEventListener(event, listener, options = undefined) {\n        return super.addEventListener(event, listener, options);\n    }\n    removeEventListener(event, listener, options = undefined) {\n        return super.removeEventListener(event, listener, options);\n    }\n    async *[(_a = _ws, Symbol.asyncIterator)]() {\n        const channel = chan(Infinity);\n        const handleMessage = (ev) => {\n            channel.send(ev.data);\n        };\n        const handleClose = (ev) => {\n            ev.wasClean && channel.close();\n        };\n        const handleError = (ev) => {\n            channel.close(fromErrorEvent(ev));\n        };\n        this.addEventListener(\"message\", handleMessage);\n        this.addEventListener(\"close\", handleClose);\n        this.addEventListener(\"error\", handleError);\n        try {\n            for await (const data of channel) {\n                yield data;\n            }\n        }\n        finally {\n            this.removeEventListener(\"message\", handleMessage);\n            this.removeEventListener(\"close\", handleClose);\n            this.removeEventListener(\"error\", handleError);\n        }\n    }\n}\n//# sourceMappingURL=base.js.map"],"names":["chan","fromErrorEvent"],"mappings":";;;;;;AAAA,IAAI,EAAE,CAAC;AAIP,MAAM,OAAO,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;AACrC,MAAM,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAM,mBAAmB,SAAS,WAAW,CAAC;AACrD,IAAI,WAAW,CAAC,MAAM,EAAE;AACxB,QAAQ,KAAK,EAAE,CAAC;AAChB,QAAQ,IAAI,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC;AACxB,QAAQ,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;AAC/B,QAAQ,IAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,EAAE,IAAI;AACjC,YAAY,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC;AAC3B,SAAS,CAAC,CAAC;AACX,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,IAAI,KAAK,GAAG;AAChB,QAAQ,OAAO,IAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,CAAC;AAC9C,KAAK;AACL;AACA;AACA;AACA,IAAI,IAAI,UAAU,GAAG;AACrB,QAAQ,IAAI,EAAE,EAAE,EAAE,CAAC;AACnB,QAAQ,OAAO,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,IAAI,IAAI,EAAE,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,UAAU,MAAM,IAAI,IAAI,EAAE,KAAK,KAAK,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;AAC7H,KAAK;AACL;AACA;AACA;AACA,IAAI,IAAI,CAAC,IAAI,EAAE;AACf,QAAQ,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;AACxB,YAAY,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC;AACjE,SAAS;AACT,QAAQ,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AAC7B,KAAK;AACL;AACA;AACA;AACA,IAAI,KAAK,CAAC,IAAI,EAAE,MAAM,EAAE;AACxB,QAAQ,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;AACxB,YAAY,MAAM,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAAC;AACjE,SAAS;AACT,QAAQ,IAAI,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AACtC,KAAK;AACL,IAAI,gBAAgB,CAAC,KAAK,EAAE,QAAQ,EAAE,OAAO,GAAG,SAAS,EAAE;AAC3D,QAAQ,OAAO,KAAK,CAAC,gBAAgB,CAAC,KAAK,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;AAChE,KAAK;AACL,IAAI,mBAAmB,CAAC,KAAK,EAAE,QAAQ,EAAE,OAAO,GAAG,SAAS,EAAE;AAC9D,QAAQ,OAAO,KAAK,CAAC,mBAAmB,CAAC,KAAK,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;AACnE,KAAK;AACL,IAAI,SAAS,EAAE,GAAG,GAAG,EAAE,MAAM,CAAC,aAAa,EAAE,GAAG;AAChD,QAAQ,MAAM,OAAO,GAAGA,YAAI,CAAC,QAAQ,CAAC,CAAC;AACvC,QAAQ,MAAM,aAAa,GAAG,CAAC,EAAE,KAAK;AACtC,YAAY,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC;AAClC,SAAS,CAAC;AACV,QAAQ,MAAM,WAAW,GAAG,CAAC,EAAE,KAAK;AACpC,YAAY,EAAE,CAAC,QAAQ,IAAI,OAAO,CAAC,KAAK,EAAE,CAAC;AAC3C,SAAS,CAAC;AACV,QAAQ,MAAM,WAAW,GAAG,CAAC,EAAE,KAAK;AACpC,YAAY,OAAO,CAAC,KAAK,CAACC,oBAAc,CAAC,EAAE,CAAC,CAAC,CAAC;AAC9C,SAAS,CAAC;AACV,QAAQ,IAAI,CAAC,gBAAgB,CAAC,SAAS,EAAE,aAAa,CAAC,CAAC;AACxD,QAAQ,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AACpD,QAAQ,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AACpD,QAAQ,IAAI;AACZ,YAAY,WAAW,MAAM,IAAI,IAAI,OAAO,EAAE;AAC9C,gBAAgB,MAAM,IAAI,CAAC;AAC3B,aAAa;AACb,SAAS;AACT,gBAAgB;AAChB,YAAY,IAAI,CAAC,mBAAmB,CAAC,SAAS,EAAE,aAAa,CAAC,CAAC;AAC/D,YAAY,IAAI,CAAC,mBAAmB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AAC3D,YAAY,IAAI,CAAC,mBAAmB,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AAC3D,SAAS;AACT,KAAK;AACL;;;;"}