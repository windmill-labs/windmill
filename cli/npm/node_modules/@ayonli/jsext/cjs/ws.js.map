{"version":3,"file":"ws.js","sources":["../ws.ts"],"sourcesContent":["/**\n * This module provides a unified WebSocket server interface for Node.js, Deno,\n * Bun and Cloudflare Workers. This module is based on the `EventTarget`\n * interface and conforms the web standard.\n *\n * **IMPORTANT**: The {@link WebSocketConnection} interface is an abstraction of\n * the WebSocket on the server side, it's design is not consistent with the\n * {@link WebSocket} API in the browser. For example, when receiving binary data,\n * the `data` property is always a `Uint8Array` object, which is different from\n * the `Blob` object (or `ArrayBuffer`) in the browser. In the future, we may\n * provide a more consistent API, be aware of this when using this module.\n * @module\n * @experimental\n */\nvar _a, _b, _c, _d;\nimport { asyncTask } from \"./async.ts\";\nimport { concat, text } from \"./bytes.ts\";\nimport { createCloseEvent, createErrorEvent } from \"./event.ts\";\nimport runtime from \"./runtime.ts\";\nimport { WebSocketConnection } from \"./ws/base.ts\";\nconst _errored = Symbol.for(\"errored\");\nconst _handler = Symbol.for(\"handler\");\nconst _clients = Symbol.for(\"clients\");\nconst _httpServer = Symbol.for(\"httpServer\");\nconst _wsServer = Symbol.for(\"wsServer\");\nconst _connTasks = Symbol.for(\"connTasks\");\n/**\n * A unified WebSocket server interface for Node.js, Deno, Bun and Cloudflare\n * Workers.\n *\n * There are two ways to handle WebSocket connections:\n *\n * 1. By passing a listener function to the constructor, handle all connections\n *    in a central place.\n * 2. By using the `socket` object returned from the `upgrade` method to handle\n *    each connection in a more flexible way. However, at this stage, the\n *    connection may not be ready yet, and we need to listen the `open` event\n *    or wait for the `ready` promise (deprecated) to resolve before we can\n *    start sending messages.\n *\n * The `socket` object is an async iterable object, which can be used in the\n * `for await...of` loop to read messages with backpressure support.\n *\n * @example\n * ```ts\n * // centralized connection handler\n * import { WebSocketServer } from \"@ayonli/jsext/ws\";\n *\n * const wsServer = new WebSocketServer(socket => {\n *     console.log(\"WebSocket connection established.\");\n *\n *     socket.addEventListener(\"message\", (event) => {\n *         socket.send(\"received: \" + event.data);\n *     });\n *\n *     socket.addEventListener(\"error\", (event) => {\n *         console.error(\"WebSocket connection error:\", event.error);\n *     });\n *\n *     socket.addEventListener(\"close\", (event) => {\n *         console.log(`WebSocket connection closed, reason: ${event.reason}, code: ${event.code}`);\n *     });\n * });\n *\n * // Node.js\n * import * as http from \"node:http\";\n * const httpServer = http.createServer(req => {\n *      wsServer.upgrade(req);\n * });\n * httpServer.listen(3000);\n *\n * // Node.js (withWeb)\n * import { withWeb } from \"@ayonli/jsext/http\";\n * const httpServer2 = http.createServer(withWeb(req => {\n *      const { response } = wsServer.upgrade(req);\n *      return response;\n * }));\n * httpServer2.listen(3001);\n *\n * // Bun\n * const bunServer = Bun.serve({\n *     fetch(req) {\n *         const { response } = wsServer.upgrade(req);\n *         return response;\n *     },\n *     websocket: wsServer.bunListener,\n * });\n * wsServer.bunBind(bunServer);\n *\n * // Deno\n * Deno.serve(req => {\n *     const { response } = wsServer.upgrade(req);\n *     return response;\n * });\n *\n * // Cloudflare Workers\n * export default {\n *     fetch(req) {\n *         const { response } = wsServer.upgrade(req);\n *         return response;\n *     },\n * };\n * ```\n *\n * @example\n * ```ts\n * // per-request connection handler (Deno example)\n * import { WebSocketServer } from \"@ayonli/jsext/ws\";\n *\n * const wsServer = new WebSocketServer();\n *\n * Deno.serve(req => {\n *     const { socket, response } = wsServer.upgrade(req);\n *\n *     socket.addEventListener(\"open\", () => {\n *         console.log(\"WebSocket connection established.\");\n *     });\n *\n *     socket.addEventListener(\"message\", (event) => {\n *         socket.send(\"received: \" + event.data);\n *     });\n *\n *     socket.addEventListener(\"error\", (event) => {\n *         console.error(\"WebSocket connection error:\", event.error);\n *     });\n *\n *     socket.addEventListener(\"close\", (event) => {\n *         console.log(`WebSocket connection closed, reason: ${event.reason}, code: ${event.code}`);\n *     });\n *\n *     // The response should be returned immediately, otherwise the web socket\n *     // will not be ready.\n *     return response;\n * });\n * ```\n *\n * @example\n * ```ts\n * // async iterable\n * const wsServer = new WebSocketServer(async socket => {\n *     console.log(\"WebSocket connection established.\");\n *\n *     try {\n *         for await (const message of socket) {\n *             socket.send(\"received: \" + message);\n *         }\n *     } catch (error) {\n *         console.error(\"WebSocket connection error:\", error);\n *     }\n *\n *     console.log(\"WebSocket connection closed\");\n * });\n *\n * Deno.serve(req => {\n *     const { response } = wsServer.upgrade(req);\n *     return response;\n * });\n * ```\n */\nexport class WebSocketServer {\n    constructor(...args) {\n        var _e, _f, _g;\n        this[_a] = new Map();\n        this[_b] = undefined;\n        this[_c] = null;\n        this[_d] = new Map();\n        if (args.length === 2) {\n            this.idleTimeout = ((_e = args[0]) === null || _e === void 0 ? void 0 : _e.idleTimeout) || 30;\n            this.perMessageDeflate = (_g = (_f = args[0]) === null || _f === void 0 ? void 0 : _f.perMessageDeflate) !== null && _g !== void 0 ? _g : false;\n            this[_handler] = args[1];\n        }\n        else {\n            this.idleTimeout = 30;\n            this.perMessageDeflate = false;\n            this[_handler] = args[0];\n        }\n    }\n    upgrade(request) {\n        const upgradeHeader = \"socket\" in request\n            ? request.headers[\"upgrade\"]\n            : request.headers.get(\"Upgrade\");\n        if (!upgradeHeader || upgradeHeader !== \"websocket\") {\n            throw new TypeError(\"Expected Upgrade: websocket\");\n        }\n        const handler = this[_handler];\n        const clients = this[_clients];\n        const { identity } = runtime();\n        if (identity === \"deno\") {\n            if (\"socket\" in request) {\n                throw new TypeError(\"Node.js support is not implemented outside Node.js runtime.\");\n            }\n            const { socket: ws, response } = Deno.upgradeWebSocket(request, {\n                idleTimeout: this.idleTimeout,\n            });\n            const socket = new WebSocketConnection(new Promise((resolve) => {\n                ws.binaryType = \"arraybuffer\";\n                ws.onmessage = (ev) => {\n                    if (typeof ev.data === \"string\") {\n                        socket.dispatchEvent(new MessageEvent(\"message\", {\n                            data: ev.data,\n                        }));\n                    }\n                    else {\n                        socket.dispatchEvent(new MessageEvent(\"message\", {\n                            data: new Uint8Array(ev.data),\n                        }));\n                    }\n                };\n                ws.onclose = (ev) => {\n                    if (!ev.wasClean) {\n                        socket.dispatchEvent(createErrorEvent(\"error\", {\n                            error: new Error(`WebSocket connection closed: ${ev.reason} (${ev.code})`),\n                        }));\n                    }\n                    clients.delete(request);\n                    socket.dispatchEvent(createCloseEvent(\"close\", {\n                        code: ev.code,\n                        reason: ev.reason,\n                        wasClean: ev.wasClean,\n                    }));\n                };\n                if (ws.readyState === 1) {\n                    resolve(ws);\n                }\n                else {\n                    ws.onopen = () => {\n                        resolve(ws);\n                    };\n                }\n            }));\n            socket.ready.then(() => {\n                clients.set(request, socket);\n                handler === null || handler === void 0 ? void 0 : handler.call(this, socket);\n                socket.dispatchEvent(new Event(\"open\"));\n            });\n            return { socket, response };\n        }\n        else if (identity === \"bun\") {\n            if (\"socket\" in request) {\n                throw new TypeError(\"Node.js support is not implemented outside Node.js runtime.\");\n            }\n            const server = this[_httpServer];\n            if (!server) {\n                throw new Error(\"WebSocket server is not bound to a Bun server instance.\");\n            }\n            const task = asyncTask();\n            this[_connTasks].set(request, task);\n            const ok = server.upgrade(request, { data: { request } });\n            if (!ok) {\n                throw new Error(\"Failed to upgrade to WebSocket\");\n            }\n            const socket = new WebSocketConnection(task);\n            socket.ready.then(() => {\n                clients.set(request, socket);\n                handler === null || handler === void 0 ? void 0 : handler.call(this, socket);\n                socket.dispatchEvent(new Event(\"open\"));\n            });\n            return {\n                socket,\n                response: new Response(null, {\n                    status: 101,\n                    statusText: \"Switching Protocols\",\n                    headers: new Headers({\n                        \"Upgrade\": \"websocket\",\n                        \"Connection\": \"Upgrade\",\n                    }),\n                }),\n            };\n        }\n        else if (identity === \"node\") {\n            const isNodeRequest = \"socket\" in request;\n            if (!isNodeRequest && Reflect.has(request, Symbol.for(\"incomingMessage\"))) {\n                request = Reflect.get(request, Symbol.for(\"incomingMessage\"));\n            }\n            if (!(\"socket\" in request)) {\n                throw new TypeError(\"Expected an instance of http.IncomingMessage\");\n            }\n            const { socket } = request;\n            const upgradeHeader = request.headers.upgrade;\n            if (!upgradeHeader || upgradeHeader !== \"websocket\") {\n                throw new TypeError(\"Expected Upgrade: websocket\");\n            }\n            const handler = this[_handler];\n            const clients = this[_clients];\n            if (!this[_wsServer]) {\n                this[_wsServer] = import(\"ws\").then(({ WebSocketServer: WsServer }) => {\n                    return new WsServer({\n                        noServer: true,\n                        perMessageDeflate: this.perMessageDeflate,\n                    });\n                });\n            }\n            const task = this[_wsServer].then(wsServer => new Promise((resolve) => {\n                wsServer.handleUpgrade(request, socket, Buffer.alloc(0), (ws) => {\n                    ws.on(\"message\", (data, isBinary) => {\n                        data = Array.isArray(data) ? concat(...data) : data;\n                        let event;\n                        if (typeof data === \"string\") {\n                            event = new MessageEvent(\"message\", { data });\n                        }\n                        else {\n                            if (isBinary) {\n                                event = new MessageEvent(\"message\", {\n                                    data: new Uint8Array(data),\n                                });\n                            }\n                            else {\n                                const bytes = data instanceof ArrayBuffer\n                                    ? new Uint8Array(data)\n                                    : data;\n                                event = new MessageEvent(\"message\", {\n                                    data: text(bytes),\n                                });\n                            }\n                        }\n                        client.dispatchEvent(event);\n                    });\n                    ws.on(\"error\", error => {\n                        Object.assign(ws, { [_errored]: true });\n                        client.dispatchEvent(createErrorEvent(\"error\", { error }));\n                    });\n                    ws.on(\"close\", (code, reason) => {\n                        var _e;\n                        clients.delete(request);\n                        client.dispatchEvent(createCloseEvent(\"close\", {\n                            code,\n                            reason: (_e = reason === null || reason === void 0 ? void 0 : reason.toString(\"utf8\")) !== null && _e !== void 0 ? _e : \"\",\n                            wasClean: Reflect.get(ws, _errored) !== false,\n                        }));\n                    });\n                    resolve(ws);\n                });\n            }));\n            const client = new WebSocketConnection(task);\n            client.ready.then(() => {\n                clients.set(request, client);\n                handler === null || handler === void 0 ? void 0 : handler.call(this, client);\n                client.dispatchEvent(new Event(\"open\"));\n            });\n            if (!isNodeRequest && typeof Response === \"function\") {\n                const response = new Response(null, {\n                    status: 200,\n                    statusText: \"Switching Protocols\",\n                    headers: new Headers({\n                        \"Upgrade\": \"websocket\",\n                        \"Connection\": \"Upgrade\",\n                    }),\n                });\n                // HACK: Node.js currently does not support setting the\n                // status code to outside the range of 200 to 599. This\n                // is a workaround to set the status code to 101.\n                Object.defineProperty(response, \"status\", {\n                    configurable: true,\n                    value: 101,\n                });\n                return { socket: client, response };\n            }\n            else {\n                return { socket: client };\n            }\n        }\n        else {\n            throw new TypeError(\"Unsupported runtime\");\n        }\n    }\n    /**\n     * Used in Bun, to bind the WebSocket server to the Bun server instance.\n     */\n    bunBind(server) {\n        this[_httpServer] = server;\n    }\n    /**\n     * A WebSocket listener for `Bun.serve()`.\n     */\n    get bunListener() {\n        const clients = this[_clients];\n        const connTasks = this[_connTasks];\n        return {\n            idleTimeout: this.idleTimeout,\n            perMessageDeflate: this.perMessageDeflate,\n            open: async (ws) => {\n                const { request } = ws.data;\n                const task = connTasks.get(request);\n                if (task) {\n                    connTasks.delete(request);\n                    task.resolve(ws);\n                }\n            },\n            message: (ws, msg) => {\n                const { request } = ws.data;\n                const client = clients.get(request);\n                if (client) {\n                    if (typeof msg === \"string\") {\n                        client.dispatchEvent(new MessageEvent(\"message\", {\n                            data: msg,\n                        }));\n                    }\n                    else {\n                        client.dispatchEvent(new MessageEvent(\"message\", {\n                            data: new Uint8Array(msg),\n                        }));\n                    }\n                }\n            },\n            error: (ws, error) => {\n                Object.assign(ws, { [_errored]: true });\n                const { request } = ws.data;\n                const client = clients.get(request);\n                client && client.dispatchEvent(createErrorEvent(\"error\", { error }));\n            },\n            close: (ws, code, reason) => {\n                const { request } = ws.data;\n                const client = clients.get(request);\n                if (client) {\n                    clients.delete(request);\n                    client.dispatchEvent(createCloseEvent(\"close\", {\n                        code,\n                        reason,\n                        wasClean: Reflect.get(ws, _errored) !== true,\n                    }));\n                }\n            },\n        };\n    }\n    /**\n     * An iterator that yields all connected WebSocket clients, can be used to\n     * broadcast messages to all clients.\n     */\n    get clients() {\n        return this[_clients].values();\n    }\n}\n_a = _clients, _b = _httpServer, _c = _wsServer, _d = _connTasks;\n//# sourceMappingURL=ws.js.map"],"names":["runtime","WebSocketConnection","createErrorEvent","createCloseEvent","asyncTask","concat","bytes","text"],"mappings":";;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,CAAC;AAMnB,MAAM,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;AACvC,MAAM,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;AACvC,MAAM,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;AACvC,MAAM,WAAW,GAAG,MAAM,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;AAC7C,MAAM,SAAS,GAAG,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;AACzC,MAAM,UAAU,GAAG,MAAM,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAM,eAAe,CAAC;AAC7B,IAAI,WAAW,CAAC,GAAG,IAAI,EAAE;AACzB,QAAQ,IAA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"}