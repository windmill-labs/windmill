{"version":3,"file":"ws.js","sources":["../../workerd/ws.ts"],"sourcesContent":["var _a;\nimport { createCloseEvent, createErrorEvent } from \"../event.ts\";\nimport { WebSocketConnection } from \"../ws/base.ts\";\nconst _handler = Symbol.for(\"handler\");\nconst _clients = Symbol.for(\"clients\");\nexport class WebSocketServer {\n    constructor(...args) {\n        var _b, _c, _d;\n        this[_a] = new Map();\n        if (args.length === 2) {\n            this.idleTimeout = ((_b = args[0]) === null || _b === void 0 ? void 0 : _b.idleTimeout) || 30;\n            this.perMessageDeflate = (_d = (_c = args[0]) === null || _c === void 0 ? void 0 : _c.perMessageDeflate) !== null && _d !== void 0 ? _d : false;\n            this[_handler] = args[1];\n        }\n        else {\n            this.idleTimeout = 30;\n            this.perMessageDeflate = false;\n            this[_handler] = args[0];\n        }\n    }\n    upgrade(request) {\n        if (\"socket\" in request) {\n            throw new TypeError(\"Expected a Request instance\");\n        }\n        const upgradeHeader = request.headers.get(\"Upgrade\");\n        if (!upgradeHeader || upgradeHeader !== \"websocket\") {\n            throw new TypeError(\"Expected Upgrade: websocket\");\n        }\n        else if (typeof WebSocketPair !== \"function\") {\n            throw new Error(\"WebSocket is not supported in this environment\");\n        }\n        const handler = this[_handler];\n        const clients = this[_clients];\n        const [client, server] = Object.values(new WebSocketPair());\n        const socket = new WebSocketConnection(new Promise(resolve => {\n            server.accept();\n            server.addEventListener(\"message\", ev => {\n                if (typeof ev.data === \"string\") {\n                    socket.dispatchEvent(new MessageEvent(\"message\", {\n                        data: ev.data,\n                    }));\n                }\n                else if (ev.data instanceof ArrayBuffer) {\n                    socket.dispatchEvent(new MessageEvent(\"message\", {\n                        data: new Uint8Array(ev.data),\n                    }));\n                }\n                else {\n                    ev.data.arrayBuffer().then(buffer => {\n                        socket.dispatchEvent(new MessageEvent(\"message\", {\n                            data: new Uint8Array(buffer),\n                        }));\n                    }).catch(() => { });\n                }\n            });\n            server.addEventListener(\"close\", ev => {\n                if (!ev.wasClean) {\n                    socket.dispatchEvent(createErrorEvent(\"error\", {\n                        error: new Error(`WebSocket connection closed: ${ev.reason} (${ev.code})`),\n                    }));\n                }\n                clients.delete(request);\n                socket.dispatchEvent(createCloseEvent(\"close\", {\n                    code: ev.code,\n                    reason: ev.reason,\n                    wasClean: ev.wasClean,\n                }));\n            });\n            if (server.readyState === 1) {\n                resolve(server);\n            }\n            else {\n                server.addEventListener(\"open\", () => {\n                    resolve(server);\n                });\n            }\n        }));\n        socket.ready.then(() => {\n            clients.set(request, socket);\n            handler === null || handler === void 0 ? void 0 : handler.call(this, socket);\n            socket.dispatchEvent(new Event(\"open\"));\n        });\n        return {\n            socket,\n            response: new Response(null, {\n                status: 101,\n                statusText: \"Switching Protocols\",\n                headers: new Headers({\n                    \"Upgrade\": \"websocket\",\n                    \"Connection\": \"Upgrade\",\n                }),\n                // @ts-ignore\n                webSocket: client,\n            }),\n        };\n    }\n    bunBind(server) {\n        void server;\n    }\n    get bunListener() {\n        return {\n            idleTimeout: this.idleTimeout,\n            perMessageDeflate: this.perMessageDeflate,\n            message: () => void 0,\n            open: () => void 0,\n            error: () => void 0,\n            close: () => void 0,\n        };\n    }\n}\n_a = _clients;\n//# sourceMappingURL=ws.js.map"],"names":[],"mappings":"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"}