{"version":3,"file":"progress.js","sources":["../../dialog/progress.ts"],"sourcesContent":["import { isBrowserWindow, isDeno, isNodeLike } from \"../env.ts\";\n/**\n * Displays a dialog with a progress bar indicating the ongoing state of the\n * `fn` function, and to wait until the job finishes or the user cancels the\n * dialog.\n *\n * @param onAbort If provided, the dialog will show a cancel button (or listen\n * for Escape in CLI) that allows the user to abort the task. This function can\n * either return a default/fallback result or throw an error to indicate the\n * cancellation.\n *\n * @example\n * ```ts\n * // default usage\n * import { progress } from \"@ayonli/jsext/dialog\";\n *\n * const result = await progress(\"Processing...\", async () => {\n *     // ... some long-running task\n *     return { ok: true };\n * });\n *\n * console.log(result); // { ok: true }\n * ```\n *\n * @example\n * ```ts\n * // update state\n * import { progress } from \"@ayonli/jsext/dialog\";\n *\n * const result = await progress(\"Processing...\", async (set) => {\n *     set({ percent: 0 });\n *     // ... some long-running task\n *     set({ percent: 50, message: \"Halfway there!\" });\n *     // ... some long-running task\n *     set({ percent: 100 });\n *\n *     return { ok: true };\n * });\n *\n * console.log(result); // { ok: true }\n * ```\n *\n * @example\n * ```ts\n * // abortable\n * import { progress } from \"@ayonli/jsext/dialog\";\n *\n * const result = await progress(\"Processing...\", async (set, signal) => {\n *     set({ percent: 0 });\n *\n *     if (!signal.aborted) {\n *         // ... some long-running task\n *         set({ percent: 50, message: \"Halfway there!\" });\n *     }\n *\n *     if (!signal.aborted) {\n *         // ... some long-running task\n *         set({ percent: 100 });\n *     }\n *\n *     return { ok: true };\n * }, () => {\n *     return { ok: false };\n * });\n *\n * console.log(result); // { ok: true } or { ok: false }\n * ```\n */\nexport default async function progress(message, fn, onAbort = undefined) {\n    const ctrl = new AbortController();\n    const signal = ctrl.signal;\n    let fallback = null;\n    const abort = !onAbort ? undefined : async () => {\n        try {\n            const result = await onAbort();\n            fallback = { value: result };\n            ctrl.abort();\n        }\n        catch (err) {\n            ctrl.abort(err);\n        }\n    };\n    const listenForAbort = !onAbort ? undefined : () => new Promise((resolve, reject) => {\n        signal.addEventListener(\"abort\", () => {\n            if (fallback) {\n                resolve(fallback.value);\n            }\n            else {\n                reject(signal.reason);\n            }\n        });\n    });\n    if (isBrowserWindow) {\n        const { progressInBrowser } = await import(\"./browser/index.ts\");\n        return await progressInBrowser(message, fn, { signal, abort, listenForAbort });\n    }\n    else if (isDeno || isNodeLike) {\n        const { lockStdin } = await import(\"../cli.ts\");\n        const { handleTerminalProgress } = await import(\"./terminal/progress.ts\");\n        return await lockStdin(() => handleTerminalProgress(message, fn, {\n            signal,\n            abort,\n            listenForAbort,\n        }));\n    }\n    else {\n        throw new Error(\"Unsupported runtime\");\n    }\n}\n//# sourceMappingURL=progress.js.map"],"names":[],"mappings":";;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,eAAe,QAAQ,CAAC,OAAO,EAAE,EAAE,EAAE,OAAO,GAAG,SAAS,EAAE;AACzE,IAAI,MAAM,IAAI,GAAG,IAAI,eAAe,EAAE,CAAC;AACvC,IAAI,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;AAC/B,IAAI,IAAI,QAAQ,GAAG,IAAI,CAAC;AACxB,IAAI,MAAM,KAAK,GAAG,CAAC,OAAO,GAAG,SAAS,GAAG,YAAY;AACrD,QAAQ,IAAI;AACZ,YAAY,MAAM,MAAM,GAAG,MAAM,OAAO,EAAE,CAAC;AAC3C,YAAY,QAAQ,GAAG,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC;AACzC,YAAY,IAAI,CAAC,KAAK,EAAE,CAAC;AACzB,SAAS;AACT,QAAQ,OAAO,GAAG,EAAE;AACpB,YAAY,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AAC5B,SAAS;AACT,KAAK,CAAC;AACN,IAAI,MAAM,cAAc,GAAG,CAAC,OAAO,GAAG,SAAS,GAAG,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAK;AACzF,QAAQ,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAM;AAC/C,YAAY,IAAI,QAAQ,EAAE;AAC1B,gBAAgB,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;AACxC,aAAa;AACb,iBAAiB;AACjB,gBAAgB,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;AACtC,aAAa;AACb,SAAS,CAAC,CAAC;AACX,KAAK,CAAC,CAAC;AACP,IAAI,IAAI,eAAe,EAAE;AACzB,QAAQ,MAAM,EAAE,iBAAiB,EAAE,GAAG,MAAM,OAAO,oBAAoB,CAAC,CAAC;AACzE,QAAQ,OAAO,MAAM,iBAAiB,CAAC,OAAO,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE,KAAK,EAAE,cAAc,EAAE,CAAC,CAAC;AACvF,KAAK;AACL,SAAS,IAAI,MAAM,IAAI,UAAU,EAAE;AACnC,QAAQ,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,OAAO,WAAW,CAAC,CAAC;AACxD,QAAQ,MAAM,EAAE,sBAAsB,EAAE,GAAG,MAAM,OAAO,wBAAwB,CAAC,CAAC;AAClF,QAAQ,OAAO,MAAM,SAAS,CAAC,MAAM,sBAAsB,CAAC,OAAO,EAAE,EAAE,EAAE;AACzE,YAAY,MAAM;AAClB,YAAY,KAAK;AACjB,YAAY,cAAc;AAC1B,SAAS,CAAC,CAAC,CAAC;AACZ,KAAK;AACL,SAAS;AACT,QAAQ,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAC;AAC/C,KAAK;AACL;;;;"}