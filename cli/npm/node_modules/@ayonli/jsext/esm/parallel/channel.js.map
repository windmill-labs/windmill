{"version":3,"file":"channel.js","sources":["../../parallel/channel.ts"],"sourcesContent":["import { Channel } from \"../chan.ts\";\nimport { id, isMainThread } from \"../env.ts\";\nconst channelStore = new Map();\nexport function isChannelMessage(msg) {\n    return msg\n        && typeof msg === \"object\"\n        && [\"send\", \"close\"].includes(msg.type)\n        && typeof msg.channelId === \"number\";\n}\nexport async function handleChannelMessage(msg) {\n    const record = channelStore.get(msg.channelId);\n    if (!record)\n        return;\n    if (msg.type === \"send\") {\n        await record.raw.send(msg.value);\n    }\n    else if (msg.type === \"close\") {\n        const { value: err, channelId } = msg;\n        record.raw.close(err);\n        channelStore.delete(channelId);\n        if (isMainThread && record.writers.length > 1) {\n            // distribute the channel close event to all threads\n            record.writers.forEach(write => {\n                write(\"close\", err, channelId);\n            });\n        }\n    }\n}\nfunction wireChannel(channel, channelWrite) {\n    const channelId = channel[id];\n    if (!channelStore.has(channelId)) {\n        const send = channel.send.bind(channel);\n        const close = channel.close.bind(channel);\n        channelStore.set(channelId, {\n            channel,\n            raw: { send, close },\n            writers: [channelWrite],\n            counter: 0,\n        });\n        Object.defineProperties(channel, {\n            send: {\n                configurable: true,\n                writable: true,\n                value: async (data) => {\n                    const record = channelStore.get(channelId);\n                    if (record) {\n                        const channel = record.channel;\n                        if (channel[\"state\"] !== 1) {\n                            throw new Error(\"the channel is closed\");\n                        }\n                        const write = record.writers[record.counter++ % record.writers.length];\n                        await Promise.resolve(write(\"send\", data, channelId));\n                    }\n                },\n            },\n            close: {\n                configurable: true,\n                writable: true,\n                value: (err = null) => {\n                    const record = channelStore.get(channelId);\n                    if (record) {\n                        channelStore.delete(channelId);\n                        const channel = record.channel;\n                        record.writers.forEach(write => {\n                            write(\"close\", err, channelId);\n                        });\n                        // recover to the original methods\n                        Object.defineProperties(channel, {\n                            send: {\n                                configurable: true,\n                                writable: true,\n                                value: record.raw.send,\n                            },\n                            close: {\n                                configurable: true,\n                                writable: true,\n                                value: record.raw.close,\n                            },\n                        });\n                        channel.close(err);\n                    }\n                },\n            },\n        });\n    }\n    else {\n        const record = channelStore.get(channelId);\n        record.writers.push(channelWrite);\n    }\n}\nexport function wrapChannel(channel, channelWrite) {\n    wireChannel(channel, channelWrite);\n    return { \"@@type\": \"Channel\", \"@@id\": channel[id], \"capacity\": channel.capacity };\n}\nexport function unwrapChannel(obj, channelWrite) {\n    var _a, _b;\n    const channelId = obj[\"@@id\"];\n    let channel = (_a = channelStore.get(channelId)) === null || _a === void 0 ? void 0 : _a.channel;\n    if (!channel) {\n        channel = Object.assign(Object.create(Channel.prototype), {\n            [id]: channelId,\n            capacity: (_b = obj.capacity) !== null && _b !== void 0 ? _b : 0,\n            buffer: [],\n            producers: [],\n            consumers: [],\n            error: null,\n            state: 1,\n        });\n    }\n    wireChannel(channel, channelWrite);\n    return channel;\n}\n//# sourceMappingURL=channel.js.map"],"names":[],"mappings":"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"}