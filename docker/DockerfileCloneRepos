# syntax=docker/dockerfile:1
FROM ubuntu:22.04

# Install git, openssh, and build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    openssh-client \
    ca-certificates \
    curl \
    build-essential \
    gcc \
    pkg-config \
    libssl-dev \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Verify gcc is installed
RUN gcc --version

# Install Rust and Cargo
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable && \
    rustup component add rustfmt

# Install sqlx-cli
RUN cargo install sqlx-cli --no-default-features --features postgres

# Copy the user's SSH configuration & keys into the image
# WARNING: This embeds your private keys in the resulting image. Use only in trusted environments.
COPY .ssh /root/.ssh
RUN chmod 700 /root/.ssh && \
    chmod 600 /root/.ssh/* && \
    touch /root/.ssh/known_hosts && \
    ssh-keyscan github.com >> /root/.ssh/known_hosts

# Optionally disable strict host key checking (uncomment if needed)
# ENV GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=accept-new"

# Clone the required repositories
WORKDIR /opt
RUN git clone git@github.com:windmill-labs/windmill.git && \
    git clone git@github.com:windmill-labs/windmill-ee-private.git

# Default workdir
WORKDIR /opt/windmill

CMD ["bash"] 