# DockerfileExtra - Combined Windmill Extra Services
#
# This image combines three optional Windmill services:
# - LSP (Language Server Protocol) - Port 3001
# - Multiplayer (y-websocket) - Port 3002
# - Debugger (DAP WebSocket) - Port 5679
#
# Each service can be enabled/disabled via environment variables:
# - ENABLE_LSP=true (default: true)
# - ENABLE_MULTIPLAYER=true (default: true)
# - ENABLE_DEBUGGER=true (default: true)
#
# Build:
#   docker build -f docker/DockerfileExtra -t windmill-extra .
#
# Run:
#   docker run -p 3001:3001 -p 3002:3002 -p 5679:5679 windmill-extra

# ============================================================================
# Stage 1: Build slim base image
# ============================================================================
ARG DEBIAN_IMAGE=debian:bookworm-slim

FROM ${DEBIAN_IMAGE} AS slim-base

ARG APP=/usr/src/app
ARG LATEST_STABLE_PY=3.11.10

# UV configuration
ENV UV_CACHE_DIR=/tmp/windmill/cache/uv
ENV UV_PYTHON_INSTALL_DIR=/tmp/windmill/cache/py_runtime
ENV UV_PYTHON_PREFERENCE=only-managed
RUN mkdir -p /usr/local/uv
ENV UV_TOOL_BIN_DIR=/usr/local/bin
ENV UV_TOOL_DIR=/usr/local/uv
ENV PATH=/usr/local/bin:/root/.local/bin:/tmp/.local/bin:$PATH

# Install system dependencies
RUN apt-get update \
    && apt-get install -y ca-certificates wget curl git jq unzip unixodbc xmlsec1 \
    && rm -rf /var/lib/apt/lists/*

ENV TZ=Etc/UTC

# Install UV
RUN curl --proto '=https' --tlsv1.2 -LsSf https://github.com/astral-sh/uv/releases/download/0.6.2/uv-installer.sh | sh && mv /root/.local/bin/uv /usr/local/bin/uv

# Preinstall python runtime to temp location (will copy with world-writable perms later)
RUN UV_PYTHON_INSTALL_DIR=/tmp/build_cache/py_runtime uv python install $LATEST_STABLE_PY

# Copy to final location with world-writable permissions for arbitrary UID support
RUN mkdir -p /tmp/windmill/cache && \
    cp -r /tmp/build_cache/* /tmp/windmill/cache/ && \
    chmod -R a+rw /tmp/windmill/cache && \
    rm -rf /tmp/build_cache && \
    mkdir -p -m 777 /tmp/windmill/cache/uv

COPY --from=oven/bun:1.2.23 /usr/local/bin/bun /usr/bin/bun

# add the docker client to call docker from a worker if enabled
COPY --from=docker:dind /usr/local/bin/docker /usr/local/bin/

WORKDIR ${APP}

COPY --from=ghcr.io/windmill-labs/windmill:dev --chmod=755 ${APP}/windmill ${APP}/windmill

RUN ln -s ${APP}/windmill /usr/local/bin/windmill

COPY ./frontend/src/lib/hubPaths.json ${APP}/hubPaths.json

# Cache step may fail on some platforms (e.g., ARM64 with 16k pages due to jemalloc)
RUN windmill cache ${APP}/hubPaths.json || echo "Skipping cache prebake (platform not supported)"

RUN rm ${APP}/hubPaths.json

# Create directories and make world-accessible for arbitrary UID support
RUN mkdir -p -m 777 /tmp/windmill/logs /tmp/windmill/search /tmp/.cache && \
    chmod 777 /tmp/.cache && \
    find ${APP} /tmp/windmill -type d -exec chmod 777 {} +

# ============================================================================
# Stage 2: Get nsjail from the nsjail image
# ============================================================================
FROM ghcr.io/windmill-labs/windmill-ee-nsjail:main AS nsjail-source

# ============================================================================
# Stage 3: Build final extra services image
# ============================================================================
FROM slim-base AS final

ARG APP=/usr/src/app

# Install Node.js 22 (needed for LSP and multiplayer)
RUN apt-get update && apt-get install -y --no-install-recommends \
    gnupg \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install additional system dependencies
# - shellcheck: for bash LSP
# - libprotobuf-dev, libnl-route-3-dev: for nsjail runtime
RUN apt-get update && apt-get install -y --no-install-recommends \
    shellcheck \
    libprotobuf-dev \
    libnl-route-3-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Go for gopls (Go LSP)
RUN set -eux; \
    arch="$(dpkg --print-architecture)"; arch="${arch##*-}"; \
    case "$arch" in \
    'amd64') targz='go1.21.13.linux-amd64.tar.gz' ;; \
    'arm64') targz='go1.21.13.linux-arm64.tar.gz' ;; \
    'armhf') targz='go1.21.13.linux-armv6l.tar.gz' ;; \
    *) echo >&2 "error: unsupported architecture '$arch'"; exit 1 ;; \
    esac; \
    wget "https://golang.org/dl/$targz" -nv && tar -C /usr/local -xzf "$targz" && rm "$targz"

ENV PATH="${PATH}:/usr/local/go/bin"
ENV GOBIN=/usr/local/go/bin

# Install gopls for Go LSP
RUN /usr/local/go/bin/go install -v golang.org/x/tools/gopls@latest

# Copy Deno for Deno LSP
COPY --from=denoland/deno:2.2.1 --chmod=755 /usr/bin/deno /usr/bin/deno

# Copy nsjail from nsjail image (for sandboxed debugging)
COPY --from=nsjail-source /bin/nsjail /bin/nsjail

# ============================================================================
# LSP Setup
# ============================================================================

ENV PIPENV_VENV_IN_PROJECT=1
ENV XDG_CACHE_HOME=/pyls/.cache

# Install Python packages for LSP using uv
RUN uv pip install --system --break-system-packages pipenv tornado python-lsp-jsonrpc ruff Cython

# Install Node-based language servers
RUN npm install -g diagnostic-languageserver pyright

# Setup LSP working directory
WORKDIR /pyls
COPY lsp/Pipfile .
RUN pipenv install
COPY lsp/pyls_launcher.py .

# Setup Monaco temp directory for LSP
RUN mkdir -p /tmp/monaco && chmod -R 777 /tmp/monaco
RUN cd /tmp/monaco && npm install --save-dev windmill-client

RUN mkdir -p /pyls/.cache

# ============================================================================
# Debugger Setup
# ============================================================================

WORKDIR /debugger

# Copy debugger files
COPY debugger/dap_debug_service.ts .
COPY debugger/dap_websocket_server_bun.ts .
COPY debugger/dap_websocket_server.py .

# Install Python debugger dependencies using uv
RUN uv pip install --system --break-system-packages websockets debugpy

# ============================================================================
# Multiplayer Setup (y-websocket with connection logging)
# ============================================================================

WORKDIR /multiplayer

# Copy multiplayer server files
COPY multiplayer/package.json .
COPY multiplayer/server.mjs .

# Install dependencies
RUN npm install

# ============================================================================
# Entrypoint Setup
# ============================================================================

WORKDIR /app

# Copy entrypoint script
COPY docker/entrypoint-extra.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Set permissions
RUN chmod -R a+rX /usr/local && \
    chmod -R a+rX /pyls && \
    chmod -R a+rX /debugger

# Expose all service ports
EXPOSE 3001 3002 5679

# Environment variables for service control
ENV ENABLE_LSP=true
ENV ENABLE_MULTIPLAYER=true
ENV ENABLE_DEBUGGER=true
# nsjail sandboxing for debugger (requires --privileged, off by default)
ENV ENABLE_NSJAIL=false

# LSP port
ENV LSP_PORT=3001

# Multiplayer port and host
ENV MULTIPLAYER_PORT=3002
ENV HOST=0.0.0.0

# Debugger port
ENV DEBUGGER_PORT=5679

# Windmill base URL for debugger token verification
ENV WINDMILL_BASE_URL=""
ENV BASE_INTERNAL_URL=""

ENTRYPOINT ["/entrypoint.sh"]
