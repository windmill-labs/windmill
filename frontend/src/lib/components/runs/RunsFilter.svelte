<script lang="ts">
	import { Button } from '../common'
	import ToggleButton from '../common/toggleButton-v2/ToggleButton.svelte'
	import ToggleButtonGroup from '../common/toggleButton-v2/ToggleButtonGroup.svelte'
	import Tooltip from '../Tooltip.svelte'
	import { CircleAlert, CircleCheck, Hourglass, ListFilterPlus, CirclePlay, X } from 'lucide-svelte'
	import JsonEditor from '../JsonEditor.svelte'
	import Toggle from '../Toggle.svelte'
	import Label from '../Label.svelte'
	import Section from '../Section.svelte'
	import { enterpriseLicense, workspaceStore } from '$lib/stores'
	import { createEventDispatcher, untrack } from 'svelte'
	import ToggleButtonMore from '../common/toggleButton-v2/ToggleButtonMore.svelte'
	import Popover from '$lib/components/meltComponents/Popover.svelte'
	import Select from '../select/Select.svelte'
	import { safeSelectItems } from '../select/utils.svelte'
	import RunOption from './RunOption.svelte'
	import DropownSelect from '../DropownSelect.svelte'
	import TooltipV2 from '$lib/components/meltComponents/Tooltip.svelte'

	interface Props {
		// Filters
		path?: string | null
		label?: string | null
		concurrencyKey?: string | null
		worker?: string | null
		tag?: string | null
		success?: 'running' | 'waiting' | 'suspended' | 'queued' | 'success' | 'failure' | undefined
		isSkipped?: boolean | undefined
		argFilter: string
		argError: string
		resultFilter: string
		resultError: string
		jobKindsCat: string
		user?: string | null
		folder?: string | null
		mobile?: boolean
		schedulePath: string | undefined
		allowWildcards?: boolean
		// Autocomplete data
		paths?: string[]
		usernames?: string[]
		folders?: string[]
		allWorkspaces?: boolean
		filterBy?:
			| 'path'
			| 'user'
			| 'folder'
			| 'label'
			| 'concurrencyKey'
			| 'worker'
			| 'tag'
			| 'schedulePath'
		small?: boolean
		calendarSmall?: boolean
	}

	let {
		path = $bindable(null),
		label = $bindable(null),
		concurrencyKey = $bindable(null),
		worker = $bindable(null),
		tag = $bindable(null),
		success = $bindable(undefined),
		isSkipped = $bindable(undefined),
		argFilter = $bindable(),
		argError = $bindable(),
		resultFilter = $bindable(),
		resultError = $bindable(),
		jobKindsCat = $bindable(),
		user = $bindable(null),
		folder = $bindable(null),
		mobile = false,
		schedulePath = $bindable(),
		allowWildcards = $bindable(false),
		paths = [],
		usernames = [],
		folders = [],
		allWorkspaces = $bindable(false),
		filterBy = $bindable('path'),
		small = false,
		calendarSmall = false
	}: Props = $props()

	let copyArgFilter = $state(argFilter)
	let copyResultFilter = $state(resultFilter)

	const dispatch = createEventDispatcher()

	function autosetFilter() {
		if (path !== null && path !== '' && filterBy !== 'path') {
			filterBy = 'path'
		} else if (user !== null && user !== '' && filterBy !== 'user') {
			filterBy = 'user'
		} else if (folder !== null && folder !== '' && filterBy !== 'folder') {
			filterBy = 'folder'
		} else if (label !== null && label !== '' && filterBy !== 'label') {
			filterBy = 'label'
		} else if (concurrencyKey !== null && concurrencyKey !== '' && filterBy !== 'concurrencyKey') {
			filterBy = 'concurrencyKey'
		} else if (tag !== null && tag !== '' && filterBy !== 'tag') {
			filterBy = 'tag'
		} else if (schedulePath !== undefined && schedulePath !== '' && filterBy !== 'schedulePath') {
			filterBy = 'schedulePath'
		} else if (worker !== null && worker !== '' && filterBy !== 'worker') {
			filterBy = 'worker'
		}
	}

	let labelTimeout: NodeJS.Timeout | undefined = $state(undefined)
	let concurrencyKeyTimeout: NodeJS.Timeout | undefined = $state(undefined)
	let tagTimeout: NodeJS.Timeout | undefined = $state(undefined)
	let workerTimeout: NodeJS.Timeout | undefined = $state(undefined)

	let allWorkspacesValue = $state(allWorkspaces ? 'all' : 'admins')
	let displayedLabel = $derived(label)
	let displayedConcurrencyKey = $derived(concurrencyKey)
	let displayedTag = $derived(tag)
	let displayedSchedule = $derived(schedulePath)
	let displayedWorker = $derived(worker)
	$effect(() => {
		;(path || user || folder || label || worker || concurrencyKey || tag || schedulePath) &&
			untrack(() => autosetFilter())
	})

	function resetFilter() {
		path = null
		user = null
		folder = null
		label = null
		concurrencyKey = null
		tag = null
		schedulePath = undefined
		worker = null
	}
</script>

{#snippet runsTooltip()}
	<TooltipV2 placement="right">
		{#snippet text()}
			'Runs are jobs that have no parent jobs (flows are jobs that are parent of the jobs they
			start), they have been triggered through the UI, a schedule or webhook'
		{/snippet}
	</TooltipV2>
{/snippet}
{#snippet previewsTooltip()}
	<TooltipV2 placement="right">
		{#snippet text()}
			'Previews are jobs that have been started in the editor as "Tests"'
		{/snippet}
	</TooltipV2>
{/snippet}
{#snippet dependenciesTooltip()}
	<TooltipV2 placement="right">
		{#snippet text()}
			'Deploying a script, flow or an app launch a dependency job that create and then attach the
			lockfile to the deployed item. This mechanism ensure that logic is always executed with the
			exact same direct and indirect dependencies.'
		{/snippet}
	</TooltipV2>
{/snippet}
{#snippet syncTooltip()}
	<TooltipV2 placement="right">
		{#snippet text()}
			'Sync jobs that are triggered on every script deployment to sync the workspace with the Git
			repository configured in the the workspace settings'
		{/snippet}
	</TooltipV2>
{/snippet}

{#if !mobile}
	{#if $workspaceStore == 'admins'}
		<RunOption label="Workspaces" for="workspaces">
			<ToggleButtonGroup
				bind:selected={allWorkspacesValue}
				on:selected={({ detail }) => (allWorkspaces = detail === 'all')}
			>
				{#snippet children({ item })}
					<ToggleButton value={'admins'} label="Admins" {item} />
					<ToggleButton value={'all'} label="All" {item} />
				{/snippet}
			</ToggleButtonGroup>
		</RunOption>
	{/if}
	<!-- Filter by -->
	<div class="flex flex-row gap-1">
		<RunOption label="Filter by" for="filter-by">
			<ToggleButtonGroup
				bind:selected={filterBy}
				on:selected={(e) => {
					if (e.detail != filterBy) {
						resetFilter()
					}
				}}
			>
				{#snippet children({ item })}
					<ToggleButton value="path" label="Path" {item} />
					<ToggleButton value="user" label="User" {item} />
					<ToggleButton value="folder" label="Folder" {item} />
					<ToggleButtonMore
						togglableItems={[
							{ label: 'Schedule path', value: 'schedulePath' },
							{ label: 'Concurrency key', value: 'concurrencyKey' },
							{ label: 'Label', value: 'label' },
							{ label: 'Tag', value: 'tag' },
							{ label: 'Worker', value: 'worker' }
						]}
						{item}
						bind:selected={filterBy}
						onSelected={(v) => resetFilter()}
					/>
				{/snippet}
			</ToggleButtonGroup>
		</RunOption>

		{#if filterBy == 'user'}
			{#key user}
				<RunOption label="User" for="user">
					<Select
						items={safeSelectItems(usernames)}
						bind:value={() => user ?? undefined, (v) => (user = v ?? null)}
						clearable
						onClear={() => ((user = null), dispatch('reset'))}
						inputClass="!h-[32px] min-w-36"
						onCreateItem={(item) => (usernames.push(item), (user = item))}
						createText="Press enter to use this value"
						id="user"
					/>
				</RunOption>
			{/key}
		{:else if filterBy == 'folder'}
			<RunOption label="Folder" for="folder">
				{#key folder}
					<Select
						items={safeSelectItems(folders)}
						bind:value={() => folder ?? undefined, (v) => (folder = v ?? null)}
						clearable
						onClear={() => ((folder = null), dispatch('reset'))}
						inputClass="!h-[32px] min-w-36"
						id="folder"
					/>
				{/key}
			</RunOption>
		{:else if filterBy === 'path'}
			<RunOption label="Path" for="path">
				{#key path}
					<Select
						items={safeSelectItems(paths)}
						bind:value={() => path ?? undefined, (v) => (path = v ?? null)}
						clearable
						onClear={() => ((path = null), dispatch('reset'))}
						inputClass="!h-[32px] min-w-36"
						onCreateItem={(item) => (paths.push(item), (path = item))}
						createText="Press enter to use this value"
						id="path"
					/>
				{/key}
			</RunOption>
		{:else if filterBy === 'label'}
			<RunOption label="Label" for="label">
				{#snippet tooltip()}
					<a
						href="https://www.windmill.dev/docs/core_concepts/monitor_past_and_future_runs#jobs-labels"
						target="_blank">Job Labels</a
					> are string values in the array at the result field 'wm_labels' to easily filter them.
				{/snippet}
				{#key label}
					<div class="relative">
						{#if label}
							<button
								class="absolute top-2 right-2 z-50"
								onclick={() => {
									label = null
									dispatch('reset')
								}}
							>
								<X size={14} />
							</button>
						{/if}

						<!-- svelte-ignore a11y_autofocus -->
						<input
							autofocus
							type="text"
							class="!h-[32px] py-1 !text-xs min-w-36"
							bind:value={displayedLabel}
							onkeydown={(e) => {
								if (labelTimeout) {
									clearTimeout(labelTimeout)
								}

								labelTimeout = setTimeout(() => {
									label = displayedLabel
								}, 1000)
							}}
						/>
						<div class="absolute -top-4 right-0">
							<Toggle
								bind:checked={allowWildcards}
								size="2xs"
								options={{ right: '(*)', title: 'allow wildcards (*)' }}
							></Toggle>
						</div>
					</div>
				{/key}
			</RunOption>
		{:else if filterBy === 'concurrencyKey'}
			<RunOption label="Concurrency Key" for="concurrencyKey">
				{#snippet tooltip()}
					For concurrency limited jobs, the concurrency key defines a group of jobs that share the
					same limits.
					{#if !$enterpriseLicense}
						Concurrency limits are an EE feature.
					{/if}
				{/snippet}
				{#key concurrencyKey}
					{#if concurrencyKey}
						<button
							class="absolute top-2 right-2 z-50"
							onclick={() => {
								concurrencyKey = null
								dispatch('reset')
							}}
						>
							<X size={14} />
						</button>
					{/if}

					<!-- svelte-ignore a11y_autofocus -->
					<input
						autofocus
						type="text"
						class="!h-[32px] py-1 !text-xs min-w-36"
						bind:value={displayedConcurrencyKey}
						onkeydown={(e) => {
							if (concurrencyKeyTimeout) {
								clearTimeout(concurrencyKeyTimeout)
							}

							concurrencyKeyTimeout = setTimeout(() => {
								concurrencyKey = displayedConcurrencyKey
							}, 1000)
						}}
						id="concurrencyKey"
					/>
				{/key}
			</RunOption>
		{:else if filterBy === 'tag'}
			<RunOption label="Tag" for="tag">
				{#key tag}
					<div class="relative">
						{#if tag}
							<button
								class="absolute top-2 right-2 z-50"
								onclick={() => {
									tag = null
									dispatch('reset')
								}}
							>
								<X size={14} />
							</button>
						{/if}

						<!-- svelte-ignore a11y_autofocus -->
						<input
							autofocus
							type="text"
							class="!h-[32px] py-1 !text-xs min-w-36"
							bind:value={displayedTag}
							onkeydown={(e) => {
								if (tagTimeout) {
									clearTimeout(tagTimeout)
								}

								tagTimeout = setTimeout(() => {
									tag = displayedTag
								}, 1000)
							}}
							id="tag"
						/>
						<div class="absolute -top-4 right-0">
							<Toggle
								bind:checked={allowWildcards}
								size="2xs"
								options={{ right: 'wildcards (*)', title: 'allow wildcards (*)' }}
							></Toggle>
						</div>
					</div>
				{/key}
			</RunOption>
		{:else if filterBy === 'schedulePath'}
			<RunOption label="Schedule Path" for="schedulePath">
				{#key tag}
					<div class="relative">
						{#if tag}
							<button
								class="absolute top-2 right-2 z-50"
								onclick={() => {
									schedulePath = undefined
									dispatch('reset')
								}}
							>
								<X size={14} />
							</button>
						{/if}

						<!-- svelte-ignore a11y_autofocus -->
						<input
							autofocus
							type="text"
							class="!h-[32px] py-1 !text-xs min-w-36"
							bind:value={displayedSchedule}
							onkeydown={(e) => {
								if (tagTimeout) {
									clearTimeout(tagTimeout)
								}

								tagTimeout = setTimeout(() => {
									schedulePath = displayedSchedule
								}, 1000)
							}}
							id="schedulePath"
						/>
					</div>
				{/key}
			</RunOption>
		{:else if filterBy === 'worker'}
			<RunOption label="Worker" for="worker">
				{#key worker}
					<div class="relative">
						{#if worker}
							<button
								class="absolute top-2 right-2 z-50"
								onclick={() => {
									worker = null
									dispatch('reset')
								}}
							>
								<X size={14} />
							</button>
						{/if}

						<!-- svelte-ignore a11y_autofocus -->
						<input
							autofocus
							type="text"
							class="!h-[32px] py-1 !text-xs min-w-36"
							bind:value={displayedWorker}
							onkeydown={(e) => {
								if (workerTimeout) {
									clearTimeout(workerTimeout)
								}

								workerTimeout = setTimeout(() => {
									worker = displayedWorker
								}, 1000)
							}}
							id="worker"
						/>
						<div class="absolute -top-4 right-0">
							<Toggle
								bind:checked={allowWildcards}
								size="2xs"
								options={{ right: 'wildcards (*)', title: 'allow wildcards (*)' }}
							></Toggle>
						</div>
					</div>
				{/key}
			</RunOption>
		{/if}
	</div>

	<!-- Kind -->
	<RunOption label="Kind" for="kind">
		{#if small && !calendarSmall}
			<DropownSelect
				btnClasses="min-w-24"
				items={[
					{
						displayName: 'All',
						action: () => {
							jobKindsCat = 'all'
						},
						id: 'all'
					},
					{
						displayName: 'Runs',
						action: () => {
							jobKindsCat = 'runs'
						},
						id: 'runs',
						extra: runsTooltip
					},
					{
						displayName: 'Previews',
						action: () => {
							jobKindsCat = 'previews'
						},
						id: 'previews',
						extra: previewsTooltip
					},
					{
						displayName: 'Deps',
						action: () => {
							jobKindsCat = 'dependencies'
						},
						id: 'dependencies',
						extra: dependenciesTooltip
					},
					{
						displayName: 'Sync',
						action: () => {
							jobKindsCat = 'deploymentcallbacks'
						},
						id: 'deploymentcallbacks',
						extra: syncTooltip
					}
				]}
				selected={jobKindsCat}
			/>
		{:else}
			<ToggleButtonGroup bind:selected={jobKindsCat}>
				{#snippet children({ item })}
					<ToggleButton value="all" label="All" {item} />
					<ToggleButton
						value="runs"
						label="Runs"
						showTooltipIcon
						tooltip="Runs are jobs that have no parent jobs (flows are jobs that are parent of the jobs they start), they have been triggered through the UI, a schedule or webhook"
						{item}
					/>
					<ToggleButton
						value="previews"
						label="Previews"
						showTooltipIcon
						tooltip="Previews are jobs that have been started in the editor as 'Tests'"
						{item}
					/>
					<ToggleButton
						value="dependencies"
						label="Deps"
						showTooltipIcon
						tooltip="Deploying a script, flow or an app launch a dependency job that create and then attach the lockfile to the deployed item. This mechanism ensure that logic is always executed with the exact same direct and indirect dependencies."
						{item}
					/>
					<ToggleButton
						value="deploymentcallbacks"
						label="Sync"
						showTooltipIcon
						tooltip="Sync jobs that are triggered on every script deployment to sync the workspace with the Git repository configured in the the workspace settings"
						{item}
					/>
				{/snippet}
			</ToggleButtonGroup>
		{/if}
	</RunOption>
	<!-- Status -->
	<RunOption label="Status" for="status">
		<ToggleButtonGroup
			selected={success ?? 'all'}
			on:selected={({ detail }) => {
				success = detail === 'all' ? undefined : detail
				dispatch('successChange', success)
			}}
			id="status"
		>
			{#snippet children({ item })}
				<ToggleButton value={'all'} label="All" {item} />
				<ToggleButton
					value={'running'}
					tooltip="Running"
					class="whitespace-nowrap"
					icon={CirclePlay}
					iconProps={{ color: success === 'running' ? 'blue' : 'gray' }}
					{item}
				/>
				<ToggleButton
					value={'success'}
					tooltip="Success"
					class="whitespace-nowrap"
					icon={CircleCheck}
					iconProps={{ color: success === 'success' ? 'green' : 'gray' }}
					{item}
				/>
				<ToggleButton
					value={'failure'}
					tooltip="Failure"
					class="whitespace-nowrap"
					icon={CircleAlert}
					iconProps={{ color: success === 'failure' ? 'red' : 'gray' }}
					{item}
				/>
				{#if success == 'waiting'}
					<ToggleButton
						value={'waiting'}
						tooltip="Waiting"
						class="whitespace-nowrap"
						icon={Hourglass}
						iconProps={{ color: 'blue' }}
						{item}
					/>
				{:else if success == 'suspended'}
					<ToggleButton
						value={'suspended'}
						tooltip="Suspended"
						class="whitespace-nowrap"
						icon={Hourglass}
						iconProps={{ color: 'blue' }}
						{item}
					/>
				{/if}
			{/snippet}
		</ToggleButtonGroup>
	</RunOption>
{/if}

<RunOption label="_" for="more-filters" noLabel>
	<Popover
		floatingConfig={{ strategy: 'absolute', placement: 'bottom-end' }}
		contentClasses="p-4"
		closeButton
		usePointerDownOutside
	>
		{#snippet trigger()}
			<Button
				color="light"
				variant="border"
				size="xs"
				nonCaptureEvent={true}
				startIcon={{ icon: ListFilterPlus }}
				iconOnly
			></Button>
		{/snippet}

		{#snippet content()}
			<Section label="Filters">
				<div class="w-102 flex flex-col gap-4">
					{#if mobile}
						{#if $workspaceStore == 'admins'}
							<Label label="Workspaces">
								<ToggleButtonGroup
									bind:selected={allWorkspacesValue}
									on:selected={({ detail }) => (allWorkspaces = detail === 'all')}
								>
									{#snippet children({ item })}
										<ToggleButton value={'admins'} label="Admins" {item} />
										<ToggleButton value={'all'} label="All" {item} />
									{/snippet}
								</ToggleButtonGroup>
							</Label>
						{/if}
						<Label label="Filter by">
							<ToggleButtonGroup
								bind:selected={filterBy}
								on:selected={(e) => {
									if (e.detail != filterBy) {
										path = null
										user = null
										folder = null
										label = null
										concurrencyKey = null
										tag = null
										schedulePath = undefined
									}
								}}
							>
								{#snippet children({ item })}
									<ToggleButton value="path" label="Path" {item} />
									<ToggleButton value="user" label="User" {item} />
									<ToggleButton value="folder" label="Folder" {item} />
									<ToggleButton value="schedulePath" label="Schedule" {item} />
									<ToggleButton value="concurrencyKey" label="Concurrency" {item} />
									<ToggleButton value="tag" label="Tag" {item} />
									<ToggleButton value="label" label="Label" {item} />
									<ToggleButton value="worker" label="Worker" {item} />
								{/snippet}
							</ToggleButtonGroup>
						</Label>

						{#if filterBy == 'user'}
							<Label label="User">
								<Select
									disablePortal
									items={safeSelectItems(usernames)}
									bind:value={() => user ?? undefined, (v) => (user = v ?? null)}
									clearable
									onClear={() => ((user = null), dispatch('reset'))}
									inputClass="!h-[32px]"
								/>
							</Label>
						{:else if filterBy == 'folder'}
							<Label label="Folder">
								<Select
									disablePortal
									items={safeSelectItems(folders)}
									bind:value={() => folder ?? undefined, (v) => (folder = v ?? null)}
									clearable
									onClear={() => ((folder = null), dispatch('reset'))}
									inputClass="!h-[32px]"
								/>
							</Label>
						{:else if filterBy === 'path'}
							<Label label="Path">
								<Select
									disablePortal
									items={safeSelectItems(paths)}
									bind:value={() => path ?? undefined, (v) => (path = v ?? null)}
									clearable
									onClear={() => ((path = null), dispatch('reset'))}
									inputClass="!h-[32px]"
								/>
							</Label>
						{:else if filterBy === 'tag'}
							{#key tag}
								<Label label="Tag">
									<div class="relative w-full">
										{#if tag}
											<button
												class="absolute top-2 right-2 z-50"
												onclick={() => {
													tag = null
												}}
											>
												<X size={14} />
											</button>
										{/if}

										<!-- svelte-ignore a11y_autofocus -->
										<input
											autofocus
											type="text"
											class="!h-[32px] py-1 !text-xs !w-80"
											bind:value={displayedTag}
											onkeydown={(e) => {
												if (tagTimeout) {
													clearTimeout(tagTimeout)
												}

												tagTimeout = setTimeout(() => {
													tag = displayedTag
													console.log(tag)
												}, 1000)
											}}
										/>
									</div></Label
								>
							{/key}
						{:else if filterBy === 'label'}
							{#key label}
								<Label label="Label">
									<div class="relative w-full">
										{#if label}
											<button
												class="absolute top-2 right-2 z-50"
												onclick={() => {
													label = null
												}}
											>
												<X size={14} />
											</button>
										{/if}

										<!-- svelte-ignore a11y_autofocus -->
										<input
											autofocus
											type="text"
											class="!h-[32px] py-1 !text-xs !w-80"
											bind:value={displayedLabel}
											onkeydown={(e) => {
												if (labelTimeout) {
													clearTimeout(labelTimeout)
												}

												labelTimeout = setTimeout(() => {
													label = displayedLabel
												}, 1000)
											}}
										/>
									</div></Label
								>
							{/key}
						{:else if filterBy === 'concurrencyKey'}
							{#key concurrencyKey}
								<Label label="Concurrency key">
									<div class="relative w-full">
										{#if concurrencyKey}
											<button
												class="absolute top-2 right-2 z-50"
												onclick={() => {
													concurrencyKey = null
													// dispatch('reset')
												}}
											>
												<X size={14} />
											</button>
										{/if}

										<!-- svelte-ignore a11y_autofocus -->
										<input
											autofocus
											type="text"
											class="!h-[32px] py-1 !text-xs !w-80"
											bind:value={displayedConcurrencyKey}
											onkeydown={(e) => {
												if (concurrencyKeyTimeout) {
													clearTimeout(concurrencyKeyTimeout)
												}

												concurrencyKeyTimeout = setTimeout(() => {
													concurrencyKey = displayedConcurrencyKey
												}, 1000)
											}}
										/>
									</div>
								</Label>
							{/key}
						{:else if filterBy === 'worker'}
							{#key worker}
								<Label label="worker">
									<div class="relative w-full">
										{#if concurrencyKey}
											<button
												class="absolute top-2 right-2 z-50"
												onclick={() => {
													worker = null
													// dispatch('reset')
												}}
											>
												<X size={14} />
											</button>
										{/if}

										<!-- svelte-ignore a11y_autofocus -->
										<input
											autofocus
											type="text"
											class="!h-[32px] py-1 !text-xs !w-80"
											bind:value={displayedWorker}
											onkeydown={(e) => {
												if (workerTimeout) {
													clearTimeout(workerTimeout)
												}

												workerTimeout = setTimeout(() => {
													worker = displayedWorker
												}, 1000)
											}}
										/>
									</div>
								</Label>
							{/key}
						{/if}

						{#if filterBy === 'tag' || filterBy === 'label' || filterBy === 'worker'}
							<Toggle
								bind:checked={allowWildcards}
								size="2xs"
								options={{ right: 'wildcards (*)', title: 'allow wildcards (*)' }}
							></Toggle>
						{/if}
						<Label label="Kind">
							<ToggleButtonGroup bind:selected={jobKindsCat}>
								{#snippet children({ item })}
									<ToggleButton value="all" label="All" {item} />
									<ToggleButton
										value="runs"
										label="Runs"
										showTooltipIcon
										tooltip="Runs are jobs that have no parent jobs (flows are jobs that are parent of the jobs they start), they have been triggered through the UI, a schedule or webhook"
										{item}
									/>
									<ToggleButton
										value="previews"
										label="Previews"
										showTooltipIcon
										tooltip="Previews are jobs that have been started in the editor as 'Tests'"
										{item}
									/>
									<ToggleButton
										value="dependencies"
										label="Deps"
										showTooltipIcon
										tooltip="Deploying a script, flow or an app launch a dependency job that create and then attach the lockfile to the deployed item. This mechanism ensure that logic is always executed with the exact same direct and indirect dependencies."
										{item}
									/>
									<ToggleButton
										value="deploymentcallbacks"
										label="Sync"
										showTooltipIcon
										tooltip="Sync jobs that are triggered on every script deployment to sync the workspace with the Git repository configured in the the workspace settings"
										{item}
									/>
								{/snippet}
							</ToggleButtonGroup>
						</Label>

						<Label label="Status">
							<ToggleButtonGroup
								selected={success ?? 'all'}
								on:selected={({ detail }) => (success = detail === 'all' ? undefined : detail)}
							>
								{#snippet children({ item })}
									<ToggleButton value={'all'} label="All" {item} />
									<ToggleButton
										value={'running'}
										label="Running"
										class="whitespace-nowrap"
										{item}
									/>
									<ToggleButton
										value={'success'}
										label="Success"
										class="whitespace-nowrap"
										{item}
									/>
									<ToggleButton
										value={'failure'}
										label="Failure"
										class="whitespace-nowrap"
										{item}
									/>
								{/snippet}
							</ToggleButtonGroup>
						</Label>
					{/if}

					<Label label="Show skipped flows">
						<div class="flex flex-row gap-1 items-center">
							<Toggle size="xs" bind:checked={isSkipped} />
							<Tooltip>Skipped flows are flows that did an early break</Tooltip>
						</div>
					</Label>

					<div class="flex flex-col gap-1">
						<span class="text-xs leading-6">
							{`Filter by a json being a subset of the args/result. Try '\{"foo": "bar"\}'`}
						</span>
						<Label label="Filter by args">
							<JsonEditor bind:error={argError} bind:code={copyArgFilter} />
						</Label>
						<Label label="Filter by result">
							<JsonEditor bind:error={resultError} bind:code={copyResultFilter} />
						</Label>
					</div>

					<div class="flex flex-row gap-2 justify-between">
						<Button
							size="xs"
							color="light"
							on:click={() => {
								argFilter = ''
								resultFilter = ''
							}}
						>
							Clear
						</Button>

						<Button
							size="xs"
							color="dark"
							on:click={() => {
								argFilter = copyArgFilter
								resultFilter = copyResultFilter
							}}
						>
							Set args/result filter
						</Button>
					</div>
				</div>
			</Section>
		{/snippet}
	</Popover>
</RunOption>
