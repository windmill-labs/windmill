<script lang="ts">
	import Section from '$lib/components/Section.svelte'
	import CaptureSection, { type CaptureInfo } from '../CaptureSection.svelte'
	import CaptureTable from '../CaptureTable.svelte'
	import Required from '$lib/components/Required.svelte'
	import ResourcePicker from '$lib/components/ResourcePicker.svelte'
	import { copyToClipboard, emptyStringTrimmed } from '$lib/utils'
	import TestTriggerConnection from '../TestTriggerConnection.svelte'
	import Subsection from '$lib/components/Subsection.svelte'
	import {
		GcpTriggerService,
		type DeliveryType,
		type PushConfig,
		type SubscriptionMode
	} from '$lib/gen'
	import ToggleButtonGroup from '$lib/components/common/toggleButton-v2/ToggleButtonGroup.svelte'
	import ToggleButton from '$lib/components/common/toggleButton-v2/ToggleButton.svelte'
	import Label from '$lib/components/Label.svelte'
	import ClipboardPanel from '$lib/components/details/ClipboardPanel.svelte'
	import { base } from '$lib/base'
	import Toggle from '$lib/components/Toggle.svelte'
	import { SELECT_INPUT_DEFAULT_STYLE } from '$lib/defaults'
	import DarkModeObserver from '$lib/components/DarkModeObserver.svelte'
	import Select from '$lib/components/apps/svelte-select/lib/Select.svelte'
	import { workspaceStore } from '$lib/stores'

	import { Button } from '$lib/components/common'
	import { ClipboardCopy, RefreshCw } from 'lucide-svelte'
	import Alert from '$lib/components/common/alert/Alert.svelte'

	export let can_write: boolean = false
	export let headless: boolean = false
	export let showCapture: boolean = false
	export let captureTable: CaptureTable | undefined = undefined
	export let captureInfo: CaptureInfo | undefined = undefined
	export let isValid: boolean = false
	export let gcp_resource_path = ''
	export let subscription_id = ''
	export let topic_id = ''
	export let delivery_type: DeliveryType | undefined = 'pull'
	export let delivery_config: PushConfig | undefined
	export let subscription_mode: SubscriptionMode = 'create_update'
	export let base_endpoint: string = getBaseUrl(captureInfo)
	export let path = captureInfo ? captureInfo.path : ''

	let topic_items: string[] = []
	let subscription_items: string[] = []
	let darkMode = false

	const DEFAULT_PUSH_CONFIG: PushConfig = {
		audience: '',
		authenticate: false,
		base_endpoint
	}

	async function loadAllPubSubTopicsFromProject() {
		if (!emptyStringTrimmed(gcp_resource_path)) {
			topic_items = await GcpTriggerService.listGoogleTopics({
				workspace: $workspaceStore!,
				path: gcp_resource_path
			})
		}
	}

	async function loadAllSubscriptionFromGooglePubSubTopic() {
		if (!emptyStringTrimmed(gcp_resource_path) && !emptyStringTrimmed(topic_id)) {
			subscription_items = await GcpTriggerService.listAllTgoogleTopicSubscriptions({
				workspace: $workspaceStore!,
				path: gcp_resource_path,
				requestBody: {
					topic_id
				}
			})
		}
	}

	export let cloud_subscription_id = ''
	export let create_update_subscription_id = ''

	$: isValid = !emptyStringTrimmed(gcp_resource_path) && !emptyStringTrimmed(topic_id)
	$: if (!delivery_type) {
		delivery_type = 'pull'
	}
	$: if (!delivery_config) {
		delivery_config = DEFAULT_PUSH_CONFIG
	}

	function getBaseUrl(captureInfo: CaptureInfo | undefined) {
		if (captureInfo) {
			return `${location.origin}${base}/api/w/${$workspaceStore}/capture_u/gcp/${
				captureInfo.isFlow ? 'flow' : 'script'
			}`
		} else {
			return `${window.location.origin}${base}/api/gcp/w/${$workspaceStore!}`
		}
	}

	$: !base_endpoint && (base_endpoint = getBaseUrl(captureInfo))
</script>

<DarkModeObserver bind:darkMode />

<div>
	{#if showCapture && captureInfo}
		{@const captureURL = `${base_endpoint}/${path}`}
		<CaptureSection
			captureType="gcp"
			disabled={!isValid}
			{captureInfo}
			on:captureToggle
			on:applyArgs
			on:updateSchema
			on:addPreprocessor
			on:testWithArgs
			bind:captureTable
		>
			{#if delivery_type === 'push'}
				<Label label="URL">
					<ClipboardPanel content={captureURL} disabled={!captureInfo.active} />
				</Label>
			{/if}
		</CaptureSection>
	{/if}
	<Section label="GCP Pub/Sub" {headless}>
		<div class="flex flex-col w-full gap-4">
			<Subsection label="Connection setup">
				<div class="flex flex-col gap-1 mt-2">
					<ResourcePicker
						on:change={() => {
							loadAllPubSubTopicsFromProject()
						}}
						resourceType="gcloud"
						bind:value={gcp_resource_path}
					/>
					{#if !emptyStringTrimmed(gcp_resource_path)}
						<TestTriggerConnection kind="gcp" args={{ gcp_resource_path }} />
					{/if}
				</div>
			</Subsection>

			<div class="flex flex-col gap-1">
				<Subsection
					label="Topic"
					tooltip="Select the Pub/Sub topic that this subscription will be attached to. Messages published to this topic will be delivered to your subscription."
				>
					<div class="flex gap-1 mt-2">
						<Select
							class="grow shrink max-w-full"
							on:change={(e) => {
								topic_id = e.detail.value
								loadAllSubscriptionFromGooglePubSubTopic()
							}}
							on:clear={() => {
								topic_id = ''
							}}
							value={topic_id}
							items={topic_items}
							placeholder="Choose a topic"
							inputStyles={SELECT_INPUT_DEFAULT_STYLE.inputStyles}
							containerStyles={darkMode
								? SELECT_INPUT_DEFAULT_STYLE.containerStylesDark
								: SELECT_INPUT_DEFAULT_STYLE.containerStyles}
							portal={false}
						/>
						<Button
							disabled={!can_write}
							variant="border"
							color="light"
							wrapperClasses="self-stretch"
							on:click={loadAllPubSubTopicsFromProject}
							startIcon={{ icon: RefreshCw }}
							iconOnly
						/>
					</div>
				</Subsection>
			</div>
			{#if !emptyStringTrimmed(gcp_resource_path) && !emptyStringTrimmed(topic_id)}
				<Section
					label="Subscription"
					tooltip="Choose whether to create or update a Pub/Sub subscription, or link an existing one from your Google Cloud project."
					documentationLink="https://www.windmill.dev/docs/core_concepts/gcp_triggers#subscription-setup"
				>
					<div class="flex flex-col gap-3">
						<ToggleButtonGroup
							bind:selected={subscription_mode}
							on:selected={(e) => {
								if (e.detail === 'existing' && subscription_items.length === 0) {
									loadAllSubscriptionFromGooglePubSubTopic()
								}
							}}
							let:item
						>
							<ToggleButton
								label="Create/Update"
								value="create_update"
								tooltip="Create a new subscription or update an existing one with custom settings"
								showTooltipIcon
								{item}
							/>
							<ToggleButton
								label="Existing subscription"
								value="existing"
								tooltip="Select an existing subscription from GCP Pub/Sub"
								showTooltipIcon
								{item}
							/>
						</ToggleButtonGroup>

						{#if subscription_mode === 'create_update'}
							<Subsection
								label="Subscription id"
								tooltip="The unique identifier for the Pub/Sub subscription. Leave it empty to let the system automatically generate a subscription ID, or provide a custom one if needed."
							>
								<div class="mt-2">
									<input
										type="text"
										autocomplete="off"
										placeholder="Enter subscription ID (leave empty to auto-generate)"
										bind:value={create_update_subscription_id}
										on:input={(event) => {
											subscription_id = event?.currentTarget.value
										}}
									/>
								</div>
							</Subsection>
							<div class="flex flex-col gap-2">
								<Subsection
									label="Delivery type"
									tooltip="Select the delivery type for the Pub/Sub subscription. If the subscription already exists and you want to keep it as-is, choose the same delivery type as in Google Cloud. You can switch the type here if the API allows it â€” otherwise, make the change directly in Google Cloud."
								>
									<div class="flex flex-col gap-2 mt-2">
										<ToggleButtonGroup bind:selected={delivery_type} let:item>
											<ToggleButton
												label="Pull"
												tooltip="Create a subscription where your service will pull messages from the queue. Suitable for services that periodically check for new messages."
												value="pull"
												showTooltipIcon
												{item}
											/>
											<ToggleButton
												label="Push"
												tooltip="Windmill will auto-generate a push endpoint for this subscription. You must not modify this endpoint in Google Cloud, as it is managed internally by Windmill."
												showTooltipIcon
												value="push"
												{item}
											/>
										</ToggleButtonGroup>
									</div>
								</Subsection>
								{#if delivery_type === 'push' && delivery_config}
									<div class="flex flex-col gap-3 mt-1">
										<Subsection
											label="URL"
											tooltip="The URL of the service that receives push messages."
										>
											<div class="flex gap-2">
												<input
													type="text"
													autocomplete="off"
													placeholder="URL"
													disabled
													value={`${base_endpoint}/${path}`}
												/>
												<Button
													on:click={() => copyToClipboard(`${base_endpoint}/${path}`)}
													color="dark"
													size="xs"
													startIcon={{ icon: ClipboardCopy }}
												>
													Copy URL
												</Button>
											</div>
										</Subsection>
										<Subsection
											label="Audience"
											tooltip="Provide the expected audience value for verifying OIDC tokens in push requests. If
										left empty, the URL of the endpoint will be used as the default audience"
										>
											<input
												type="text"
												autocomplete="off"
												placeholder="audience"
												bind:value={delivery_config.audience}
												disabled={!can_write}
											/>
										</Subsection>
										<Subsection label="Authenticate">
											<p class="text-xs mb-2 text-tertiary">
												Enable Google Cloud authentication for push delivery using a verified token.<Required
													required={true}
												/>
											</p>
											<Toggle bind:checked={delivery_config.authenticate} />
										</Subsection>
									</div>
								{/if}
							</div>
						{:else if subscription_mode === 'existing'}
							<div class="flex flex-col gap-3">
								<div class="flex gap-1">
									<Select
										class="grow shrink max-w-full"
										on:change={(e) => {
											subscription_id = e.detail.value
											cloud_subscription_id = e.detail.value
										}}
										on:clear={() => {
											subscription_id = ''
										}}
										value={cloud_subscription_id}
										items={subscription_items}
										placeholder="Choose a subscription"
										inputStyles={SELECT_INPUT_DEFAULT_STYLE.inputStyles}
										containerStyles={darkMode
											? SELECT_INPUT_DEFAULT_STYLE.containerStylesDark
											: SELECT_INPUT_DEFAULT_STYLE.containerStyles}
										portal={false}
									/>
									<Button
										disabled={!can_write}
										variant="border"
										color="light"
										wrapperClasses="self-stretch"
										on:click={loadAllSubscriptionFromGooglePubSubTopic}
										startIcon={{ icon: RefreshCw }}
										iconOnly
									/>
								</div>
								<Alert title="Push Subscription URL Requirements" type="warning">
									If the subscription uses <strong>push delivery</strong>, its endpoint URL must
									match the following format: <strong>{base_endpoint}/*</strong>, meaning it must
									start with
									<strong>{base_endpoint}</strong> followed by any path segment.
								</Alert>
							</div>
						{/if}
					</div>
				</Section>
			{/if}
		</div>
	</Section>
</div>
