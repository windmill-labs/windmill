<script lang="ts">
	import { Badge } from '$lib/components/common'
	import { classNames } from '$lib/utils'
	import { getContext } from 'svelte'
	import type { AppEditorContext } from '../../types'
	import PanelSection from '../settingsPanel/common/PanelSection.svelte'
	import { getAppScripts } from './utils'

	export let selectedScriptComponentId: string | undefined = undefined
	const { app, selectedComponent, lazyGrid } = getContext<AppEditorContext>('AppEditorContext')

	function selectInlineScript(id: string) {
		selectedScriptComponentId = id
		if (!id.startsWith('unused-')) {
			$selectedComponent = selectedScriptComponentId
		}
	}

	$: runnables = getAppScripts($lazyGrid)

	// When seleced component changes, update selectedScriptComponentId
	$: {
		if (selectedComponent) {
			selectedScriptComponentId = $selectedComponent
		}
	}
</script>

<div class="min-h-full flex flex-col gap-4">
	<PanelSection title="Inline scripts" smallPadding>
		<div class="flex flex-col gap-2 w-full">
			{#if runnables.inline.length > 0}
				<div class="flex gap-2 flex-col ">
					{#each runnables.inline as { name, id }, index (index)}
						<!-- svelte-ignore a11y-click-events-have-key-events -->
						<div
							class="{classNames(
								'border flex  gap-1 truncate justify-between flex-row w-full items-center p-2 rounded-sm cursor-pointer hover:bg-blue-50 hover:text-blue-400',
								selectedScriptComponentId === id ? 'border-blue-500 border' : ''
							)},"
							on:click={() => selectInlineScript(id)}
						>
							<span class="text-xs truncate">{name}</span>
							<div>
								<Badge color="dark-indigo">{id}</Badge>
							</div>
						</div>
					{/each}
				</div>
			{/if}

			{#if $app.unusedInlineScripts?.length > 0}
				<div class="flex gap-2 flex-col ">
					{#each $app.unusedInlineScripts as unusedInlineScript, index (index)}
						<!-- svelte-ignore a11y-click-events-have-key-events -->
						<div
							class="{classNames(
								'border flex gap-1 truncate justify-between flex-row w-full items-center p-2 rounded-md cursor-pointer hover:bg-blue-50 hover:text-blue-400',
								selectedScriptComponentId === `unused-${index}` ? 'bg-blue-100 text-blue-600' : ''
							)},"
							on:click={() => selectInlineScript(`unused-${index}`)}
						>
							<span class="text-xs truncate">{unusedInlineScript.name}</span>
							<Badge color="red">Detached</Badge>
						</div>
					{/each}
				</div>
			{/if}

			{#if runnables.inline.length == 0 && $app.unusedInlineScripts?.length == 0}
				<div class="text-sm text-gray-500">No inline scripts</div>
			{/if}
		</div>
	</PanelSection>

	<PanelSection title="Imported scripts" smallPadding>
		<div class="flex flex-col gap-2 w-full">
			{#if runnables.imported.length > 0}
				<div class="flex gap-2 flex-col ">
					{#each runnables.imported as { name, id }, index (index)}
						<!-- svelte-ignore a11y-click-events-have-key-events -->
						<div
							class="{classNames(
								'border flex gap-1 truncate justify-between flex-row w-full items-center p-2 rounded-md cursor-pointer hover:bg-blue-50 hover:text-blue-400',
								selectedScriptComponentId === id ? 'bg-blue-100 text-blue-600' : ''
							)},"
							on:click={() => selectInlineScript(id)}
						>
							<span class="text-xs truncate">{name}</span>
							<Badge color="dark-indigo">{id}</Badge>
						</div>
					{/each}
				</div>
			{:else}
				<div class="text-sm text-gray-500">No items</div>
			{/if}
		</div>
	</PanelSection>
</div>
