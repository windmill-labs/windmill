/**
 * Copyright (c) 2014-2024 The xterm.js authors. All rights reserved.
 * @license MIT
 *
 * Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
 * @license MIT
 *
 * Originally forked from (with the author's permission):
 *   Fabrice Bellard's javascript vt100 for jslinux:
 *   http://bellard.org/jslinux/
 *   Copyright (c) 2011 Fabrice Bellard
 */var eA=Object.create,Z=Object.defineProperty,tA=Object.getOwnPropertyDescriptor,iA=Object.getOwnPropertyNames,sA=Object.getPrototypeOf,rA=Object.prototype.hasOwnProperty,G=(A,e)=>()=>(e||A((e={exports:{}}).exports,e),e.exports),aA=(A,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of iA(e))!rA.call(A,s)&&s!==t&&Z(A,s,{get:()=>e[s],enumerable:!(i=tA(e,s))||i.enumerable});return A},L=(A,e,t)=>(t=A!=null?eA(sA(A)):{},aA(!A||!A.__esModule?Z(t,"default",{value:A,enumerable:!0}):t,A)),T=G(A=>{Object.defineProperty(A,"__esModule",{value:!0}),A.DEFAULT_FOREGROUND=A.DEFAULT_BACKGROUND=A.PALETTE_ANSI_256=A.PALETTE_VT340_GREY=A.PALETTE_VT340_COLOR=A.normalizeHLS=A.normalizeRGB=A.nearestColorIndex=A.fromRGBA8888=A.toRGBA8888=A.alpha=A.blue=A.green=A.red=A.BIG_ENDIAN=void 0,A.BIG_ENDIAN=new Uint8Array(new Uint32Array([4278190080]).buffer)[0]===255,A.BIG_ENDIAN&&console.warn("BE platform detected. This version of node-sixel works only on LE properly.");function e(a){return a&255}A.red=e;function t(a){return a>>>8&255}A.green=t;function i(a){return a>>>16&255}A.blue=i;function s(a){return a>>>24&255}A.alpha=s;function r(a,h,o,l=255){return((l&255)<<24|(o&255)<<16|(h&255)<<8|a&255)>>>0}A.toRGBA8888=r;function n(a){return[a&255,a>>8&255,a>>16&255,a>>>24]}A.fromRGBA8888=n;function g(a,h){let o=e(a),l=t(a),d=i(a),D=Number.MAX_SAFE_INTEGER,f=-1;for(let B=0;B<h.length;++B){let _=o-h[B][0],w=l-h[B][1],m=d-h[B][2],u=_*_+w*w+m*m;if(!u)return B;u<D&&(D=u,f=B)}return f}A.nearestColorIndex=g;function I(a,h,o){return Math.max(a,Math.min(o,h))}function c(a,h,o){return o<0&&(o+=1),o>1&&(o-=1),o*6<1?h+(a-h)*6*o:o*2<1?a:o*3<2?h+(a-h)*(4-o*6):h}function Q(a,h,o){if(!o){let D=Math.round(h*255);return r(D,D,D)}let l=h<.5?h*(1+o):h+o-h*o,d=2*h-l;return r(I(0,255,Math.round(c(l,d,a+1/3)*255)),I(0,255,Math.round(c(l,d,a)*255)),I(0,255,Math.round(c(l,d,a-1/3)*255)))}function C(a,h,o){return(4278190080|Math.round(o/100*255)<<16|Math.round(h/100*255)<<8|Math.round(a/100*255))>>>0}A.normalizeRGB=C;function E(a,h,o){return Q((a+240%360)/360,h/100,o/100)}A.normalizeHLS=E,A.PALETTE_VT340_COLOR=new Uint32Array([C(0,0,0),C(20,20,80),C(80,13,13),C(20,80,20),C(80,20,80),C(20,80,80),C(80,80,20),C(53,53,53),C(26,26,26),C(33,33,60),C(60,26,26),C(33,60,33),C(60,33,60),C(33,60,60),C(60,60,33),C(80,80,80)]),A.PALETTE_VT340_GREY=new Uint32Array([C(0,0,0),C(13,13,13),C(26,26,26),C(40,40,40),C(6,6,6),C(20,20,20),C(33,33,33),C(46,46,46),C(0,0,0),C(13,13,13),C(26,26,26),C(40,40,40),C(6,6,6),C(20,20,20),C(33,33,33),C(46,46,46)]),A.PALETTE_ANSI_256=(()=>{let a=[r(0,0,0),r(205,0,0),r(0,205,0),r(205,205,0),r(0,0,238),r(205,0,205),r(0,250,205),r(229,229,229),r(127,127,127),r(255,0,0),r(0,255,0),r(255,255,0),r(92,92,255),r(255,0,255),r(0,255,255),r(255,255,255)],h=[0,95,135,175,215,255];for(let o=0;o<6;++o)for(let l=0;l<6;++l)for(let d=0;d<6;++d)a.push(r(h[o],h[l],h[d]));for(let o=8;o<=238;o+=10)a.push(r(o,o,o));return new Uint32Array(a)})(),A.DEFAULT_BACKGROUND=r(0,0,0,255),A.DEFAULT_FOREGROUND=r(255,255,255,255)}),gA=G(A=>{Object.defineProperty(A,"__esModule",{value:!0}),A.InWasm=void 0;function e(i){if(typeof Buffer<"u")return Buffer.from(i,"base64");let s=atob(i),r=new Uint8Array(s.length);for(let n=0;n<r.length;++n)r[n]=s.charCodeAt(n);return r}function t(i){if(i.d){let{t:s,s:r,d:n}=i,g,I,c=WebAssembly;return s===2?r?()=>g||(g=e(n)):()=>Promise.resolve(g||(g=e(n))):s===1?r?()=>I||(I=new c.Module(g||(g=e(n)))):()=>I?Promise.resolve(I):c.compile(g||(g=e(n))).then(Q=>I=Q):r?Q=>new c.Instance(I||(I=new c.Module(g||(g=e(n)))),Q):Q=>I?c.instantiate(I,Q):c.instantiate(g||(g=e(n)),Q).then(C=>(I=C.module)&&C.instance)}if(typeof _wasmCtx>"u")throw new Error('must run "inwasm"');_wasmCtx.add(i)}A.InWasm=t}),hA=G(A=>{Object.defineProperty(A,"__esModule",{value:!0});var e=gA(),t=(0,e.InWasm)({s:1,t:0,d:"AGFzbQEAAAABBQFgAAF/Ag8BA2VudgZtZW1vcnkCAAEDAwIAAAcNAgNkZWMAAANlbmQAAQqxAwKuAQEFf0GIKCgCAEGgKGohAUGEKCgCACIAQYAoKAIAQQFrQXxxIgJIBEAgAkGgKGohAyAAQaAoaiEAA0AgAC0AA0ECdCgCgCAgAC0AAkECdCgCgBggAC0AAUECdCgCgBAgAC0AAEECdCgCgAhycnIiBEH///8HSwRAQQEPCyABIAQ2AgAgAUEDaiEBIABBBGoiACADSQ0ACwtBhCggAjYCAEGIKCABQaAoazYCAEEAC/4BAQZ/AkBBgCgoAgAiAUGEKCgCACIAa0EFTgRAQQEhAxAADQFBgCgoAgAhAUGEKCgCACEAC0EBIQMgASAAayIEQQJIDQAgAEGhKGotAABBAnQoAoAQIABBoChqLQAAQQJ0KAKACHIhAQJAIARBAkYEQEEBIQIMAQtBASECIAAtAKIoIgVBPUcEQEECIQIgBUECdCgCgBggAXIhAQsgBEEERw0AIAAtAKMoIgBBPUYNACACQQFqIQIgAEECdCgCgCAgAXIhAQsgAUH///8HSw0AQYgoKAIAQaAoaiABNgIAQYgoQYgoKAIAIAJqIgA2AgAgAEGQKCgCAEchAwsgAwsAdglwcm9kdWNlcnMBDHByb2Nlc3NlZC1ieQEFY2xhbmdWMTguMC4wIChodHRwczovL2dpdGh1Yi5jb20vbGx2bS9sbHZtLXByb2plY3QgZDFlNjg1ZGY0NWRjNTk0NGI0M2QyNTQ3ZDAxMzhjZDRhM2VlNGVmZSkALA90YXJnZXRfZmVhdHVyZXMCKw9tdXRhYmxlLWdsb2JhbHMrCHNpZ24tZXh0"}),i=new Uint8Array("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("").map(g=>g.charCodeAt(0))),s=new Uint32Array(1024);s.fill(4278190080);for(let g=0;g<i.length;++g)s[i[g]]=g<<2;for(let g=0;g<i.length;++g)s[256+i[g]]=g>>4|(g<<4&255)<<8;for(let g=0;g<i.length;++g)s[512+i[g]]=g>>2<<8|(g<<6&255)<<16;for(let g=0;g<i.length;++g)s[768+i[g]]=g<<16;var r=new Uint8Array(0),n=class{constructor(g){this.keepSize=g}get data8(){return this._inst?this._d.subarray(0,this._m32[1282]):r}release(){this._inst&&(this._mem.buffer.byteLength>this.keepSize?this._inst=this._m32=this._d=this._mem=null:(this._m32[1280]=0,this._m32[1281]=0,this._m32[1282]=0))}init(g){let I=this._m32,c=(Math.ceil(g/3)+1288)*4;this._inst?this._mem.buffer.byteLength<c&&(this._mem.grow(Math.ceil((c-this._mem.buffer.byteLength)/65536)),I=new Uint32Array(this._mem.buffer,0),this._d=new Uint8Array(this._mem.buffer,1288*4)):(this._mem=new WebAssembly.Memory({initial:Math.ceil(c/65536)}),this._inst=t({env:{memory:this._mem}}),I=new Uint32Array(this._mem.buffer,0),I.set(s,256),this._d=new Uint8Array(this._mem.buffer,1288*4)),I[1284]=g,I[1283]=Math.ceil(g/3)*4,I[1280]=0,I[1281]=0,I[1282]=0,this._m32=I}put(g,I,c){if(!this._inst)return 1;let Q=this._m32;return c-I+Q[1280]>Q[1283]?1:(this._d.set(g.subarray(I,c),Q[1280]),Q[1280]+=c-I,Q[1280]-Q[1281]>=131072?this._inst.exports.dec():0)}end(){return this._inst?this._inst.exports.end():1}};A.default=n}),oA=G(A=>{Object.defineProperty(A,"__esModule",{value:!0}),A.LIMITS=void 0,A.LIMITS={CHUNK_SIZE:16384,PALETTE_SIZE:4096,MAX_WIDTH:16384,BYTES:"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AEHAiwIgADcDAEG4iwIgADcDAEGwiwIgADcDAEGoiwIgADcDAEGgiwIgADcDAEGYiwIgADcDAEGQiwIgADcDAEGIiwIgADcDAEGAiwIgADcDAEH4igIgADcDAEHwigIgADcDAEHoigIgADcDAEHgigIgADcDAEHYigIgADcDAEHQigIgADcDAEHIigIgADcDAEHAigIgADcDAEG4igIgADcDAEGwigIgADcDAEGoigIgADcDAEGgigIgADcDAEGYigIgADcDAEGQigIgADcDAEGIigIgADcDAEGAigIgADcDAEH4iQIgADcDAEHwiQIgADcDAEHoiQIgADcDAEHgiQIgADcDAEHYiQIgADcDAEHQiQIgADcDAEHIiQIgADcDAEHAiQIgADcDAEG4iQIgADcDAEGwiQIgADcDAEGoCCgCACIEQf8AakGAAW0hCAJAIARBgQFIDQBBASEBIAhBAiAIQQJKG0EBayICQQFxIQMgBEGBAk4EQCACQX5xIQIDQCABQQl0IgdBEHJBoIkCakGwiQJBgAT8CgAAIAdBsI0CakGwiQJBgAT8CgAAIAFBAmohASACQQJrIgINAAsLIANFDQAgAUEJdEEQckGgiQJqQbCJAkGABPwKAAALAkAgBEEBSA0AIAhBASAIQQFKGyIDQQFxIQUCQCADQQFrIgdFBEBBACEBDAELIANB/v///wdxIQJBACEBA0AgAUEJdCIGQRByQbCJBmpBsIkCQYAE/AoAACAGQZAEckGwiQZqQbCJAkGABPwKAAAgAUECaiEBIAJBAmsiAg0ACwsgBQRAIAFBCXRBEHJBsIkGakGwiQJBgAT8CgAACyAEQQFIDQAgA0EBcSEFIAcEfyADQf7///8HcSECQQAhAQNAIAFBCXQiBkEQckHAiQpqQbCJAkGABPwKAAAgBkGQBHJBwIkKakGwiQJBgAT8CgAAIAFBAmohASACQQJrIgINAAsgAUEHdEEEcgVBBAshASAFBEAgAUECdEHAiQpqQbCJAkGABPwKAAALIARBAUgNACADQQFxIQUgBwR/IANB/v///wdxIQJBACEBA0AgAUEJdCIGQRByQdCJDmpBsIkCQYAE/AoAACAGQZAEckHQiQ5qQbCJAkGABPwKAAAgAUECaiEBIAJBAmsiAg0ACyABQQd0QQRyBUEECyEBIAUEQCABQQJ0QdCJDmpBsIkCQYAE/AoAAAsgBEEBSA0AIANBAXEhBSAHBH8gA0H+////B3EhAkEAIQEDQCABQQl0IgZBEHJB4IkSakGwiQJBgAT8CgAAIAZBkARyQeCJEmpBsIkCQYAE/AoAACABQQJqIQEgAkECayICDQALIAFBB3RBBHIFQQQLIQEgBQRAIAFBAnRB4IkSakGwiQJBgAT8CgAACyAEQQFIDQAgA0EBcSEEIAcEfyADQf7///8HcSECQQAhAQNAIAFBCXQiA0EQckHwiRZqQbCJAkGABPwKAAAgA0GQBHJB8IkWakGwiQJBgAT8CgAAIAFBAmohASACQQJrIgINAAsgAUEHdEEEcgVBBAshASAERQ0AIAFBAnRB8IkWakGwiQJBgAT8CgAAC0HUCCAIQQd0QQRyNgIAC58TAgh/AX5B5AgoAgAhA0HgCCgCACECQegIKAIAIQcgAUGQiQFqIglB/wE6AAAgACABSARAIABBkIkBaiEIA0AgAiEEIAhBAWohAQJAIAgtAABB/wBxIgJBMGtBCUsEQCABIQgMAQtB7AgoAgBBAnRB7AhqIgUoAgAhAANAIAUgAiAAQQpsakEwayIANgIAIAEtAAAhAiABQQFqIgghASACQf8AcSICQTBrQQpJDQALCwJAAkACQAJAAkACQAJ/AkAgAkE/ayIAQT9NBEAgBEUNASAEQSFGBEBB8AgoAgAiAUEBIAEbIgQgB2ohAQJAIABFDQAgB0H//wBLDQBBgIABIAdrIAQgAUH//wBLGyEFAkAgAEEBcUUNACAHQQJ0QaCJAmohAiAFIgRBB3EiBgRAA0AgAiADNgIAIAJBBGohAiAEQQFrIQQgBkEBayIGDQALCyAFQQFrQQdJDQADQCACIAM2AhwgAiADNgIYIAIgAzYCFCACIAM2AhAgAiADNgIMIAIgAzYCCCACIAM2AgQgAiADNgIAIAJBIGohAiAEQQhrIgQNAAsLAkAgAEECcUUNACAHQQJ0QbCJBmohAiAFIgRBB3EiBgRAA0AgAiADNgIAIAJBBGohAiAEQQFrIQQgBkEBayIGDQALCyAFQQFrQQdJDQADQCACIAM2AhwgAiADNgIYIAIgAzYCFCACIAM2AhAgAiADNgIMIAIgAzYCCCACIAM2AgQgAiADNgIAIAJBIGohAiAEQQhrIgQNAAsLAkAgAEEEcUUNACAHQQJ0QcCJCmohAiAFIgRBB3EiBgRAA0AgAiADNgIAIAJBBGohAiAEQQFrIQQgBkEBayIGDQALCyAFQQFrQQdJDQADQCACIAM2AhwgAiADNgIYIAIgAzYCFCACIAM2AhAgAiADNgIMIAIgAzYCCCACIAM2AgQgAiADNgIAIAJBIGohAiAEQQhrIgQNAAsLAkAgAEEIcUUNACAHQQJ0QdCJDmohAiAFIgRBB3EiBgRAA0AgAiADNgIAIAJBBGohAiAEQQFrIQQgBkEBayIGDQALCyAFQQFrQQdJDQADQCACIAM2AhwgAiADNgIYIAIgAzYCFCACIAM2AhAgAiADNgIMIAIgAzYCCCACIAM2AgQgAiADNgIAIAJBIGohAiAEQQhrIgQNAAsLAkAgAEEQcUUNACAHQQJ0QeCJEmohAiAFIgRBB3EiBgRAA0AgAiADNgIAIAJBBGohAiAEQQFrIQQgBkEBayIGDQALCyAFQQFrQQdJDQADQCACIAM2AhwgAiADNgIYIAIgAzYCFCACIAM2AhAgAiADNgIMIAIgAzYCCCACIAM2AgQgAiADNgIAIAJBIGohAiAEQQhrIgQNAAsLIABBIHFFDQAgBUEBayEEIAdBAnRB8IkWaiEAIAVBB3EiAgRAA0AgACADNgIAIABBBGohACAFQQFrIQUgAkEBayICDQALCyAEQQdJDQADQCAAIAM2AhwgACADNgIYIAAgAzYCFCAAIAM2AhAgACADNgIMIAAgAzYCCCAAIAM2AgQgACADNgIAIABBIGohACAFQQhrIgUNAAsLIAhBAWoiBSAILQAAQf8AcSICQT9rIgBBP00NAxoMBAsCQEHsCCgCACIFQQFGBEBB8AgoAgAiAUHMCCgCACIESQ0BIAEgBHAhAQwBC0H4CCgCACEEQfQIKAIAIQECQAJAIAVBBUcNACABQQFHDQAgBEHpAk4NBAwBCyAEQeQASg0DQfwIKAIAQeQASg0DQYAJKAIAQeQASg0DCwJAIAFFDQAgAUECSg0AIARB/AgoAgBBgAkoAgAgAUECdEGICGooAgARAgAhBEHwCCgCACIBQcwIKAIAIgVPBH8gASAFcAUgAQtBAnRBkAlqIAQ2AgALQfAIKAIAIgFBzAgoAgAiBEkNACABIARwIQELIAFBAnRBkAlqKAIAIQMMAQsgAkH9AHFBIUcEQCAHIQEgAiEADAQLIARBI0cNBAJAQewIKAIAIgRBAUYEQEHwCCgCACIBQcwIKAIAIgBJDQEgASAAcCEBDAELQfgIKAIAIQFB9AgoAgAhAAJAAkAgBEEFRw0AIABBAUcNACABQekCSA0BDAcLIAFB5ABKDQZB/AgoAgBB5ABKDQZBgAkoAgBB5ABKDQYLAkAgAEUNACAAQQJKDQAgAUH8CCgCAEGACSgCACAAQQJ0QYgIaigCABECACEAQfAIKAIAIgFBzAgoAgAiBE8EfyABIARwBSABC0ECdEGQCWogADYCAAtB8AgoAgAiAUHMCCgCACIASQ0AIAEgAHAhAQsgAUECdEGQCWooAgAhAwwECyAHIQEgCAshBQNAIAFB//8ATQRAIABBAXEgAWxBAnRBoIkCaiADNgIAIABBAXZBAXEgAWxBAnRBsIkGaiADNgIAIABBAnZBAXEgAWxBAnRBwIkKaiADNgIAIABBA3ZBAXEgAWxBAnRB0IkOaiADNgIAIABBBHZBAXEgAWxBAnRB4IkSaiADNgIAIABBBXYgAWxBAnRB8IkWaiADNgIACyABQQFqIQEgBS0AACEAIAVBAWoiBCEFIABB/wBxIgJBP2siAEHAAEkNAAsgBCEFC0EAIQQgBSEIIAEhByACIQAgAkH9AHFBIUYNAQtBBCEHIAQhAiAAQSRrDgoDAgICAgICAgIBAgtB7AhCATcCAAwCC0GoCCgCAEEEaxAABEBB0AhBATYCAA8LAkBBqAgoAgAiBkEFSA0AQaAIKQMAIQogBkEDa0EBdiIBQQdxIQJBACEAIAFBAWtBB08EQCABQfj///8HcSEFA0AgAEEDdCIBQbCJAmogCjcDACABQQhyQbCJAmogCjcDACABQRByQbCJAmogCjcDACABQRhyQbCJAmogCjcDACABQSByQbCJAmogCjcDACABQShyQbCJAmogCjcDACABQTByQbCJAmogCjcDACABQThyQbCJAmogCjcDACAAQQhqIQAgBUEIayIFDQALCyACRQ0AA0AgAEEDdEGwiQJqIAo3AwAgAEEBaiEAIAJBAWsiAg0ACwtBwIkGQbCJAiAGQQJ0IgD8CgAAQdCJCkGwiQIgAPwKAABB4IkOQbCJAiAA/AoAAEHwiRJBsIkCIAD8CgAAQYCKFkGwiQIgAPwKAAAgBCECDAELAkAgAEE7Rw0AQewIKAIAIgBBB0oNAEHsCCAAQQFqNgIAIABBAnRB8AhqQQA2AgALIAEhBwsgCCAJSQ0ACwtB5AggAzYCAEHgCCACNgIAQegIIAc2AgAL4gcCBX8BfgJAQdAIAn8CQAJAIAAgAU4NACABQZCJAWohBiAAQZCJAWohBQNAIAUtAAAiA0H/AHEhAgJAAkACQAJAAkACQAJAQeAIKAIAIgRBIkcEQCAEDQcgAkEiRgRAQewIQgE3AgBB4AhBIjYCAAwICyACQT9rQcAASQ0GIANBIWsiAkEMTQ0BDAULAkAgAkEwayIEQQlNBEBB7AgoAgBBAnRB7AhqIgIgBCACKAIAQQpsajYCAAwBC0HsCCgCACEEIAJBO0YEQCAEQQdKDQFB7AggBEEBajYCACAEQQJ0QfAIakEANgIADAELIARBBEYEQEHECEECNgIAQbAIQfAIKQMANwMAQbgIQfgIKAIAIgI2AgBBvAhB/AgoAgAiBDYCAEHICEECQQFBwAgoAgAiAxs2AgBBrAggBEEAIAMbNgIAQagIIAJBgIABIAJBgIABSBtBBGpBACADGzYCAEHgCEEANgIADAoLIAJBP2tBwABJDQQLIANBIWsiAkEMTQ0BDAILQQEgAnRBjSBxRQ0DDAQLQQEgAnRBjSBxDQELIANBoQFrIgJBDEsNA0EBIAJ0QY0gcUUNAwtBxAhCgYCAgBA3AgBBsAhB8AgoAgBBAEHsCCgCACICQQBKGzYCAEG0CEH0CCgCAEEAIAJBAUobNgIAQbgIQfgIKAIAQQAgAkECShs2AgBB4AhBADYCAEG8CEEANgIADAQLIANBoQFrIgJBDEsNAUEBIAJ0QY0gcUUNAQtBxAhCgYCAgBA3AgBBsAhCADcDAEG4CEIANwMADAMLIAVBAWoiBSAGSQ0ACwsCQEHICCgCAA4DAwEAAQsCQEGoCCgCACIFQQVIDQBBoAgpAwAhByAFQQNrQQF2IgNBB3EhBEEAIQIgA0EBa0EHTwRAIANB+P///wdxIQYDQCACQQN0IgNBsIkCaiAHNwMAIANBCHJBsIkCaiAHNwMAIANBEHJBsIkCaiAHNwMAIANBGHJBsIkCaiAHNwMAIANBIHJBsIkCaiAHNwMAIANBKHJBsIkCaiAHNwMAIANBMHJBsIkCaiAHNwMAIANBOHJBsIkCaiAHNwMAIAJBCGohAiAGQQhrIgYNAAsLIARFDQADQCACQQN0QbCJAmogBzcDACACQQFqIQIgBEEBayIEDQALC0HAiQZBsIkCIAVBAnQiA/wKAABB0IkKQbCJAiAD/AoAAEHgiQ5BsIkCIAP8CgAAQfCJEkGwiQIgA/wKAABBgIoWQbCJAiAD/AoAAEECDAELEAhByAgoAgALEAEiAjYCACACDQAgACABQcgIKAIAQQJ0QYAIaigCABEBAAsLdABB6AhBBDYCAEHkCCAANgIAQewIQgE3AgBBxAhCADcCAEHACCADNgIAQdwIQgA3AgBBqAhCADcDAEGwCEIANwMAQbgIQgA3AwBBzAggAkGAICACQYAgSRs2AgBBoAggAa1CgYCAgBB+NwMAQdAIQQA2AgALIwBB0AgoAgBFBEAgACABQcgIKAIAQQJ0QYAIaigCABEBAAsLWgECfwJAAkACQEHICCgCAEEBaw4CAAECC0HYCEHoCCgCACIAQdgIKAIAIgEgACABShsiAEGAgAEgAEGAgAFIGyIANgIAIABBBGsPC0GoCCgCAEEEayEACyAAC0IBAX8Cf0EGQdwIKAIAIgBBIHENABpBBSAAQRBxDQAaQQQgAEEIcQ0AGkEDIABBBHENABpBAiAAQQFxIABBAnEbCwu9BQEFfQJ/IAJFBEAgAUH/AWxBMmpB5ABtIgBBCHQgAHIgAEEQdHIMAQsgArJDAADIQpUhBiAAQfABarJDAAC0Q5UhBQJ9IAGyQwAAyEKVIgNDAAAAP10EQCADIAZDAACAP5KUDAELIAYgA0MAAIA/IAaTlJILIQcgAyADkiEGAkAgBUOrqqo+kiIEQwAAAABdBEAgBEMAAIA/kiEEDAELIARDAACAP15FDQAgBEMAAIC/kiEECyAGIAeTIQMgBUMAAAAAXSEAAn8CfSADIAcgA5NDAADAQJQgBJSSIARDq6oqPl0NABogByAEQwAAAD9dDQAaIAMgBEOrqio/XUUNABogAyAHIAOTIARDAADAwJRDAACAQJKUkgtDAAB/Q5RDAAAAP5IiBkMAAIBPXSAGQwAAAABgcQRAIAapDAELQQALIQECQCAABEAgBUMAAIA/kiEEDAELIAUiBEMAAIA/XkUNACAFQwAAgL+SIQQLIAVDq6qqvpIiBUMAAAAAXSECAn8CfSADIAcgA5NDAADAQJQgBJSSIARDq6oqPl0NABogByAEQwAAAD9dDQAaIAMgBEOrqio/XUUNABogAyAHIAOTIARDAADAwJRDAACAQJKUkgtDAAB/Q5RDAAAAP5IiBkMAAIBPXSAGQwAAAABgcQRAIAapDAELQQALIQACQCACBEAgBUMAAIA/kiEFDAELIAVDAACAP15FDQAgBUMAAIC/kiEFCwJAIAVDq6oqPl0EQCADIAcgA5NDAADAQJQgBZSSIQcMAQsgBUMAAAA/XQ0AIAVDq6oqP11FBEAgAyEHDAELIAMgByADkyAFQwAAwMCUQwAAgECSlJIhBwsgAEEIdAJ/IAdDAAB/Q5RDAAAAP5IiBkMAAIBPXSAGQwAAAABgcQRAIAapDAELQQALQRB0ciABcgtBgICAeHILNwAgAEH/AWxBMmpB5ABtIAFB/wFsQTJqQeQAbUEIdHIgAkH/AWxBMmpB5ABtQRB0ckGAgIB4cgsEACMACwYAIAAkAAsQACMAIABrQXBxIgAkACAACwsYAQBBgAgLEQEAAAACAAAAAwAAAAQAAAAF"}}),nA=G(A=>{Object.defineProperty(A,"__esModule",{value:!0}),A.decodeAsync=A.decode=A.Decoder=A.DecoderAsync=void 0;var e=T(),t=oA();function i(a){if(typeof Buffer<"u")return Buffer.from(a,"base64");let h=atob(a),o=new Uint8Array(h.length);for(let l=0;l<o.length;++l)o[l]=h.charCodeAt(l);return o}var s=i(t.LIMITS.BYTES),r,n=new Uint32Array,g=class{constructor(){this.bandHandler=a=>1,this.modeHandler=a=>1}handle_band(a){return this.bandHandler(a)}mode_parsed(a){return this.modeHandler(a)}},I={memoryLimit:2048*65536,sixelColor:e.DEFAULT_FOREGROUND,fillColor:e.DEFAULT_BACKGROUND,palette:e.PALETTE_VT340_COLOR,paletteLimit:t.LIMITS.PALETTE_SIZE,truncate:!0};function c(a){let h=new g,o={env:{handle_band:h.handle_band.bind(h),mode_parsed:h.mode_parsed.bind(h)}};return WebAssembly.instantiate(r||s,o).then(l=>(r=r||l.module,new Q(a,l.instance||l,h)))}A.DecoderAsync=c;var Q=class{constructor(a,h,o){if(this._PIXEL_OFFSET=t.LIMITS.MAX_WIDTH+4,this._canvas=n,this._bandWidths=[],this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._lastOffset=0,this._currentHeight=0,this._opts=Object.assign({},I,a),this._opts.paletteLimit>t.LIMITS.PALETTE_SIZE)throw new Error(`DecoderOptions.paletteLimit must not exceed ${t.LIMITS.PALETTE_SIZE}`);if(h)o.bandHandler=this._handle_band.bind(this),o.modeHandler=this._initCanvas.bind(this);else{let l=r||(r=new WebAssembly.Module(s));h=new WebAssembly.Instance(l,{env:{handle_band:this._handle_band.bind(this),mode_parsed:this._initCanvas.bind(this)}})}this._instance=h,this._wasm=this._instance.exports,this._chunk=new Uint8Array(this._wasm.memory.buffer,this._wasm.get_chunk_address(),t.LIMITS.CHUNK_SIZE),this._states=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_state_address(),12),this._palette=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_palette_address(),t.LIMITS.PALETTE_SIZE),this._palette.set(this._opts.palette),this._pSrc=new Uint32Array(this._wasm.memory.buffer,this._wasm.get_p0_address()),this._wasm.init(e.DEFAULT_FOREGROUND,0,this._opts.paletteLimit,0)}get _fillColor(){return this._states[0]}get _truncate(){return this._states[8]}get _rasterWidth(){return this._states[6]}get _rasterHeight(){return this._states[7]}get _width(){return this._states[2]?this._states[2]-4:0}get _height(){return this._states[3]}get _level(){return this._states[9]}get _mode(){return this._states[10]}get _paletteLimit(){return this._states[11]}_initCanvas(a){if(a===2){let h=this.width*this.height;if(h>this._canvas.length){if(this._opts.memoryLimit&&h*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");this._canvas=new Uint32Array(h)}this._maxWidth=this._width}else if(a===1)if(this._level===2){let h=Math.min(this._rasterWidth,t.LIMITS.MAX_WIDTH)*this._rasterHeight;if(h>this._canvas.length){if(this._opts.memoryLimit&&h*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");this._canvas=new Uint32Array(h)}}else this._canvas.length<65536&&(this._canvas=new Uint32Array(65536));return 0}_realloc(a,h){let o=a+h;if(o>this._canvas.length){if(this._opts.memoryLimit&&o*4>this._opts.memoryLimit)throw this.release(),new Error("image exceeds memory limit");let l=new Uint32Array(Math.ceil(o/65536)*65536);l.set(this._canvas),this._canvas=l}}_handle_band(a){let h=this._PIXEL_OFFSET,o=this._lastOffset;if(this._mode===2){let l=this.height-this._currentHeight,d=0;for(;d<6&&l>0;)this._canvas.set(this._pSrc.subarray(h*d,h*d+a),o+a*d),d++,l--;this._lastOffset+=a*d,this._currentHeight+=d}else if(this._mode===1){this._realloc(o,a*6),this._maxWidth=Math.max(this._maxWidth,a),this._minWidth=Math.min(this._minWidth,a);for(let l=0;l<6;++l)this._canvas.set(this._pSrc.subarray(h*l,h*l+a),o+a*l);this._bandWidths.push(a),this._lastOffset+=a*6,this._currentHeight+=6}return 0}get width(){return this._mode!==1?this._width:Math.max(this._maxWidth,this._wasm.current_width())}get height(){return this._mode!==1?this._height:this._wasm.current_width()?this._bandWidths.length*6+this._wasm.current_height():this._bandWidths.length*6}get palette(){return this._palette.subarray(0,this._paletteLimit)}get memoryUsage(){return this._canvas.byteLength+this._wasm.memory.buffer.byteLength+8*this._bandWidths.length}get properties(){return{width:this.width,height:this.height,mode:this._mode,level:this._level,truncate:!!this._truncate,paletteLimit:this._paletteLimit,fillColor:this._fillColor,memUsage:this.memoryUsage,rasterAttributes:{numerator:this._states[4],denominator:this._states[5],width:this._rasterWidth,height:this._rasterHeight}}}init(a=this._opts.fillColor,h=this._opts.palette,o=this._opts.paletteLimit,l=this._opts.truncate){this._wasm.init(this._opts.sixelColor,a,o,l?1:0),h&&this._palette.set(h.subarray(0,t.LIMITS.PALETTE_SIZE)),this._bandWidths.length=0,this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._lastOffset=0,this._currentHeight=0}decode(a,h=0,o=a.length){let l=h;for(;l<o;){let d=Math.min(o-l,t.LIMITS.CHUNK_SIZE);this._chunk.set(a.subarray(l,l+=d)),this._wasm.decode(0,d)}}decodeString(a,h=0,o=a.length){let l=h;for(;l<o;){let d=Math.min(o-l,t.LIMITS.CHUNK_SIZE);for(let D=0,f=l;D<d;++D,++f)this._chunk[D]=a.charCodeAt(f);l+=d,this._wasm.decode(0,d)}}get data32(){if(this._mode===0||!this.width||!this.height)return n;let a=this._wasm.current_width();if(this._mode===2){let h=this.height-this._currentHeight;if(h>0){let o=this._PIXEL_OFFSET,l=this._lastOffset,d=0;for(;d<6&&h>0;)this._canvas.set(this._pSrc.subarray(o*d,o*d+a),l+a*d),d++,h--;h&&this._canvas.fill(this._fillColor,l+a*d)}return this._canvas.subarray(0,this.width*this.height)}if(this._mode===1){if(this._minWidth===this._maxWidth){let d=!1;if(a)if(a!==this._minWidth)d=!0;else{let D=this._PIXEL_OFFSET,f=this._lastOffset;this._realloc(f,a*6);for(let B=0;B<6;++B)this._canvas.set(this._pSrc.subarray(D*B,D*B+a),f+a*B)}if(!d)return this._canvas.subarray(0,this.width*this.height)}let h=new Uint32Array(this.width*this.height);h.fill(this._fillColor);let o=0,l=0;for(let d=0;d<this._bandWidths.length;++d){let D=this._bandWidths[d];for(let f=0;f<6;++f)h.set(this._canvas.subarray(l,l+=D),o),o+=this.width}if(a){let d=this._PIXEL_OFFSET,D=this._wasm.current_height();for(let f=0;f<D;++f)h.set(this._pSrc.subarray(d*f,d*f+a),o+this.width*f)}return h}return n}get data8(){return new Uint8ClampedArray(this.data32.buffer,0,this.width*this.height*4)}release(){this._canvas=n,this._bandWidths.length=0,this._maxWidth=0,this._minWidth=t.LIMITS.MAX_WIDTH,this._wasm.init(e.DEFAULT_FOREGROUND,0,this._opts.paletteLimit,0)}};A.Decoder=Q;function C(a,h){let o=new Q(h);return o.init(),typeof a=="string"?o.decodeString(a):o.decode(a),{width:o.width,height:o.height,data32:o.data32,data8:o.data8}}A.decode=C;async function E(a,h){let o=await c(h);return o.init(),typeof a=="string"?o.decodeString(a):o.decode(a),{width:o.width,height:o.height,data32:o.data32,data8:o.data8}}A.decodeAsync=E}),Y=L(T()),IA;(A=>{function e(r){return r<0}A.isLessThan=e;function t(r){return r<=0}A.isLessThanOrEqual=t;function i(r){return r>0}A.isGreaterThan=i;function s(r){return r===0}A.isNeitherLessOrGreaterThan=s,A.greaterThan=1,A.lessThan=-1,A.neitherLessOrGreaterThan=0})(IA||(IA={}));function lA(A,e){let t=this,i=!1,s;return function(){return i||(i=!0,e||(s=A.apply(t,arguments))),s}}var j;(A=>{function e(B){return B&&typeof B=="object"&&typeof B[Symbol.iterator]=="function"}A.is=e;let t=Object.freeze([]);function i(){return t}A.empty=i;function*s(B){yield B}A.single=s;function r(B){return e(B)?B:s(B)}A.wrap=r;function n(B){return B||t}A.from=n;function*g(B){for(let _=B.length-1;_>=0;_--)yield B[_]}A.reverse=g;function I(B){return!B||B[Symbol.iterator]().next().done===!0}A.isEmpty=I;function c(B){return B[Symbol.iterator]().next().value}A.first=c;function Q(B,_){let w=0;for(let m of B)if(_(m,w++))return!0;return!1}A.some=Q;function C(B,_){for(let w of B)if(_(w))return w}A.find=C;function*E(B,_){for(let w of B)_(w)&&(yield w)}A.filter=E;function*a(B,_){let w=0;for(let m of B)yield _(m,w++)}A.map=a;function*h(B,_){let w=0;for(let m of B)yield*_(m,w++)}A.flatMap=h;function*o(...B){for(let _ of B)yield*_}A.concat=o;function l(B,_,w){let m=w;for(let u of B)m=_(m,u);return m}A.reduce=l;function*d(B,_,w=B.length){for(_<0&&(_+=B.length),w<0?w+=B.length:w>B.length&&(w=B.length);_<w;_++)yield B[_]}A.slice=d;function D(B,_=Number.POSITIVE_INFINITY){let w=[];if(_===0)return[w,B];let m=B[Symbol.iterator]();for(let u=0;u<_;u++){let K=m.next();if(K.done)return[w,A.empty()];w.push(K.value)}return[w,{[Symbol.iterator](){return m}}]}A.consume=D;async function f(B){let _=[];for await(let w of B)_.push(w);return Promise.resolve(_)}A.asyncToArray=f})(j||(j={}));function CA(A){if(j.is(A)){let e=[];for(let t of A)if(t)try{t.dispose()}catch(i){e.push(i)}if(e.length===1)throw e[0];if(e.length>1)throw new AggregateError(e,"Encountered errors while disposing of store");return Array.isArray(A)?[]:A}else if(A)return A.dispose(),A}function BA(A){return{dispose:lA(()=>{A()})}}var X=class V{constructor(){this._toDispose=new Set,this._isDisposed=!1}dispose(){this._isDisposed||(this._isDisposed=!0,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{CA(this._toDispose)}finally{this._toDispose.clear()}}add(e){if(!e)return e;if(e===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?V.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(e),e}delete(e){if(e){if(e===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(e),e.dispose()}}deleteAndLeak(e){e&&this._toDispose.has(e)&&(this._toDispose.delete(e),void 0)}};X.DISABLE_DISPOSED_WARNING=!1;var QA=X,$=class{constructor(){this._store=new QA,this._store}dispose(){this._store.dispose()}_register(A){if(A===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(A)}};$.None=Object.freeze({dispose(){}});var cA=class{constructor(){this._isDisposed=!1}get value(){return this._isDisposed?void 0:this._value}set value(A){var e;this._isDisposed||A===this._value||((e=this._value)==null||e.dispose(),this._value=A)}clear(){this.value=void 0}dispose(){var A;this._isDisposed=!0,(A=this._value)==null||A.dispose(),this._value=void 0}clearAndLeak(){let A=this._value;return this._value=void 0,A}},dA=4096,F=24,S=class p extends ${constructor(e){super(),this._terminal=e,this._optionsRefresh=this._register(new cA),this._oldOpen=this._terminal._core.open,this._terminal._core.open=t=>{var i;(i=this._oldOpen)==null||i.call(this._terminal._core,t),this._open()},this._terminal._core.screenElement&&this._open(),this._optionsRefresh.value=this._terminal._core.optionsService.onOptionChange(t=>{var i;t==="fontSize"&&(this.rescaleCanvas(),(i=this._renderService)==null||i.refreshRows(0,this._terminal.rows))}),this._register(BA(()=>{var t;this.removeLayerFromDom(),this._terminal._core&&this._oldOpen&&(this._terminal._core.open=this._oldOpen,this._oldOpen=void 0),this._renderService&&this._oldSetRenderer&&(this._renderService.setRenderer=this._oldSetRenderer,this._oldSetRenderer=void 0),this._renderService=void 0,this.canvas=void 0,this._ctx=void 0,(t=this._placeholderBitmap)==null||t.close(),this._placeholderBitmap=void 0,this._placeholder=void 0}))}static createCanvas(e,t,i){let s=(e||document).createElement("canvas");return s.width=t|0,s.height=i|0,s}static createImageData(e,t,i,s){if(typeof ImageData!="function"){let r=e.createImageData(t,i);return s&&r.data.set(new Uint8ClampedArray(s,0,t*i*4)),r}return s?new ImageData(new Uint8ClampedArray(s,0,t*i*4),t,i):new ImageData(t,i)}static createImageBitmap(e){return typeof createImageBitmap!="function"?Promise.resolve(void 0):createImageBitmap(e)}showPlaceholder(e){var t,i;e?!this._placeholder&&this.cellSize.height!==-1&&this._createPlaceHolder(Math.max(this.cellSize.height+1,F)):((t=this._placeholderBitmap)==null||t.close(),this._placeholderBitmap=void 0,this._placeholder=void 0),(i=this._renderService)==null||i.refreshRows(0,this._terminal.rows)}get dimensions(){var e;return(e=this._renderService)==null?void 0:e.dimensions}get cellSize(){var e,t;return{width:((e=this.dimensions)==null?void 0:e.css.cell.width)||-1,height:((t=this.dimensions)==null?void 0:t.css.cell.height)||-1}}clearLines(e,t){var i,s,r,n;(n=this._ctx)==null||n.clearRect(0,e*(((i=this.dimensions)==null?void 0:i.css.cell.height)||0),((s=this.dimensions)==null?void 0:s.css.canvas.width)||0,(++t-e)*(((r=this.dimensions)==null?void 0:r.css.cell.height)||0))}clearAll(){var e,t,i;(i=this._ctx)==null||i.clearRect(0,0,((e=this.canvas)==null?void 0:e.width)||0,((t=this.canvas)==null?void 0:t.height)||0)}draw(e,t,i,s,r=1){if(!this._ctx)return;let{width:n,height:g}=this.cellSize;if(n===-1||g===-1)return;this._rescaleImage(e,n,g);let I=e.actual,c=Math.ceil(I.width/n),Q=t%c*n,C=Math.floor(t/c)*g,E=i*n,a=s*g,h=r*n+Q>I.width?I.width-Q:r*n,o=C+g>I.height?I.height-C:g;this._ctx.drawImage(I,Math.floor(Q),Math.floor(C),Math.ceil(h),Math.ceil(o),Math.floor(E),Math.floor(a),Math.ceil(h),Math.ceil(o))}extractTile(e,t){let{width:i,height:s}=this.cellSize;if(i===-1||s===-1)return;this._rescaleImage(e,i,s);let r=e.actual,n=Math.ceil(r.width/i),g=t%n*i,I=Math.floor(t/n)*s,c=i+g>r.width?r.width-g:i,Q=I+s>r.height?r.height-I:s,C=p.createCanvas(this.document,c,Q),E=C.getContext("2d");if(E)return E.drawImage(r,Math.floor(g),Math.floor(I),Math.floor(c),Math.floor(Q),0,0,Math.floor(c),Math.floor(Q)),C}drawPlaceholder(e,t,i=1){if(this._ctx){let{width:s,height:r}=this.cellSize;if(s===-1||r===-1||(this._placeholder?r>=this._placeholder.height&&this._createPlaceHolder(r+1):this._createPlaceHolder(Math.max(r+1,F)),!this._placeholder))return;this._ctx.drawImage(this._placeholderBitmap||this._placeholder,e*s,t*r%2?0:1,s*i,r,e*s,t*r,s*i,r)}}rescaleCanvas(){this.canvas&&(this.canvas.width!==this.dimensions.css.canvas.width||this.canvas.height!==this.dimensions.css.canvas.height)&&(this.canvas.width=this.dimensions.css.canvas.width||0,this.canvas.height=this.dimensions.css.canvas.height||0)}_rescaleImage(e,t,i){if(t===e.actualCellSize.width&&i===e.actualCellSize.height)return;let{width:s,height:r}=e.origCellSize;if(t===s&&i===r){e.actual=e.orig,e.actualCellSize.width=s,e.actualCellSize.height=r;return}let n=p.createCanvas(this.document,Math.ceil(e.orig.width*t/s),Math.ceil(e.orig.height*i/r)),g=n.getContext("2d");g&&(g.drawImage(e.orig,0,0,n.width,n.height),e.actual=n,e.actualCellSize.width=t,e.actualCellSize.height=i)}_open(){this._renderService=this._terminal._core._renderService,this._oldSetRenderer=this._renderService.setRenderer.bind(this._renderService),this._renderService.setRenderer=e=>{var t;this.removeLayerFromDom(),(t=this._oldSetRenderer)==null||t.call(this._renderService,e)}}insertLayerToDom(){var e,t;this.document&&this._terminal._core.screenElement?this.canvas||(this.canvas=p.createCanvas(this.document,((e=this.dimensions)==null?void 0:e.css.canvas.width)||0,((t=this.dimensions)==null?void 0:t.css.canvas.height)||0),this.canvas.classList.add("xterm-image-layer"),this._terminal._core.screenElement.appendChild(this.canvas),this._ctx=this.canvas.getContext("2d",{alpha:!0,desynchronized:!0}),this.clearAll()):console.warn("image addon: cannot insert output canvas to DOM, missing document or screenElement")}removeLayerFromDom(){this.canvas&&(this._ctx=void 0,this.canvas.remove(),this.canvas=void 0)}_createPlaceHolder(e=F){var C;(C=this._placeholderBitmap)==null||C.close(),this._placeholderBitmap=void 0;let t=32,i=p.createCanvas(this.document,t,e),s=i.getContext("2d",{alpha:!1});if(!s)return;let r=p.createImageData(s,t,e),n=new Uint32Array(r.data.buffer),g=(0,Y.toRGBA8888)(0,0,0),I=(0,Y.toRGBA8888)(255,255,255);n.fill(g);for(let E=0;E<e;++E){let a=E%2,h=E*t;for(let o=0;o<t;o+=2)n[h+o+a]=I}s.putImageData(r,0,0);let c=screen.width+t-1&-32||dA;this._placeholder=p.createCanvas(this.document,c,e);let Q=this._placeholder.getContext("2d",{alpha:!1});if(!Q){this._placeholder=void 0;return}for(let E=0;E<c;E+=t)Q.drawImage(i,E,0);p.createImageBitmap(this._placeholder).then(E=>this._placeholderBitmap=E)}get document(){var e;return(e=this._terminal._core._coreBrowserService)==null?void 0:e.window.document}},M={width:7,height:14},x=class AA{constructor(e=0,t=0,i=-1,s=-1){this.imageId=i,this.tileId=s,this._ext=0,this._urlId=0,this._ext=e,this._urlId=t}get ext(){return this._urlId?this._ext&-469762049|this.underlineStyle<<26:this._ext}set ext(e){this._ext=e}get underlineStyle(){return this._urlId?5:(this._ext&469762048)>>26}set underlineStyle(e){this._ext&=-469762049,this._ext|=e<<26&469762048}get underlineColor(){return this._ext&67108863}set underlineColor(e){this._ext&=-67108864,this._ext|=e&67108863}get underlineVariantOffset(){let e=(this._ext&3758096384)>>29;return e<0?e^4294967288:e}set underlineVariantOffset(e){this._ext&=536870911,this._ext|=e<<29&3758096384}get urlId(){return this._urlId}set urlId(e){this._urlId=e}clone(){return new AA(this._ext,this._urlId,this.imageId,this.tileId)}isEmpty(){return this.underlineStyle===0&&this._urlId===0&&this.imageId===-1}},k=new x,_A=class{constructor(A,e,t){this._terminal=A,this._renderer=e,this._opts=t,this._images=new Map,this._lastId=0,this._lowestId=0,this._fullyCleared=!1,this._needsFullClear=!1,this._pixelLimit=25e5;try{this.setLimit(this._opts.storageLimit)}catch(i){console.error(i.message),console.warn(`storageLimit is set to ${this.getLimit()} MB`)}this._viewportMetrics={cols:this._terminal.cols,rows:this._terminal.rows}}dispose(){this.reset()}reset(){var A;for(let e of this._images.values())(A=e.marker)==null||A.dispose();this._images.clear(),this._renderer.clearAll()}getLimit(){return this._pixelLimit*4/1e6}setLimit(A){if(A<.5||A>1e3)throw RangeError("invalid storageLimit, should be at least 0.5 MB and not exceed 1G");this._pixelLimit=A/4*1e6>>>0,this._evictOldest(0)}getUsage(){return this._getStoredPixels()*4/1e6}_getStoredPixels(){let A=0;for(let e of this._images.values())e.orig&&(A+=e.orig.width*e.orig.height,e.actual&&e.actual!==e.orig&&(A+=e.actual.width*e.actual.height));return A}_delImg(A){let e=this._images.get(A);this._images.delete(A),e&&window.ImageBitmap&&e.orig instanceof ImageBitmap&&e.orig.close()}wipeAlternate(){var e;let A=[];for(let[t,i]of this._images.entries())i.bufferType==="alternate"&&((e=i.marker)==null||e.dispose(),A.push(t));for(let t of A)this._delImg(t);this._needsFullClear=!0,this._fullyCleared=!1}advanceCursor(A){if(this._opts.sixelScrolling){let e=this._renderer.cellSize;(e.width===-1||e.height===-1)&&(e=M);let t=Math.ceil(A/e.height);for(let i=1;i<t;++i)this._terminal._core._inputHandler.lineFeed()}}addImage(A){var o;this._evictOldest(A.width*A.height);let e=this._renderer.cellSize;(e.width===-1||e.height===-1)&&(e=M);let t=Math.ceil(A.width/e.width),i=Math.ceil(A.height/e.height),s=++this._lastId,r=this._terminal._core.buffer,n=this._terminal.cols,g=this._terminal.rows,I=r.x,c=r.y,Q=I,C=0;this._opts.sixelScrolling||(r.x=0,r.y=0,Q=0),this._terminal._core._inputHandler._dirtyRowTracker.markDirty(r.y);for(let l=0;l<i;++l){let d=r.lines.get(r.y+r.ybase);for(let D=0;D<t&&!(Q+D>=n);++D)this._writeToCell(d,Q+D,s,l*t+D),C++;if(this._opts.sixelScrolling)l<i-1&&this._terminal._core._inputHandler.lineFeed();else if(++r.y>=g)break;r.x=Q}this._terminal._core._inputHandler._dirtyRowTracker.markDirty(r.y),this._opts.sixelScrolling?r.x=Q:(r.x=I,r.y=c);let E=[];for(let[l,d]of this._images.entries())d.tileCount<1&&((o=d.marker)==null||o.dispose(),E.push(l));for(let l of E)this._delImg(l);let a=this._terminal.registerMarker(0);a==null||a.onDispose(()=>{this._images.get(s)&&this._delImg(s)}),this._terminal.buffer.active.type==="alternate"&&this._evictOnAlternate();let h={orig:A,origCellSize:e,actual:A,actualCellSize:{...e},marker:a||void 0,tileCount:C,bufferType:this._terminal.buffer.active.type};this._images.set(s,h)}render(A){if(!this._renderer.canvas&&this._images.size&&(this._renderer.insertLayerToDom(),!this._renderer.canvas))return;if(this._renderer.rescaleCanvas(),!this._images.size){this._fullyCleared||(this._renderer.clearAll(),this._fullyCleared=!0,this._needsFullClear=!1),this._renderer.canvas&&this._renderer.removeLayerFromDom();return}this._needsFullClear&&(this._renderer.clearAll(),this._fullyCleared=!0,this._needsFullClear=!1);let{start:e,end:t}=A,i=this._terminal._core.buffer,s=this._terminal._core.cols;this._renderer.clearLines(e,t);for(let r=e;r<=t;++r){let n=i.lines.get(r+i.ydisp);if(!n)return;for(let g=0;g<s;++g)if(n.getBg(g)&268435456){let I=n._extendedAttrs[g]||k,c=I.imageId;if(c===void 0||c===-1)continue;let Q=this._images.get(c);if(I.tileId!==-1){let C=I.tileId,E=g,a=1;for(;++g<s&&n.getBg(g)&268435456&&(I=n._extendedAttrs[g]||k)&&I.imageId===c&&I.tileId===C+a;)a++;g--,Q?Q.actual&&this._renderer.draw(Q,C,E,r,a):this._opts.showPlaceholder&&this._renderer.drawPlaceholder(E,r,a),this._fullyCleared=!1}}}}viewportResize(A){var s;if(!this._images.size){this._viewportMetrics=A;return}if(this._viewportMetrics.cols>=A.cols){this._viewportMetrics=A;return}let e=this._terminal._core.buffer,t=e.lines.length,i=this._viewportMetrics.cols-1;for(let r=0;r<t;++r){let n=e.lines.get(r);if(n.getBg(i)&268435456){let g=n._extendedAttrs[i]||k,I=g.imageId;if(I===void 0||I===-1)continue;let c=this._images.get(I);if(!c)continue;let Q=Math.ceil((((s=c.actual)==null?void 0:s.width)||0)/c.actualCellSize.width);if(g.tileId%Q+1>=Q)continue;let C=!1;for(let h=i+1;h>A.cols;++h)if(n._data[h*3+0]&4194303){C=!0;break}if(C)continue;let E=Math.min(A.cols,Q-g.tileId%Q+i),a=g.tileId;for(let h=i+1;h<E;++h)this._writeToCell(n,h,I,++a),c.tileCount++}}this._viewportMetrics=A}getImageAtBufferCell(A,e){var i,s;let t=this._terminal._core.buffer.lines.get(e);if(t&&t.getBg(A)&268435456){let r=t._extendedAttrs[A]||k;if(r.imageId&&r.imageId!==-1){let n=(i=this._images.get(r.imageId))==null?void 0:i.orig;if(window.ImageBitmap&&n instanceof ImageBitmap){let g=S.createCanvas(window.document,n.width,n.height);return(s=g.getContext("2d"))==null||s.drawImage(n,0,0,n.width,n.height),g}return n}}}extractTileAtBufferCell(A,e){let t=this._terminal._core.buffer.lines.get(e);if(t&&t.getBg(A)&268435456){let i=t._extendedAttrs[A]||k;if(i.imageId&&i.imageId!==-1&&i.tileId!==-1){let s=this._images.get(i.imageId);if(s)return this._renderer.extractTile(s,i.tileId)}}}_evictOldest(A){var i;let e=this._getStoredPixels(),t=e;for(;this._pixelLimit<t+A&&this._images.size;){let s=this._images.get(++this._lowestId);s&&s.orig&&(t-=s.orig.width*s.orig.height,s.actual&&s.orig!==s.actual&&(t-=s.actual.width*s.actual.height),(i=s.marker)==null||i.dispose(),this._delImg(this._lowestId))}return e-t}_writeToCell(A,e,t,i){if(A._data[e*3+2]&268435456){let s=A._extendedAttrs[e];if(s){if(s.imageId!==void 0){let r=this._images.get(s.imageId);r&&r.tileCount--,s.imageId=t,s.tileId=i;return}A._extendedAttrs[e]=new x(s.ext,s.urlId,t,i);return}}A._data[e*3+2]|=268435456,A._extendedAttrs[e]=new x(0,0,t,i)}_evictOnAlternate(){var t,i;for(let s of this._images.values())s.bufferType==="alternate"&&(s.tileCount=0);let A=this._terminal._core.buffer;for(let s=0;s<this._terminal.rows;++s){let r=A.lines.get(s);if(r){for(let n=0;n<this._terminal.cols;++n)if(r._data[n*3+2]&268435456){let g=(t=r._extendedAttrs[n])==null?void 0:t.imageId;if(g){let I=this._images.get(g);I&&I.tileCount++}}}}let e=[];for(let[s,r]of this._images.entries())r.bufferType==="alternate"&&!r.tileCount&&((i=r.marker)==null||i.dispose(),e.push(s));for(let s of e)this._delImg(s)}},EA=L(hA());function J(A){let e="";for(let t=0;t<A.length;++t)e+=String.fromCharCode(A[t]);return e}function R(A){let e=0;for(let t=0;t<A.length;++t){if(A[t]<48||A[t]>57)throw new Error("illegal char");e=e*10+A[t]-48}return e}function W(A){let e=J(A);if(!e.match(/^((auto)|(\d+?((px)|(%)){0,1}))$/))throw new Error("illegal size");return e}function wA(A){if(typeof Buffer<"u")return Buffer.from(J(A),"base64").toString();let e=atob(J(A)),t=new Uint8Array(e.length);for(let i=0;i<t.length;++i)t[i]=e.charCodeAt(i);return new TextDecoder().decode(t)}var q={inline:R,size:R,name:wA,width:W,height:W,preserveAspectRatio:R},P=[70,105,108,101],b=1024,DA=class{constructor(){this.state=0,this._buffer=new Uint32Array(b),this._position=0,this._key="",this.fields={}}reset(){this._buffer.fill(0),this.state=0,this._position=0,this.fields={},this._key=""}parse(A,e,t){let i=this.state,s=this._position,r=this._buffer;if(i===1||i===4||i===0&&s>6)return-1;for(let n=e;n<t;++n){let g=A[n];switch(g){case 59:if(!this._storeValue(s))return this._a();i=2,s=0;break;case 61:if(i===0){for(let I=0;I<P.length;++I)if(r[I]!==P[I])return this._a();i=2,s=0}else if(i===2){if(!this._storeKey(s))return this._a();i=3,s=0}else if(i===3){if(s>=b)return this._a();r[s++]=g}break;case 58:return i===3&&!this._storeValue(s)?this._a():(this.state=4,n+1);default:if(s>=b)return this._a();r[s++]=g}}return this.state=i,this._position=s,-2}_a(){return this.state=1,-1}_storeKey(A){let e=J(this._buffer.subarray(0,A));return e?(this._key=e,this.fields[e]=null,!0):!1}_storeValue(A){if(this._key){try{let e=this._buffer.slice(0,A);this.fields[this._key]=q[this._key]?q[this._key](e):e}catch{return!1}return!0}return!1}},H={mime:"unsupported",width:0,height:0};function fA(A){if(A.length<24)return H;let e=new Uint32Array(A.buffer,A.byteOffset,6);if(e[0]===1196314761&&e[1]===169478669&&e[3]===1380206665)return{mime:"image/png",width:A[16]<<24|A[17]<<16|A[18]<<8|A[19],height:A[20]<<24|A[21]<<16|A[22]<<8|A[23]};if(A[0]===255&&A[1]===216&&A[2]===255){let[t,i]=mA(A);return{mime:"image/jpeg",width:t,height:i}}return e[0]===944130375&&(A[4]===55||A[4]===57)&&A[5]===97?{mime:"image/gif",width:A[7]<<8|A[6],height:A[9]<<8|A[8]}:H}function mA(A){let e=A.length,t=4,i=A[t]<<8|A[t+1];for(;;){if(t+=i,t>=e)return[0,0];if(A[t]!==255)return[0,0];if(A[t+1]===192||A[t+1]===194)return t+8<e?[A[t+7]<<8|A[t+8],A[t+5]<<8|A[t+6]]:[0,0];t+=2,i=A[t]<<8|A[t+1]}}var uA=4194304,v={name:"Unnamed file",size:0,width:"auto",height:"auto",preserveAspectRatio:1,inline:0},pA=class{constructor(A,e,t,i){this._opts=A,this._renderer=e,this._storage=t,this._coreTerminal=i,this._aborted=!1,this._hp=new DA,this._header=v,this._dec=new EA.default(uA),this._metrics=H}reset(){}start(){this._aborted=!1,this._header=v,this._metrics=H,this._hp.reset()}put(A,e,t){if(!this._aborted)if(this._hp.state===4)this._dec.put(A,e,t)&&(this._dec.release(),this._aborted=!0);else{let i=this._hp.parse(A,e,t);if(i===-1){this._aborted=!0;return}if(i>0){if(this._header=Object.assign({},v,this._hp.fields),!this._header.inline||!this._header.size||this._header.size>this._opts.iipSizeLimit){this._aborted=!0;return}this._dec.init(this._header.size),this._dec.put(A,i,t)&&(this._dec.release(),this._aborted=!0)}}}end(A){if(this._aborted)return!0;let e=0,t=0,i=!0;if((i=A)&&(i=!this._dec.end())&&(this._metrics=fA(this._dec.data8),(i=this._metrics.mime!=="unsupported")&&(e=this._metrics.width,t=this._metrics.height,(i=e&&t&&e*t<this._opts.pixelLimit)&&([e,t]=this._resize(e,t).map(Math.floor),i=e&&t&&e*t<this._opts.pixelLimit))),!i)return this._dec.release(),!0;let s=new Blob([this._dec.data8],{type:this._metrics.mime});if(this._dec.release(),!window.createImageBitmap){let r=URL.createObjectURL(s),n=new Image;return new Promise(g=>{n.addEventListener("load",()=>{var c;URL.revokeObjectURL(r);let I=S.createCanvas(window.document,e,t);(c=I.getContext("2d"))==null||c.drawImage(n,0,0,e,t),this._storage.addImage(I),g(!0)}),n.src=r,setTimeout(()=>g(!0),1e3)})}return createImageBitmap(s,{resizeWidth:e,resizeHeight:t}).then(r=>(this._storage.addImage(r),!0))}_resize(A,e){var I,c,Q,C;let t=((I=this._renderer.dimensions)==null?void 0:I.css.cell.width)||M.width,i=((c=this._renderer.dimensions)==null?void 0:c.css.cell.height)||M.height,s=((Q=this._renderer.dimensions)==null?void 0:Q.css.canvas.width)||t*this._coreTerminal.cols,r=((C=this._renderer.dimensions)==null?void 0:C.css.canvas.height)||i*this._coreTerminal.rows,n=this._dim(this._header.width,s,t),g=this._dim(this._header.height,r,i);if(!n&&!g){let E=s/A,a=(r-i)/e,h=Math.min(E,a);return h<1?[A*h,e*h]:[A,e]}return n?this._header.preserveAspectRatio||!n||!g?[n,e*n/A]:[n,g]:[A*g/e,g]}_dim(A,e,t){return A==="auto"?0:A.endsWith("%")?parseInt(A.slice(0,-1))*e/100:A.endsWith("px")?parseInt(A.slice(0,-2)):parseInt(A)*t}},y=L(T()),kA=L(nA()),MA=4194304,U=y.PALETTE_ANSI_256;U.set(y.PALETTE_VT340_COLOR);var yA=class{constructor(A,e,t){this._opts=A,this._storage=e,this._coreTerminal=t,this._size=0,this._aborted=!1,(0,kA.DecoderAsync)({memoryLimit:this._opts.pixelLimit*4,palette:U,paletteLimit:this._opts.sixelPaletteLimit}).then(i=>this._dec=i)}reset(){this._dec&&(this._dec.release(),this._dec._palette.fill(0),this._dec.init(0,U,this._opts.sixelPaletteLimit))}hook(A){var e;if(this._size=0,this._aborted=!1,this._dec){let t=A.params[1]===1?0:GA(this._coreTerminal._core._inputHandler._curAttrData,(e=this._coreTerminal._core._themeService)==null?void 0:e.colors);this._dec.init(t,null,this._opts.sixelPaletteLimit)}}put(A,e,t){if(!(this._aborted||!this._dec)){if(this._size+=t-e,this._size>this._opts.sixelSizeLimit){console.warn("SIXEL: too much data, aborting"),this._aborted=!0,this._dec.release();return}try{this._dec.decode(A,e,t)}catch(i){console.warn(`SIXEL: error while decoding image - ${i}`),this._aborted=!0,this._dec.release()}}}unhook(A){var s;if(this._aborted||!A||!this._dec)return!0;let e=this._dec.width,t=this._dec.height;if(!e||!t)return t&&this._storage.advanceCursor(t),!0;let i=S.createCanvas(void 0,e,t);return(s=i.getContext("2d"))==null||s.putImageData(new ImageData(this._dec.data8,e,t),0,0),this._dec.memoryUsage>MA&&this._dec.release(),this._storage.addImage(i),!0}};function GA(A,e){let t=0;if(!e)return t;if(A.isInverse())if(A.isFgDefault())t=N(e.foreground.rgba);else if(A.isFgRGB()){let i=A.constructor.toColorRGB(A.getFgColor());t=(0,y.toRGBA8888)(...i)}else t=N(e.ansi[A.getFgColor()].rgba);else if(A.isBgDefault())t=N(e.background.rgba);else if(A.isBgRGB()){let i=A.constructor.toColorRGB(A.getBgColor());t=(0,y.toRGBA8888)(...i)}else t=N(e.ansi[A.getBgColor()].rgba);return t}function N(A){return y.BIG_ENDIAN?A:(A&255)<<24|(A>>>8&255)<<16|(A>>>16&255)<<8|A>>>24&255}var O={enableSizeReports:!0,pixelLimit:16777216,sixelSupport:!0,sixelScrolling:!0,sixelPaletteLimit:256,sixelSizeLimit:25e6,storageLimit:128,showPlaceholder:!0,iipSupport:!0,iipSizeLimit:2e7},z=4096,NA=class{constructor(A){this._disposables=[],this._handlers=new Map,this._opts=Object.assign({},O,A),this._defaultOpts=Object.assign({},O,A)}dispose(){for(let A of this._disposables)A.dispose();this._disposables.length=0,this._handlers.clear()}_disposeLater(...A){for(let e of A)this._disposables.push(e)}activate(A){if(this._terminal=A,this._renderer=new S(A),this._storage=new _A(A,this._renderer,this._opts),this._opts.enableSizeReports){let e=A.options.windowOptions||{};e.getWinSizePixels=!0,e.getCellSizePixels=!0,e.getWinSizeChars=!0,A.options.windowOptions=e}if(this._disposeLater(this._renderer,this._storage,A.parser.registerCsiHandler({prefix:"?",final:"h"},e=>this._decset(e)),A.parser.registerCsiHandler({prefix:"?",final:"l"},e=>this._decrst(e)),A.parser.registerCsiHandler({final:"c"},e=>this._da1(e)),A.parser.registerCsiHandler({prefix:"?",final:"S"},e=>this._xtermGraphicsAttributes(e)),A.onRender(e=>{var t;return(t=this._storage)==null?void 0:t.render(e)}),A.parser.registerCsiHandler({intermediates:"!",final:"p"},()=>this.reset()),A.parser.registerEscHandler({final:"c"},()=>this.reset()),A._core._inputHandler.onRequestReset(()=>this.reset()),A.buffer.onBufferChange(()=>{var e;return(e=this._storage)==null?void 0:e.wipeAlternate()}),A.onResize(e=>{var t;return(t=this._storage)==null?void 0:t.viewportResize(e)})),this._opts.sixelSupport){let e=new yA(this._opts,this._storage,A);this._handlers.set("sixel",e),this._disposeLater(A._core._inputHandler._parser.registerDcsHandler({final:"q"},e))}if(this._opts.iipSupport){let e=new pA(this._opts,this._renderer,this._storage,A);this._handlers.set("iip",e),this._disposeLater(A._core._inputHandler._parser.registerOscHandler(1337,e))}}reset(){var A;this._opts.sixelScrolling=this._defaultOpts.sixelScrolling,this._opts.sixelPaletteLimit=this._defaultOpts.sixelPaletteLimit,(A=this._storage)==null||A.reset();for(let e of this._handlers.values())e.reset();return!1}get storageLimit(){var A;return((A=this._storage)==null?void 0:A.getLimit())||-1}set storageLimit(A){var e;(e=this._storage)==null||e.setLimit(A),this._opts.storageLimit=A}get storageUsage(){return this._storage?this._storage.getUsage():-1}get showPlaceholder(){return this._opts.showPlaceholder}set showPlaceholder(A){var e;this._opts.showPlaceholder=A,(e=this._renderer)==null||e.showPlaceholder(A)}getImageAtBufferCell(A,e){var t;return(t=this._storage)==null?void 0:t.getImageAtBufferCell(A,e)}extractTileAtBufferCell(A,e){var t;return(t=this._storage)==null?void 0:t.extractTileAtBufferCell(A,e)}_report(A){var e;(e=this._terminal)==null||e._core.coreService.triggerDataEvent(A)}_decset(A){for(let e=0;e<A.length;++e)switch(A[e]){case 80:this._opts.sixelScrolling=!1;break}return!1}_decrst(A){for(let e=0;e<A.length;++e)switch(A[e]){case 80:this._opts.sixelScrolling=!0;break}return!1}_da1(A){return A[0]?!0:this._opts.sixelSupport?(this._report("\x1B[?62;4;9;22c"),!0):!1}_xtermGraphicsAttributes(A){var e,t,i,s,r,n;if(A.length<2)return!0;if(A[0]===1)switch(A[1]){case 1:return this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`),!0;case 2:this._opts.sixelPaletteLimit=this._defaultOpts.sixelPaletteLimit,this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`);for(let g of this._handlers.values())g.reset();return!0;case 3:return A.length>2&&!(A[2]instanceof Array)&&A[2]<=z?(this._opts.sixelPaletteLimit=A[2],this._report(`\x1B[?${A[0]};0;${this._opts.sixelPaletteLimit}S`)):this._report(`\x1B[?${A[0]};2S`),!0;case 4:return this._report(`\x1B[?${A[0]};0;${z}S`),!0;default:return this._report(`\x1B[?${A[0]};2S`),!0}if(A[0]===2)switch(A[1]){case 1:let g=(t=(e=this._renderer)==null?void 0:e.dimensions)==null?void 0:t.css.canvas.width,I=(s=(i=this._renderer)==null?void 0:i.dimensions)==null?void 0:s.css.canvas.height;if(!g||!I){let Q=M;g=(((r=this._terminal)==null?void 0:r.cols)||80)*Q.width,I=(((n=this._terminal)==null?void 0:n.rows)||24)*Q.height}if(g*I<this._opts.pixelLimit)this._report(`\x1B[?${A[0]};0;${g.toFixed(0)};${I.toFixed(0)}S`);else{let Q=Math.floor(Math.sqrt(this._opts.pixelLimit));this._report(`\x1B[?${A[0]};0;${Q};${Q}S`)}return!0;case 4:let c=Math.floor(Math.sqrt(this._opts.pixelLimit));return this._report(`\x1B[?${A[0]};0;${c};${c}S`),!0;default:return this._report(`\x1B[?${A[0]};2S`),!0}return this._report(`\x1B[?${A[0]};1S`),!0}};export{NA as ImageAddon};
