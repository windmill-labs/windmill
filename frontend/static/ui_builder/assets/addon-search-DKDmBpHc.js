/**
 * Copyright (c) 2014-2024 The xterm.js authors. All rights reserved.
 * @license MIT
 *
 * Copyright (c) 2012-2013, Christopher Jeffrey (MIT License)
 * @license MIT
 *
 * Originally forked from (with the author's permission):
 *   Fabrice Bellard's javascript vt100 for jslinux:
 *   http://bellard.org/jslinux/
 *   Copyright (c) 2011 Fabrice Bellard
 */var de=class{constructor(){this.listeners=[],this.unexpectedErrorHandler=function(e){setTimeout(()=>{throw e.stack?Z.isErrorNoTelemetry(e)?new Z(e.message+`

`+e.stack):new Error(e.message+`

`+e.stack):e},0)}}addListener(e){return this.listeners.push(e),()=>{this._removeListener(e)}}emit(e){this.listeners.forEach(t=>{t(e)})}_removeListener(e){this.listeners.splice(this.listeners.indexOf(e),1)}setUnexpectedErrorHandler(e){this.unexpectedErrorHandler=e}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(e){this.unexpectedErrorHandler(e),this.emit(e)}onUnexpectedExternalError(e){this.unexpectedErrorHandler(e)}},fe=new de;function Q(e){_e(e)||fe.onUnexpectedError(e)}var B="Canceled";function _e(e){return e instanceof pe?!0:e instanceof Error&&e.name===B&&e.message===B}var pe=class extends Error{constructor(){super(B),this.name=this.message}},Z=class U extends Error{constructor(t){super(t),this.name="CodeExpectedError"}static fromError(t){if(t instanceof U)return t;let s=new U;return s.message=t.message,s.stack=t.stack,s}static isErrorNoTelemetry(t){return t.name==="CodeExpectedError"}};function ge(e,t){let s=this,i=!1,r;return function(){return i||(i=!0,t||(r=e.apply(s,arguments))),r}}var me;(e=>{function t(n){return n<0}e.isLessThan=t;function s(n){return n<=0}e.isLessThanOrEqual=s;function i(n){return n>0}e.isGreaterThan=i;function r(n){return n===0}e.isNeitherLessOrGreaterThan=r,e.greaterThan=1,e.lessThan=-1,e.neitherLessOrGreaterThan=0})(me||(me={}));var G;(e=>{function t(f){return f&&typeof f=="object"&&typeof f[Symbol.iterator]=="function"}e.is=t;let s=Object.freeze([]);function i(){return s}e.empty=i;function*r(f){yield f}e.single=r;function n(f){return t(f)?f:r(f)}e.wrap=n;function l(f){return f||s}e.from=l;function*d(f){for(let g=f.length-1;g>=0;g--)yield f[g]}e.reverse=d;function m(f){return!f||f[Symbol.iterator]().next().done===!0}e.isEmpty=m;function p(f){return f[Symbol.iterator]().next().value}e.first=p;function S(f,g){let w=0;for(let E of f)if(g(E,w++))return!0;return!1}e.some=S;function D(f,g){for(let w of f)if(g(w))return w}e.find=D;function*k(f,g){for(let w of f)g(w)&&(yield w)}e.filter=k;function*y(f,g){let w=0;for(let E of f)yield g(E,w++)}e.map=y;function*O(f,g){let w=0;for(let E of f)yield*g(E,w++)}e.flatMap=O;function*A(...f){for(let g of f)yield*g}e.concat=A;function C(f,g,w){let E=w;for(let I of f)E=g(E,I);return E}e.reduce=C;function*L(f,g,w=f.length){for(g<0&&(g+=f.length),w<0?w+=f.length:w>f.length&&(w=f.length);g<w;g++)yield f[g]}e.slice=L;function W(f,g=Number.POSITIVE_INFINITY){let w=[];if(g===0)return[w,f];let E=f[Symbol.iterator]();for(let I=0;I<g;I++){let F=E.next();if(F.done)return[w,e.empty()];w.push(F.value)}return[w,{[Symbol.iterator](){return E}}]}e.consume=W;async function z(f){let g=[];for await(let w of f)g.push(w);return Promise.resolve(g)}e.asyncToArray=z})(G||(G={}));function N(e){if(G.is(e)){let t=[];for(let s of e)if(s)try{s.dispose()}catch(i){t.push(i)}if(t.length===1)throw t[0];if(t.length>1)throw new AggregateError(t,"Encountered errors while disposing of store");return Array.isArray(e)?[]:e}else if(e)return e.dispose(),e}function ee(...e){return J(()=>N(e))}function J(e){return{dispose:ge(()=>{e()})}}var te=class ie{constructor(){this._toDispose=new Set,this._isDisposed=!1}dispose(){this._isDisposed||(this._isDisposed=!0,this.clear())}get isDisposed(){return this._isDisposed}clear(){if(this._toDispose.size!==0)try{N(this._toDispose)}finally{this._toDispose.clear()}}add(t){if(!t)return t;if(t===this)throw new Error("Cannot register a disposable on itself!");return this._isDisposed?ie.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(t),t}delete(t){if(t){if(t===this)throw new Error("Cannot dispose a disposable on itself!");this._toDispose.delete(t),t.dispose()}}deleteAndLeak(t){t&&this._toDispose.has(t)&&(this._toDispose.delete(t),void 0)}};te.DISABLE_DISPOSED_WARNING=!1;var V=te,P=class{constructor(){this._store=new V,this._store}dispose(){this._store.dispose()}_register(e){if(e===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(e)}};P.None=Object.freeze({dispose(){}});var X=class{constructor(){this._isDisposed=!1}get value(){return this._isDisposed?void 0:this._value}set value(e){var t;this._isDisposed||e===this._value||((t=this._value)==null||t.dispose(),this._value=e)}clear(){this.value=void 0}dispose(){var e;this._isDisposed=!0,(e=this._value)==null||e.dispose(),this._value=void 0}clearAndLeak(){let e=this._value;return this._value=void 0,e}},ve=globalThis.performance&&typeof globalThis.performance.now=="function",we=class se{static create(t){return new se(t)}constructor(t){this._now=ve&&t===!1?Date.now:globalThis.performance.now.bind(globalThis.performance),this._startTime=this._now(),this._stopTime=-1}stop(){this._stopTime=this._now()}reset(){this._startTime=this._now(),this._stopTime=-1}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}},Le;(e=>{e.None=()=>P.None;function t(u,o){return D(u,()=>{},0,void 0,!0,void 0,o)}e.defer=t;function s(u){return(o,h=null,a)=>{let c=!1,_;return _=u(v=>{if(!c)return _?_.dispose():c=!0,o.call(h,v)},null,a),c&&_.dispose(),_}}e.once=s;function i(u,o,h){return p((a,c=null,_)=>u(v=>a.call(c,o(v)),null,_),h)}e.map=i;function r(u,o,h){return p((a,c=null,_)=>u(v=>{o(v),a.call(c,v)},null,_),h)}e.forEach=r;function n(u,o,h){return p((a,c=null,_)=>u(v=>o(v)&&a.call(c,v),null,_),h)}e.filter=n;function l(u){return u}e.signal=l;function d(...u){return(o,h=null,a)=>{let c=ee(...u.map(_=>_(v=>o.call(h,v))));return S(c,a)}}e.any=d;function m(u,o,h,a){let c=h;return i(u,_=>(c=o(c,_),c),a)}e.reduce=m;function p(u,o){let h,a={onWillAddFirstListener(){h=u(c.fire,c)},onDidRemoveLastListener(){h==null||h.dispose()}},c=new x(a);return o==null||o.add(c),c.event}function S(u,o){return o instanceof Array?o.push(u):o&&o.add(u),u}function D(u,o,h=100,a=!1,c=!1,_,v){let b,T,M,Y=0,R,he={leakWarningThreshold:_,onWillAddFirstListener(){b=u(ue=>{Y++,T=o(T,ue),a&&!M&&($.fire(T),T=void 0),R=()=>{let ce=T;T=void 0,M=void 0,(!a||Y>1)&&$.fire(ce),Y=0},typeof h=="number"?(clearTimeout(M),M=setTimeout(R,h)):M===void 0&&(M=0,queueMicrotask(R))})},onWillRemoveListener(){c&&Y>0&&(R==null||R())},onDidRemoveLastListener(){R=void 0,b.dispose()}},$=new x(he);return v==null||v.add($),$.event}e.debounce=D;function k(u,o=0,h){return e.debounce(u,(a,c)=>a?(a.push(c),a):[c],o,void 0,!0,void 0,h)}e.accumulate=k;function y(u,o=(a,c)=>a===c,h){let a=!0,c;return n(u,_=>{let v=a||!o(_,c);return a=!1,c=_,v},h)}e.latch=y;function O(u,o,h){return[e.filter(u,o,h),e.filter(u,a=>!o(a),h)]}e.split=O;function A(u,o=!1,h=[],a){let c=h.slice(),_=u(T=>{c?c.push(T):b.fire(T)});a&&a.add(_);let v=()=>{c==null||c.forEach(T=>b.fire(T)),c=null},b=new x({onWillAddFirstListener(){_||(_=u(T=>b.fire(T)),a&&a.add(_))},onDidAddFirstListener(){c&&(o?setTimeout(v):v())},onDidRemoveLastListener(){_&&_.dispose(),_=null}});return a&&a.add(b),b.event}e.buffer=A;function C(u,o){return(h,a,c)=>{let _=o(new W);return u(function(v){let b=_.evaluate(v);b!==L&&h.call(a,b)},void 0,c)}}e.chain=C;let L=Symbol("HaltChainable");class W{constructor(){this.steps=[]}map(o){return this.steps.push(o),this}forEach(o){return this.steps.push(h=>(o(h),h)),this}filter(o){return this.steps.push(h=>o(h)?h:L),this}reduce(o,h){let a=h;return this.steps.push(c=>(a=o(a,c),a)),this}latch(o=(h,a)=>h===a){let h=!0,a;return this.steps.push(c=>{let _=h||!o(c,a);return h=!1,a=c,_?c:L}),this}evaluate(o){for(let h of this.steps)if(o=h(o),o===L)break;return o}}function z(u,o,h=a=>a){let a=(...b)=>v.fire(h(...b)),c=()=>u.on(o,a),_=()=>u.removeListener(o,a),v=new x({onWillAddFirstListener:c,onDidRemoveLastListener:_});return v.event}e.fromNodeEventEmitter=z;function f(u,o,h=a=>a){let a=(...b)=>v.fire(h(...b)),c=()=>u.addEventListener(o,a),_=()=>u.removeEventListener(o,a),v=new x({onWillAddFirstListener:c,onDidRemoveLastListener:_});return v.event}e.fromDOMEventEmitter=f;function g(u){return new Promise(o=>s(u)(o))}e.toPromise=g;function w(u){let o=new x;return u.then(h=>{o.fire(h)},()=>{o.fire(void 0)}).finally(()=>{o.dispose()}),o.event}e.fromPromise=w;function E(u,o){return u(h=>o.fire(h))}e.forward=E;function I(u,o,h){return o(h),u(a=>o(a))}e.runAndSubscribe=I;class F{constructor(o,h){this._observable=o,this._counter=0,this._hasChanged=!1;let a={onWillAddFirstListener:()=>{o.addObserver(this)},onDidRemoveLastListener:()=>{o.removeObserver(this)}};this.emitter=new x(a),h&&h.add(this.emitter)}beginUpdate(o){this._counter++}handlePossibleChange(o){}handleChange(o,h){this._hasChanged=!0}endUpdate(o){this._counter--,this._counter===0&&(this._observable.reportChanges(),this._hasChanged&&(this._hasChanged=!1,this.emitter.fire(this._observable.get())))}}function le(u,o){return new F(u,o).emitter.event}e.fromObservable=le;function ae(u){return(o,h,a)=>{let c=0,_=!1,v={beginUpdate(){c++},endUpdate(){c--,c===0&&(u.reportChanges(),_&&(_=!1,o.call(h)))},handlePossibleChange(){},handleChange(){_=!0}};u.addObserver(v),u.reportChanges();let b={dispose(){u.removeObserver(v)}};return a instanceof V?a.add(b):Array.isArray(a)&&a.push(b),b}}e.fromObservableLight=ae})(Le||(Le={}));var q=class K{constructor(t){this.listenerCount=0,this.invocationCount=0,this.elapsedOverall=0,this.durations=[],this.name=`${t}_${K._idPool++}`,K.all.add(this)}start(t){this._stopWatch=new we,this.listenerCount=t}stop(){if(this._stopWatch){let t=this._stopWatch.elapsed();this.durations.push(t),this.elapsedOverall+=t,this.invocationCount+=1,this._stopWatch=void 0}}};q.all=new Set,q._idPool=0;var be=q,Ce=-1,re=class ne{constructor(t,s,i=(ne._idPool++).toString(16).padStart(3,"0")){this._errorHandler=t,this.threshold=s,this.name=i,this._warnCountdown=0}dispose(){var t;(t=this._stacks)==null||t.clear()}check(t,s){let i=this.threshold;if(i<=0||s<i)return;this._stacks||(this._stacks=new Map);let r=this._stacks.get(t.value)||0;if(this._stacks.set(t.value,r+1),this._warnCountdown-=1,this._warnCountdown<=0){this._warnCountdown=i*.5;let[n,l]=this.getMostFrequentStack(),d=`[${this.name}] potential listener LEAK detected, having ${s} listeners already. MOST frequent listener (${l}):`;console.warn(d),console.warn(n);let m=new De(d,n);this._errorHandler(m)}return()=>{let n=this._stacks.get(t.value)||0;this._stacks.set(t.value,n-1)}}getMostFrequentStack(){if(!this._stacks)return;let t,s=0;for(let[i,r]of this._stacks)(!t||s<r)&&(t=[i,r],s=r);return t}};re._idPool=1;var Se=re,ye=class oe{constructor(t){this.value=t}static create(){let t=new Error;return new oe(t.stack??"")}print(){console.warn(this.value.split(`
`).slice(2).join(`
`))}},De=class extends Error{constructor(e,t){super(e),this.name="ListenerLeakError",this.stack=t}},Ee=class extends Error{constructor(e,t){super(e),this.name="ListenerRefusalError",this.stack=t}},ke=0,H=class{constructor(e){this.value=e,this.id=ke++}},Te=2,xe,x=class{constructor(e){var t,s,i,r;this._size=0,this._options=e,this._leakageMon=(t=this._options)!=null&&t.leakWarningThreshold?new Se((e==null?void 0:e.onListenerError)??Q,((s=this._options)==null?void 0:s.leakWarningThreshold)??Ce):void 0,this._perfMon=(i=this._options)!=null&&i._profName?new be(this._options._profName):void 0,this._deliveryQueue=(r=this._options)==null?void 0:r.deliveryQueue}dispose(){var e,t,s,i;this._disposed||(this._disposed=!0,((e=this._deliveryQueue)==null?void 0:e.current)===this&&this._deliveryQueue.reset(),this._listeners&&(this._listeners=void 0,this._size=0),(s=(t=this._options)==null?void 0:t.onDidRemoveLastListener)==null||s.call(t),(i=this._leakageMon)==null||i.dispose())}get event(){return this._event??(this._event=(e,t,s)=>{var l,d,m,p,S;if(this._leakageMon&&this._size>this._leakageMon.threshold**2){let D=`[${this._leakageMon.name}] REFUSES to accept new listeners because it exceeded its threshold by far (${this._size} vs ${this._leakageMon.threshold})`;console.warn(D);let k=this._leakageMon.getMostFrequentStack()??["UNKNOWN stack",-1],y=new Ee(`${D}. HINT: Stack shows most frequent listener (${k[1]}-times)`,k[0]);return(((l=this._options)==null?void 0:l.onListenerError)||Q)(y),P.None}if(this._disposed)return P.None;t&&(e=e.bind(t));let i=new H(e),r;this._leakageMon&&this._size>=Math.ceil(this._leakageMon.threshold*.2)&&(i.stack=ye.create(),r=this._leakageMon.check(i.stack,this._size+1)),this._listeners?this._listeners instanceof H?(this._deliveryQueue??(this._deliveryQueue=new Re),this._listeners=[this._listeners,i]):this._listeners.push(i):((m=(d=this._options)==null?void 0:d.onWillAddFirstListener)==null||m.call(d,this),this._listeners=i,(S=(p=this._options)==null?void 0:p.onDidAddFirstListener)==null||S.call(p,this)),this._size++;let n=J(()=>{r==null||r(),this._removeListener(i)});return s instanceof V?s.add(n):Array.isArray(s)&&s.push(n),n}),this._event}_removeListener(e){var r,n,l,d;if((n=(r=this._options)==null?void 0:r.onWillRemoveListener)==null||n.call(r,this),!this._listeners)return;if(this._size===1){this._listeners=void 0,(d=(l=this._options)==null?void 0:l.onDidRemoveLastListener)==null||d.call(l,this),this._size=0;return}let t=this._listeners,s=t.indexOf(e);if(s===-1)throw console.log("disposed?",this._disposed),console.log("size?",this._size),console.log("arr?",JSON.stringify(this._listeners)),new Error("Attempted to dispose unknown listener");this._size--,t[s]=void 0;let i=this._deliveryQueue.current===this;if(this._size*Te<=t.length){let m=0;for(let p=0;p<t.length;p++)t[p]?t[m++]=t[p]:i&&(this._deliveryQueue.end--,m<this._deliveryQueue.i&&this._deliveryQueue.i--);t.length=m}}_deliver(e,t){var i;if(!e)return;let s=((i=this._options)==null?void 0:i.onListenerError)||Q;if(!s){e.value(t);return}try{e.value(t)}catch(r){s(r)}}_deliverQueue(e){let t=e.current._listeners;for(;e.i<e.end;)this._deliver(t[e.i++],e.value);e.reset()}fire(e){var t,s,i,r;if((t=this._deliveryQueue)!=null&&t.current&&(this._deliverQueue(this._deliveryQueue),(s=this._perfMon)==null||s.stop()),(i=this._perfMon)==null||i.start(this._size),this._listeners)if(this._listeners instanceof H)this._deliver(this._listeners,e);else{let n=this._deliveryQueue;n.enqueue(this,e,this._listeners.length),this._deliverQueue(n)}(r=this._perfMon)==null||r.stop()}hasListeners(){return this._size>0}},Re=class{constructor(){this.i=-1,this.end=0}enqueue(e,t,s){this.i=0,this.end=s,this.current=e,this.value=t}reset(){this.i=this.end,this.current=void 0,this.value=void 0}},j=" ~!@#$%^&*()+`-=[]{}|\\;:\"',./<>?",Oe=15*1e3,Ae=1e3,Ie=class extends P{constructor(e){super(),this._highlightedLines=new Set,this._highlightDecorations=[],this._selectedDecoration=this._register(new X),this._linesCacheTimeoutId=0,this._linesCacheDisposables=new X,this._onDidChangeResults=this._register(new x),this.onDidChangeResults=this._onDidChangeResults.event,this._highlightLimit=(e==null?void 0:e.highlightLimit)??Ae}activate(e){this._terminal=e,this._register(this._terminal.onWriteParsed(()=>this._updateMatches())),this._register(this._terminal.onResize(()=>this._updateMatches())),this._register(J(()=>this.clearDecorations()))}_updateMatches(){var e;this._highlightTimeout&&window.clearTimeout(this._highlightTimeout),this._cachedSearchTerm&&((e=this._lastSearchOptions)!=null&&e.decorations)&&(this._highlightTimeout=setTimeout(()=>{let t=this._cachedSearchTerm;this._cachedSearchTerm=void 0,this.findPrevious(t,{...this._lastSearchOptions,incremental:!0,noScroll:!0})},200))}clearDecorations(e){this._selectedDecoration.clear(),N(this._highlightDecorations),this._highlightDecorations=[],this._highlightedLines.clear(),e||(this._cachedSearchTerm=void 0)}clearActiveDecoration(){this._selectedDecoration.clear()}findNext(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");let s=this._lastSearchOptions?this._didOptionsChange(this._lastSearchOptions,t):!0;this._lastSearchOptions=t,t!=null&&t.decorations&&(this._cachedSearchTerm===void 0||e!==this._cachedSearchTerm||s)&&this._highlightAllMatches(e,t);let i=this._findNextAndSelect(e,t);return this._fireResults(t),this._cachedSearchTerm=e,i}_highlightAllMatches(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(!e||e.length===0){this.clearDecorations();return}t=t||{},this.clearDecorations(!0);let s=[],i,r=this._find(e,0,0,t);for(;r&&((i==null?void 0:i.row)!==r.row||(i==null?void 0:i.col)!==r.col)&&!(s.length>=this._highlightLimit);)i=r,s.push(i),r=this._find(e,i.col+i.term.length>=this._terminal.cols?i.row+1:i.row,i.col+i.term.length>=this._terminal.cols?0:i.col+1,t);for(let n of s){let l=this._createResultDecoration(n,t.decorations);l&&(this._highlightedLines.add(l.marker.line),this._highlightDecorations.push({decoration:l,match:n,dispose(){l.dispose()}}))}}_find(e,t,s,i){var l;if(!this._terminal||!e||e.length===0){(l=this._terminal)==null||l.clearSelection(),this.clearDecorations();return}if(s>this._terminal.cols)throw new Error(`Invalid col: ${s} to search in terminal of ${this._terminal.cols} cols`);let r;this._initLinesCache();let n={startRow:t,startCol:s};if(r=this._findInLine(e,n,i),!r)for(let d=t+1;d<this._terminal.buffer.active.baseY+this._terminal.rows&&(n.startRow=d,n.startCol=0,r=this._findInLine(e,n,i),!r);d++);return r}_findNextAndSelect(e,t){var d;if(!this._terminal||!e||e.length===0)return(d=this._terminal)==null||d.clearSelection(),this.clearDecorations(),!1;let s=this._terminal.getSelectionPosition();this._terminal.clearSelection();let i=0,r=0;s&&(this._cachedSearchTerm===e?(i=s.end.x,r=s.end.y):(i=s.start.x,r=s.start.y)),this._initLinesCache();let n={startRow:r,startCol:i},l=this._findInLine(e,n,t);if(!l)for(let m=r+1;m<this._terminal.buffer.active.baseY+this._terminal.rows&&(n.startRow=m,n.startCol=0,l=this._findInLine(e,n,t),!l);m++);if(!l&&r!==0)for(let m=0;m<r&&(n.startRow=m,n.startCol=0,l=this._findInLine(e,n,t),!l);m++);return!l&&s&&(n.startRow=s.start.y,n.startCol=0,l=this._findInLine(e,n,t)),this._selectResult(l,t==null?void 0:t.decorations,t==null?void 0:t.noScroll)}findPrevious(e,t){if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");let s=this._lastSearchOptions?this._didOptionsChange(this._lastSearchOptions,t):!0;this._lastSearchOptions=t,t!=null&&t.decorations&&(this._cachedSearchTerm===void 0||e!==this._cachedSearchTerm||s)&&this._highlightAllMatches(e,t);let i=this._findPreviousAndSelect(e,t);return this._fireResults(t),this._cachedSearchTerm=e,i}_didOptionsChange(e,t){return t?e.caseSensitive!==t.caseSensitive||e.regex!==t.regex||e.wholeWord!==t.wholeWord:!1}_fireResults(e){if(e!=null&&e.decorations){let t=-1;if(this._selectedDecoration.value){let s=this._selectedDecoration.value.match;for(let i=0;i<this._highlightDecorations.length;i++){let r=this._highlightDecorations[i].match;if(r.row===s.row&&r.col===s.col&&r.size===s.size){t=i;break}}}this._onDidChangeResults.fire({resultIndex:t,resultCount:this._highlightDecorations.length})}}_findPreviousAndSelect(e,t){var m;if(!this._terminal)throw new Error("Cannot use addon until it has been loaded");if(!this._terminal||!e||e.length===0)return(m=this._terminal)==null||m.clearSelection(),this.clearDecorations(),!1;let s=this._terminal.getSelectionPosition();this._terminal.clearSelection();let i=this._terminal.buffer.active.baseY+this._terminal.rows-1,r=this._terminal.cols,n=!0;this._initLinesCache();let l={startRow:i,startCol:r},d;if(s&&(l.startRow=i=s.start.y,l.startCol=r=s.start.x,this._cachedSearchTerm!==e&&(d=this._findInLine(e,l,t,!1),d||(l.startRow=i=s.end.y,l.startCol=r=s.end.x))),d||(d=this._findInLine(e,l,t,n)),!d){l.startCol=Math.max(l.startCol,this._terminal.cols);for(let p=i-1;p>=0&&(l.startRow=p,d=this._findInLine(e,l,t,n),!d);p--);}if(!d&&i!==this._terminal.buffer.active.baseY+this._terminal.rows-1)for(let p=this._terminal.buffer.active.baseY+this._terminal.rows-1;p>=i&&(l.startRow=p,d=this._findInLine(e,l,t,n),!d);p--);return this._selectResult(d,t==null?void 0:t.decorations,t==null?void 0:t.noScroll)}_initLinesCache(){let e=this._terminal;this._linesCache||(this._linesCache=new Array(e.buffer.active.length),this._linesCacheDisposables.value=ee(e.onLineFeed(()=>this._destroyLinesCache()),e.onCursorMove(()=>this._destroyLinesCache()),e.onResize(()=>this._destroyLinesCache()))),window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=window.setTimeout(()=>this._destroyLinesCache(),Oe)}_destroyLinesCache(){this._linesCache=void 0,this._linesCacheDisposables.clear(),this._linesCacheTimeoutId&&(window.clearTimeout(this._linesCacheTimeoutId),this._linesCacheTimeoutId=0)}_isWholeWord(e,t,s){return(e===0||j.includes(t[e-1]))&&(e+s.length===t.length||j.includes(t[e+s.length]))}_findInLine(e,t,s={},i=!1){var O,A;let r=this._terminal,n=t.startRow,l=t.startCol;if((O=r.buffer.active.getLine(n))!=null&&O.isWrapped){if(i){t.startCol+=r.cols;return}return t.startRow--,t.startCol+=r.cols,this._findInLine(e,t,s)}let d=(A=this._linesCache)==null?void 0:A[n];d||(d=this._translateBufferLineToStringWithWrap(n,!0),this._linesCache&&(this._linesCache[n]=d));let[m,p]=d,S=this._bufferColsToStringOffset(n,l),D=e,k=m;s.regex||(D=s.caseSensitive?e:e.toLowerCase(),k=s.caseSensitive?m:m.toLowerCase());let y=-1;if(s.regex){let C=RegExp(D,s.caseSensitive?"g":"gi"),L;if(i)for(;L=C.exec(k.slice(0,S));)y=C.lastIndex-L[0].length,e=L[0],C.lastIndex-=e.length-1;else L=C.exec(k.slice(S)),L&&L[0].length>0&&(y=S+(C.lastIndex-L[0].length),e=L[0])}else i?S-D.length>=0&&(y=k.lastIndexOf(D,S-D.length)):y=k.indexOf(D,S);if(y>=0){if(s.wholeWord&&!this._isWholeWord(y,k,e))return;let C=0;for(;C<p.length-1&&y>=p[C+1];)C++;let L=C;for(;L<p.length-1&&y+e.length>=p[L+1];)L++;let W=y-p[C],z=y+e.length-p[L],f=this._stringLengthToBufferSize(n+C,W),g=this._stringLengthToBufferSize(n+L,z)-f+r.cols*(L-C);return{term:e,col:f,row:n+C,size:g}}}_stringLengthToBufferSize(e,t){let s=this._terminal.buffer.active.getLine(e);if(!s)return 0;for(let i=0;i<t;i++){let r=s.getCell(i);if(!r)break;let n=r.getChars();n.length>1&&(t-=n.length-1);let l=s.getCell(i+1);l&&l.getWidth()===0&&t++}return t}_bufferColsToStringOffset(e,t){let s=this._terminal,i=e,r=0,n=s.buffer.active.getLine(i);for(;t>0&&n;){for(let l=0;l<t&&l<s.cols;l++){let d=n.getCell(l);if(!d)break;d.getWidth()&&(r+=d.getCode()===0?1:d.getChars().length)}if(i++,n=s.buffer.active.getLine(i),n&&!n.isWrapped)break;t-=s.cols}return r}_translateBufferLineToStringWithWrap(e,t){var l;let s=this._terminal,i=[],r=[0],n=s.buffer.active.getLine(e);for(;n;){let d=s.buffer.active.getLine(e+1),m=d?d.isWrapped:!1,p=n.translateToString(!m&&t);if(m&&d){let S=n.getCell(n.length-1);S&&S.getCode()===0&&S.getWidth()===1&&((l=d.getCell(0))==null?void 0:l.getWidth())===2&&(p=p.slice(0,-1))}if(i.push(p),m)r.push(r[r.length-1]+p.length);else break;e++,n=d}return[i.join(""),r]}_selectResult(e,t,s){let i=this._terminal;if(this._selectedDecoration.clear(),!e)return i.clearSelection(),!1;if(i.select(e.col,e.row,e.size),t){let r=i.registerMarker(-i.buffer.active.baseY-i.buffer.active.cursorY+e.row);if(r){let n=i.registerDecoration({marker:r,x:e.col,width:e.size,backgroundColor:t.activeMatchBackground,layer:"top",overviewRulerOptions:{color:t.activeMatchColorOverviewRuler}});if(n){let l=[];l.push(r),l.push(n.onRender(d=>this._applyStyles(d,t.activeMatchBorder,!0))),l.push(n.onDispose(()=>N(l))),this._selectedDecoration.value={decoration:n,match:e,dispose(){n.dispose()}}}}}if(!s&&(e.row>=i.buffer.active.viewportY+i.rows||e.row<i.buffer.active.viewportY)){let r=e.row-i.buffer.active.viewportY;r-=Math.floor(i.rows/2),i.scrollLines(r)}return!0}_applyStyles(e,t,s){e.classList.contains("xterm-find-result-decoration")||(e.classList.add("xterm-find-result-decoration"),t&&(e.style.outline=`1px solid ${t}`)),s&&e.classList.add("xterm-find-active-result-decoration")}_createResultDecoration(e,t){let s=this._terminal,i=s.registerMarker(-s.buffer.active.baseY-s.buffer.active.cursorY+e.row);if(!i)return;let r=s.registerDecoration({marker:i,x:e.col,width:e.size,backgroundColor:t.matchBackground,overviewRulerOptions:this._highlightedLines.has(i.line)?void 0:{color:t.matchOverviewRuler,position:"center"}});if(r){let n=[];n.push(i),n.push(r.onRender(l=>this._applyStyles(l,t.matchBorder,!1))),n.push(r.onDispose(()=>N(n)))}return r}};export{Ie as SearchAddon};
